"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[7600],{2823:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>d,contentTitle:()=>o,default:()=>a,frontMatter:()=>c,metadata:()=>n,toc:()=>m});const n=JSON.parse('{"id":"component/middleware/metrics","title":"\u76d1\u63a7","description":"Metrics \u4e2d\u95f4\u4ef6\u7528\u4e8e\u5b9e\u73b0\u670d\u52a1\u7684\u6027\u80fd\u6307\u6807\u76d1\u63a7\uff0c\u7edf\u8ba1\u4e86\u8bf7\u6c42\u8017\u65f6\u548c\u8bf7\u6c42\u8ba1\u6570\u3002","source":"@site/docs/component/middleware/05-metrics.md","sourceDirName":"component/middleware","slug":"/component/middleware/metrics","permalink":"/docs/component/middleware/metrics","draft":false,"unlisted":false,"editUrl":"https://github.com/go-kratos/go-kratos.dev/edit/main/docs/component/middleware/05-metrics.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"id":"metrics","title":"\u76d1\u63a7","keywords":["Go","Kratos","Toolkit","Framework","Microservices","Protobuf","gRPC","HTTP"]},"sidebar":"docs","previous":{"title":"\u65e5\u5fd7","permalink":"/docs/component/middleware/logging"},"next":{"title":"\u9650\u6d41\u5668","permalink":"/docs/component/middleware/ratelimit"}}');var s=r(4848),i=r(8453);const c={id:"metrics",title:"\u76d1\u63a7",keywords:["Go","Kratos","Toolkit","Framework","Microservices","Protobuf","gRPC","HTTP"]},o=void 0,d={},m=[{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:3},{value:"<code>WithSeconds()</code>",id:"withseconds",level:4},{value:"<code>WithRequests()</code>",id:"withrequests",level:4},{value:"\u4f7f\u7528\u65b9\u5f0f (kratos &lt; 2.8.0)",id:"\u4f7f\u7528\u65b9\u5f0f-kratos--280",level:3},{value:"\u4f7f\u7528 prometheus",id:"\u4f7f\u7528-prometheus",level:4},{value:"Server \u4e2d\u4f7f\u7528 metrics",id:"server-\u4e2d\u4f7f\u7528-metrics",level:4},{value:"Client \u4e2d\u4f7f\u7528 metrics",id:"client-\u4e2d\u4f7f\u7528-metrics",level:4},{value:"\u4f7f\u7528\u65b9\u5f0f (kratos &gt;= 2.8.0)",id:"\u4f7f\u7528\u65b9\u5f0f-kratos--280-1",level:3},{value:"\u4f7f\u7528 prometheus",id:"\u4f7f\u7528-prometheus-1",level:4},{value:"Server \u4e2d\u4f7f\u7528 metrics",id:"server-\u4e2d\u4f7f\u7528-metrics-1",level:4},{value:"Client \u4e2d\u4f7f\u7528 metrics",id:"client-\u4e2d\u4f7f\u7528-metrics-1",level:4},{value:"References",id:"references",level:3}];function l(e){const t={a:"a",code:"code",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:"Metrics \u4e2d\u95f4\u4ef6\u7528\u4e8e\u5b9e\u73b0\u670d\u52a1\u7684\u6027\u80fd\u6307\u6807\u76d1\u63a7\uff0c\u7edf\u8ba1\u4e86\u8bf7\u6c42\u8017\u65f6\u548c\u8bf7\u6c42\u8ba1\u6570\u3002"}),"\n",(0,s.jsx)(t.h3,{id:"\u914d\u7f6e",children:"\u914d\u7f6e"}),"\n",(0,s.jsxs)(t.p,{children:["Metrics \u4e2d\u95f4\u4ef6\u4e2d\u63d0\u4f9b\u4e86\u4e24\u4e2a\u914d\u7f6e\u65b9\u6cd5 ",(0,s.jsx)(t.code,{children:"WithSeconds()"})," \u548c ",(0,s.jsx)(t.code,{children:"WithRequests()"}),"\u3002"]}),"\n",(0,s.jsx)(t.h4,{id:"withseconds",children:(0,s.jsx)(t.code,{children:"WithSeconds()"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"func WithSeconds(c metrics.Observer) Option {\n\treturn func(o *options) {\n\t\to.seconds = c\n\t}\n}\n"})}),"\n",(0,s.jsxs)(t.p,{children:["\u7528\u4e8e\u8bbe\u7f6e metrics \u4e2d\u95f4\u4ef6\u7edf\u8ba1\u8bf7\u6c42\u8017\u65f6\u7684 ",(0,s.jsx)(t.code,{children:"Observer"})," \u76f4\u65b9\u56fe\u3002"]}),"\n",(0,s.jsx)(t.h4,{id:"withrequests",children:(0,s.jsx)(t.code,{children:"WithRequests()"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"func WithRequests(c metrics.Counter) Option {\n\treturn func(o *options) {\n\t\to.requests = c\n\t}\n}\n"})}),"\n",(0,s.jsxs)(t.p,{children:["\u7528\u4e8e\u8bbe\u7f6e metrics \u4e2d\u95f4\u4ef6\u7edf\u8ba1\u8bf7\u6c42\u8ba1\u6570\u7684 ",(0,s.jsx)(t.code,{children:"Counter"})," \u8ba1\u6570\u5668\u3002"]}),"\n",(0,s.jsx)(t.h3,{id:"\u4f7f\u7528\u65b9\u5f0f-kratos--280",children:"\u4f7f\u7528\u65b9\u5f0f (kratos < 2.8.0)"}),"\n",(0,s.jsx)(t.h4,{id:"\u4f7f\u7528-prometheus",children:"\u4f7f\u7528 prometheus"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'// \u8be6\u89c1 https://github.com/go-kratos/examples/tree/main/metrics\n\n_metricSeconds = prometheus.NewHistogramVec(prometheus.HistogramOpts{\n\tNamespace: "server",\n\tSubsystem: "requests",\n\tName:      "duration_sec",\n\tHelp:      "server requests duratio(sec).",\n\tBuckets:   []float64{0.005, 0.01, 0.025, 0.05, 0.1, 0.250, 0.5, 1},\n}, []string{"kind", "operation"})\n\n_metricRequests = prometheus.NewCounterVec(prometheus.CounterOpts{\n\tNamespace: "client",\n\tSubsystem: "requests",\n\tName:      "code_total",\n\tHelp:      "The total number of processed requests",\n}, []string{"kind", "operation", "code", "reason"})\n\t\nprometheus.MustRegister(_metricSeconds, _metricRequests)\n'})}),"\n",(0,s.jsx)(t.h4,{id:"server-\u4e2d\u4f7f\u7528-metrics",children:"Server \u4e2d\u4f7f\u7528 metrics"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'import (\n\tprom "github.com/go-kratos/kratos/contrib/metrics/prometheus/v2"\n)\n\n// grpc service\ngrpcSrv := grpc.NewServer(\n\tgrpc.Address(":9000"),\n\tgrpc.Middleware(\n\t\tmetrics.Server(\n\t\t\tmetrics.WithSeconds(prom.NewHistogram(_metricSeconds)),\n\t\t\tmetrics.WithRequests(prom.NewCounter(_metricRequests)),\n\t\t),\n\t),\n)\n\n// http service\nhttpSrv := http.NewServer(\n\thttp.Address(":8000"),\n\thttp.Middleware(\n\t\tmetrics.Server(\n\t\t\tmetrics.WithSeconds(prom.NewHistogram(_metricSeconds)),\n\t\t\tmetrics.WithRequests(prom.NewCounter(_metricRequests)),\n\t\t),\n\t),\n)\nhttpSrv.Handle("/metrics", promhttp.Handler())\n'})}),"\n",(0,s.jsx)(t.h4,{id:"client-\u4e2d\u4f7f\u7528-metrics",children:"Client \u4e2d\u4f7f\u7528 metrics"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'// grpc client\nconn, err := grpc.DialInsecure(\n\tcontext.Background(),\n\tgrpc.WithEndpoint("127.0.0.1:9000"),\n\tgrpc.WithMiddleware(\n\t\tmetrics.Client(\n\t\t\tmetrics.WithSeconds(prom.NewHistogram(_metricSeconds)),\n\t\t\tmetrics.WithRequests(prom.NewCounter(_metricRequests)),\n\t\t),\n\t),\n)\n\n// http client\nconn, err := http.NewClient(\n\tcontext.Background(),\n\thttp.WithEndpoint("127.0.0.1:8000"),\n\thttp.WithMiddleware(\n\t\tmetrics.Client(\n\t\t\tmetrics.WithSeconds(prom.NewHistogram(_metricSeconds)),\n\t\t\tmetrics.WithRequests(prom.NewCounter(_metricRequests)),\n\t\t),\n\t),\n)\n'})}),"\n",(0,s.jsx)(t.h3,{id:"\u4f7f\u7528\u65b9\u5f0f-kratos--280-1",children:"\u4f7f\u7528\u65b9\u5f0f (kratos >= 2.8.0)"}),"\n",(0,s.jsxs)(t.p,{children:["kratos \u4ece ",(0,s.jsx)(t.a,{href:"https://github.com/go-kratos/kratos/releases/tag/v2.8.0",children:"v2.8.0"})," \u5f00\u59cb\u4f7f\u7528 otel.Metrics\uff0c\u9700\u8981\u7528\u4ee5\u4e0b\u65b9\u6cd5 export \u6570\u636e\u5230 prometheus\u3002"]}),"\n",(0,s.jsx)(t.h4,{id:"\u4f7f\u7528-prometheus-1",children:"\u4f7f\u7528 prometheus"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'import (\n\t"github.com/go-kratos/kratos/v2/middleware/metrics"\n\t"go.opentelemetry.io/otel/exporters/prometheus"\n\t"go.opentelemetry.io/otel/metric"\n\tsdkmetric "go.opentelemetry.io/otel/sdk/metric"\n)\n\n// Detailed reference https://github.com/go-kratos/examples/tree/main/metrics\nfunc init() {\n\texporter, err := prometheus.New()\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tprovider := sdkmetric.NewMeterProvider(sdkmetric.WithReader(exporter))\n\tmeter := provider.Meter(Name)\n\n\t_metricRequests, err = metrics.DefaultRequestsCounter(meter, metrics.DefaultServerRequestsCounterName)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\n\t_metricSeconds, err = metrics.DefaultSecondsHistogram(meter, metrics.DefaultServerSecondsHistogramName)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n}\n'})}),"\n",(0,s.jsx)(t.h4,{id:"server-\u4e2d\u4f7f\u7528-metrics-1",children:"Server \u4e2d\u4f7f\u7528 metrics"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'import (\n\t"github.com/prometheus/client_golang/prometheus/promhttp"\n)\n\n// grpc service\ngrpcSrv := grpc.NewServer(\n\tgrpc.Address(":9000"),\n\tgrpc.Middleware(\n\t\tmetrics.Server(\n\t\t\tmetrics.WithSeconds(_metricSeconds),\n\t\t\tmetrics.WithRequests(_metricRequests),\n\t\t),\n\t),\n)\n\n// http service\nhttpSrv := http.NewServer(\n\thttp.Address(":8000"),\n\thttp.Middleware(\n\t\tmetrics.Server(\n\t\t\tmetrics.WithSeconds(_metricSeconds),\n\t\t\tmetrics.WithRequests(_metricRequests),\n\t\t),\n\t),\n)\nhttpSrv.Handle("/metrics", promhttp.Handler())\n'})}),"\n",(0,s.jsx)(t.h4,{id:"client-\u4e2d\u4f7f\u7528-metrics-1",children:"Client \u4e2d\u4f7f\u7528 metrics"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'// grpc client\nconn, err := grpc.DialInsecure(\n\tcontext.Background(),\n\tgrpc.WithEndpoint("127.0.0.1:9000"),\n\tgrpc.WithMiddleware(\n\t\tmetrics.Client(\n\t\t\tmetrics.WithSeconds(_metricSeconds),\n\t\t\tmetrics.WithRequests(_metricRequests),\n\t\t),\n\t),\n)\n\n// http client\nconn, err := http.NewClient(\n\tcontext.Background(),\n\thttp.WithEndpoint("127.0.0.1:8000"),\n\thttp.WithMiddleware(\n\t\tmetrics.Client(\n\t\t\tmetrics.WithSeconds(_metricSeconds),\n\t\t\tmetrics.WithRequests(_metricRequests),\n\t\t),\n\t),\n)\n'})}),"\n",(0,s.jsx)(t.h3,{id:"references",children:"References"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://prometheus.io/docs/concepts/metric_types/",children:"https://prometheus.io/docs/concepts/metric_types/"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://github.com/go-kratos/examples/tree/main/metrics",children:"https://github.com/go-kratos/examples/tree/main/metrics"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://pkg.go.dev/go.opentelemetry.io/otel/exporters/prometheus",children:"https://pkg.go.dev/go.opentelemetry.io/otel/exporters/prometheus"})}),"\n"]})]})}function a(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453:(e,t,r)=>{r.d(t,{R:()=>c,x:()=>o});var n=r(6540);const s={},i=n.createContext(s);function c(e){const t=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);