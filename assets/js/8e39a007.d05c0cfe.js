"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3510],{2323:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>c,contentTitle:()=>d,default:()=>p,frontMatter:()=>s,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"component/transport/http","title":"HTTP","description":"transporter/http \u4e2d\u57fa\u4e8e gorilla/mux HTTP\u8def\u7531\u6846\u67b6\u5b9e\u73b0\u4e86Transporter\uff0c\u7528\u4ee5\u6ce8\u518c http \u5230 kratos.Server() \u4e2d\u3002","source":"@site/docs/component/transport/02-http.md","sourceDirName":"component/transport","slug":"/component/transport/http","permalink":"/docs/component/transport/http","draft":false,"unlisted":false,"editUrl":"https://github.com/go-kratos/go-kratos.dev/edit/main/docs/component/transport/02-http.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"id":"http","title":"HTTP","keywords":["Go","Kratos","Toolkit","Framework","Microservices","Protobuf","gRPC","HTTP"]},"sidebar":"docs","previous":{"title":"\u6982\u89c8","permalink":"/docs/component/transport/overview"},"next":{"title":"gRPC","permalink":"/docs/component/transport/grpc"}}');var o=n(4848),i=n(8453);const s={id:"http",title:"HTTP",keywords:["Go","Kratos","Toolkit","Framework","Microservices","Protobuf","gRPC","HTTP"]},d=void 0,c={},l=[{value:"Server",id:"server",level:2},{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:3},{value:"<code>Network(network string) ServerOption</code>",id:"networknetwork-string-serveroption",level:4},{value:"<code>Address(addr string) ServerOption</code>",id:"addressaddr-string-serveroption",level:4},{value:"<code>Timeout(timeout time.Duration) ServerOption</code>",id:"timeouttimeout-timeduration-serveroption",level:4},{value:"<code>Logger(logger log.Logger) ServerOption</code>",id:"loggerlogger-loglogger-serveroption",level:4},{value:"<code>Middleware(m ...middleware.Middleware) ServerOption</code>",id:"middlewarem-middlewaremiddleware-serveroption",level:4},{value:"<code>Filter(filters ...FilterFunc) ServerOption</code>",id:"filterfilters-filterfunc-serveroption",level:4},{value:"<code>RequestDecoder(dec DecodeRequestFunc) ServerOption</code>",id:"requestdecoderdec-decoderequestfunc-serveroption",level:4},{value:"<code>ResponseEncoder(en EncodeResponseFunc) ServerOption</code>",id:"responseencoderen-encoderesponsefunc-serveroption",level:4},{value:"<code>ErrorEncoder(en EncodeErrorFunc) ServerOption</code>",id:"errorencoderen-encodeerrorfunc-serveroption",level:4},{value:"<code>TLSConfig(c *tls.Config) ServerOption</code>",id:"tlsconfigc-tlsconfig-serveroption",level:4},{value:"<code>StrictSlash(strictSlash bool) ServerOption</code>",id:"strictslashstrictslash-bool-serveroption",level:4},{value:"<code>Listener(lis net.Listener) ServerOption</code>",id:"listenerlis-netlistener-serveroption",level:4},{value:"\u542f\u52a8 Server",id:"\u542f\u52a8-server",level:3},{value:"<code>NewServer(opts ...ServerOption) *Server</code>",id:"newserveropts-serveroption-server",level:4},{value:"HTTP server \u4e2d\u4f7f\u7528 kratos middleware",id:"http-server-\u4e2d\u4f7f\u7528-kratos-middleware",level:4},{value:"middleware \u4e2d\u5904\u7406 http \u8bf7\u6c42",id:"middleware-\u4e2d\u5904\u7406-http-\u8bf7\u6c42",level:4},{value:"Server Router",id:"server-router",level:3},{value:"<code>func (s *Server) Route(prefix string, filters ...FilterFunc) *Router</code>",id:"func-s-server-routeprefix-string-filters-filterfunc-router",level:4},{value:"<code>func (s *Server) Handle(path string, h http.Handler)</code>",id:"func-s-server-handlepath-string-h-httphandler",level:4},{value:"<code>func (s *Server) HandlePrefix(prefix string, h http.Handler)</code>",id:"func-s-server-handleprefixprefix-string-h-httphandler",level:4},{value:"<code>func (s *Server) ServeHTTP(res http.ResponseWriter, req *http.Request)</code>",id:"func-s-server-servehttpres-httpresponsewriter-req-httprequest",level:4},{value:"Client",id:"client",level:2},{value:"\u914d\u7f6e",id:"\u914d\u7f6e-1",level:3},{value:"<code>WithTransport(trans http.RoundTripper) ClientOption</code>",id:"withtransporttrans-httproundtripper-clientoption",level:4},{value:"<code>WithTimeout(d time.Duration) ClientOption</code>",id:"withtimeoutd-timeduration-clientoption",level:4},{value:"<code>WithUserAgent(ua string) ClientOption</code>",id:"withuseragentua-string-clientoption",level:4},{value:"<code>WithMiddleware(m ...middleware.Middleware) ClientOption</code>",id:"withmiddlewarem-middlewaremiddleware-clientoption",level:4},{value:"<code>WithEndpoint(endpoint string) ClientOption</code>",id:"withendpointendpoint-string-clientoption",level:4},{value:"<code>WithDiscovery(d registry.Discovery) ClientOption</code>",id:"withdiscoveryd-registrydiscovery-clientoption",level:4},{value:"<code>WithRequestEncoder(encoder EncodeRequestFunc) ClientOption</code>",id:"withrequestencoderencoder-encoderequestfunc-clientoption",level:4},{value:"<code>WithResponseDecoder(decoder DecodeResponseFunc) ClientOption</code>",id:"withresponsedecoderdecoder-decoderesponsefunc-clientoption",level:4},{value:"<code>WithErrorDecoder(errorDecoder DecodeErrorFunc) ClientOption</code>",id:"witherrordecodererrordecoder-decodeerrorfunc-clientoption",level:4},{value:"<code>WithBalancer(b balancer.Balancer) ClientOption</code>",id:"withbalancerb-balancerbalancer-clientoption",level:4},{value:"<code>WithBlock() ClientOption</code>",id:"withblock-clientoption",level:4},{value:"<code>WithTLSConfig(c *tls.Config) ClientOption</code>",id:"withtlsconfigc-tlsconfig-clientoption",level:4},{value:"Client\u4f7f\u7528\u65b9\u5f0f",id:"client\u4f7f\u7528\u65b9\u5f0f",level:3},{value:"\u521b\u5efa\u5ba2\u6237\u7aef\u8fde\u63a5",id:"\u521b\u5efa\u5ba2\u6237\u7aef\u8fde\u63a5",level:4},{value:"\u4f7f\u7528\u4e2d\u95f4\u4ef6",id:"\u4f7f\u7528\u4e2d\u95f4\u4ef6",level:4},{value:"\u4f7f\u7528\u670d\u52a1\u53d1\u73b0",id:"\u4f7f\u7528\u670d\u52a1\u53d1\u73b0",level:4}];function a(e){const r={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(r.p,{children:["transporter/http \u4e2d\u57fa\u4e8e ",(0,o.jsx)(r.a,{href:"https://github.com/gorilla/mux",children:"gorilla/mux"})," HTTP\u8def\u7531\u6846\u67b6\u5b9e\u73b0\u4e86",(0,o.jsx)(r.code,{children:"Transporter"}),"\uff0c\u7528\u4ee5\u6ce8\u518c http \u5230 ",(0,o.jsx)(r.code,{children:"kratos.Server()"})," \u4e2d\u3002"]}),"\n",(0,o.jsx)(r.h2,{id:"server",children:"Server"}),"\n",(0,o.jsx)(r.h3,{id:"\u914d\u7f6e",children:"\u914d\u7f6e"}),"\n",(0,o.jsx)(r.h4,{id:"networknetwork-string-serveroption",children:(0,o.jsx)(r.code,{children:"Network(network string) ServerOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u7684 network \u534f\u8bae\uff0c\u5982 tcp"}),"\n",(0,o.jsx)(r.h4,{id:"addressaddr-string-serveroption",children:(0,o.jsx)(r.code,{children:"Address(addr string) ServerOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u76d1\u542c\u7684\u5730\u5740"}),"\n",(0,o.jsx)(r.h4,{id:"timeouttimeout-timeduration-serveroption",children:(0,o.jsx)(r.code,{children:"Timeout(timeout time.Duration) ServerOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u7684\u8d85\u65f6\u8bbe\u7f6e"}),"\n",(0,o.jsx)(r.h4,{id:"loggerlogger-loglogger-serveroption",children:(0,o.jsx)(r.code,{children:"Logger(logger log.Logger) ServerOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u4f7f\u7528\u65e5\u5fd7"}),"\n",(0,o.jsx)(r.h4,{id:"middlewarem-middlewaremiddleware-serveroption",children:(0,o.jsx)(r.code,{children:"Middleware(m ...middleware.Middleware) ServerOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u7684 kratos Service\u4e2d\u95f4\u4ef6"}),"\n",(0,o.jsx)(r.h4,{id:"filterfilters-filterfunc-serveroption",children:(0,o.jsx)(r.code,{children:"Filter(filters ...FilterFunc) ServerOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u7684 kratos \u5168\u5c40HTTP\u539f\u751fFitler\uff0c\u6b64Filter\u6267\u884c\u987a\u5e8f\u5728Service\u4e2d\u95f4\u4ef6\u4e4b\u524d"}),"\n",(0,o.jsx)(r.h4,{id:"requestdecoderdec-decoderequestfunc-serveroption",children:(0,o.jsx)(r.code,{children:"RequestDecoder(dec DecodeRequestFunc) ServerOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6ekratos\u670d\u52a1\u7aef\u7684 HTTP Request Decode\u65b9\u6cd5\uff0c\u7528\u6765\u5c06Request Body\u89e3\u6790\u81f3\u7528\u6237\u5b9a\u4e49\u7684pb\u7ed3\u6784\u4f53\u4e2d\n\u6211\u4eec\u770b\u4e0bkratos\u4e2d\u9ed8\u8ba4\u7684RequestDecoder\u662f\u600e\u4e48\u5b9e\u73b0\u7684\uff1a"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'func DefaultRequestDecoder(r *http.Request, v interface{}) error {\n\t// \u4eceRequest Header\u7684Content-Type\u4e2d\u63d0\u53d6\u51fa\u5bf9\u5e94\u7684\u89e3\u7801\u5668\n\tcodec, ok := CodecForRequest(r, "Content-Type")\n\t// \u5982\u679c\u627e\u4e0d\u5230\u5bf9\u5e94\u7684\u89e3\u7801\u5668\u6b64\u65f6\u4f1a\u62a5\u9519\n\tif !ok {\n\t\treturn errors.BadRequest("CODEC", r.Header.Get("Content-Type"))\n\t}\n\tdata, err := ioutil.ReadAll(r.Body)\n\tif err != nil {\n\t\treturn errors.BadRequest("CODEC", err.Error())\n\t}\n\tif err = codec.Unmarshal(data, v); err != nil {\n\t\treturn errors.BadRequest("CODEC", err.Error())\n\t}\n\treturn nil\n}\n'})}),"\n",(0,o.jsx)(r.p,{children:"\u90a3\u4e48\u5982\u679c\u6211\u4eec\u60f3\u8981\u6269\u5c55\u6216\u8005\u66ff\u6362Content-Type\u5bf9\u5e94\u7684\u89e3\u6790\u5b9e\u73b0\uff0c\u5c31\u53ef\u4ee5\u901a\u8fc7http.RequestDecoder()\u6765\u66ff\u6362kratos\u9ed8\u8ba4\u7684RequestDecoder\uff0c\n\u6216\u8005\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5728encoding\u4e2d\u6ce8\u518c\u6216\u8986\u76d6\u4e00\u4e2aContent-Type\u5bf9\u5e94\u7684codec\u6765\u8fdb\u884c\u6269\u5c55"}),"\n",(0,o.jsx)(r.h4,{id:"responseencoderen-encoderesponsefunc-serveroption",children:(0,o.jsx)(r.code,{children:"ResponseEncoder(en EncodeResponseFunc) ServerOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6ekratos\u670d\u52a1\u7aef\u7684 HTTP Response Encode\u65b9\u6cd5\uff0c\u7528\u6765\u5c06\u7528\u6237pb\u5b9a\u4e49\u91cc\u7684reply\u7ed3\u6784\u4f53\u5e8f\u5217\u5316\u540e\u5199\u5165Response Body\u4e2d\n\u6211\u4eec\u770b\u4e0bkratos\u4e2d\u9ed8\u8ba4\u7684ResponseEncoder\u662f\u600e\u4e48\u5b9e\u73b0\u7684\uff1a"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'func DefaultResponseEncoder(w http.ResponseWriter, r *http.Request, v interface{}) error {\n\t// \u901a\u8fc7Request Header\u7684Accept\u4e2d\u63d0\u53d6\u51fa\u5bf9\u5e94\u7684\u7f16\u7801\u5668\n\t// \u5982\u679c\u627e\u4e0d\u5230\u5219\u5ffd\u7565\u62a5\u9519\uff0c\u5e76\u4f7f\u7528\u9ed8\u8ba4json\u7f16\u7801\u5668\n\tcodec, _ := CodecForRequest(r, "Accept")\n\tdata, err := codec.Marshal(v)\n\tif err != nil {\n\t\treturn err\n\t}\n\t// \u5728Response Header\u4e2d\u5199\u5165\u7f16\u7801\u5668\u7684scheme\n\tw.Header().Set("Content-Type", httputil.ContentType(codec.Name()))\n\tw.Write(data)\n\treturn nil\n}\n'})}),"\n",(0,o.jsx)(r.p,{children:"\u90a3\u4e48\u5982\u679c\u6211\u4eec\u60f3\u8981\u6269\u5c55\u6216\u8005\u66ff\u6362Accept\u5bf9\u5e94\u7684\u5e8f\u5217\u5316\u5b9e\u73b0\uff0c\u5c31\u53ef\u4ee5\u901a\u8fc7http.ResponseEncoder()\u6765\u66ff\u6362kratos\u9ed8\u8ba4\u7684ResponseEncoder\uff0c\n\u6216\u8005\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5728encoding\u4e2d\u6ce8\u518c\u6216\u8986\u76d6\u4e00\u4e2aAccept\u5bf9\u5e94\u7684codec\u6765\u8fdb\u884c\u6269\u5c55"}),"\n",(0,o.jsx)(r.h4,{id:"errorencoderen-encodeerrorfunc-serveroption",children:(0,o.jsx)(r.code,{children:"ErrorEncoder(en EncodeErrorFunc) ServerOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6ekratos\u670d\u52a1\u7aef\u7684 HTTP Error Encode\u65b9\u6cd5\uff0c\u7528\u6765\u5c06\u4e1a\u52a1\u629b\u51fa\u7684error\u5e8f\u5217\u5316\u540e\u5199\u5165Response Body\u4e2d\uff0c\u5e76\u8bbe\u7f6eHTTP Status Code\n\u6211\u4eec\u770b\u4e0bkratos\u4e2d\u9ed8\u8ba4\u7684ErrorEncoder\u662f\u600e\u4e48\u5b9e\u73b0\u7684\uff1a"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'func DefaultErrorEncoder(w http.ResponseWriter, r *http.Request, err error) {\n\t// \u62ff\u5230error\u5e76\u8f6c\u6362\u6210kratos Error\u5b9e\u4f53\n\tse := errors.FromError(err)\n\t// \u901a\u8fc7Request Header\u7684Accept\u4e2d\u63d0\u53d6\u51fa\u5bf9\u5e94\u7684\u7f16\u7801\u5668\n\tcodec, _ := CodecForRequest(r, "Accept")\n\tbody, err := codec.Marshal(se)\n\tif err != nil {\n\t\tw.WriteHeader(http.StatusInternalServerError)\n\t\treturn\n\t}\n\tw.Header().Set("Content-Type", httputil.ContentType(codec.Name()))\n\t// \u8bbe\u7f6eHTTP Status Code\n\tw.WriteHeader(int(se.Code))\n\tw.Write(body)\n}\n'})}),"\n",(0,o.jsx)(r.h4,{id:"tlsconfigc-tlsconfig-serveroption",children:(0,o.jsx)(r.code,{children:"TLSConfig(c *tls.Config) ServerOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u4e3a kratos \u670d\u52a1\u7aef\u6dfb\u52a0 tls \u914d\u7f6e\u7528\u4e8e\u52a0\u5bc6 http \u901a\u4fe1\n\u6211\u4eec\u770b\u4e0b kratos \u4e2d\u662f\u5982\u4f55\u914d\u7f6e\u7684:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"// TLSConfig with TLS config.\nfunc TLSConfig(c *tls.Config) ServerOption {\n\treturn func(o *Server) {\n\t\to.tlsConf = c\n\t}\n}\n\n"})}),"\n",(0,o.jsx)(r.h4,{id:"strictslashstrictslash-bool-serveroption",children:(0,o.jsx)(r.code,{children:"StrictSlash(strictSlash bool) ServerOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u4e3a kratos \u670d\u52a1\u7aef\u6dfb\u52a0 StrictSlash \u914d\u7f6e\uff0c\u7528\u4e8e\u91cd\u5b9a\u5411\u8def\u7531\n\u6211\u4eec\u770b\u4e0b kratos \u4e2d\u662f\u5982\u4f55\u914d\u7f6e\u7684"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'// StrictSlash is with mux\'s StrictSlash\n// If true, when the path pattern is "/path/", accessing "/path" will\n// redirect to the former and vice versa.\nfunc StrictSlash(strictSlash bool) ServerOption {\n\treturn func(o *Server) {\n\t\to.strictSlash = strictSlash\n\t}\n}\n'})}),"\n",(0,o.jsx)(r.h4,{id:"listenerlis-netlistener-serveroption",children:(0,o.jsx)(r.code,{children:"Listener(lis net.Listener) ServerOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u4e3a kratos \u670d\u52a1\u7aef\u6dfb\u52a0 Listener \u63a5\u53e3\u7528\u4e8e\u9762\u5411\u6d41\u534f\u8bae\u7684\u4f20\u8f93\n\u6211\u4eec\u770b\u4e0b kratos \u4e2d\u662f\u5982\u4f55\u914d\u7f6e\u7684"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"// Listener with server lis\nfunc Listener(lis net.Listener) ServerOption {\n\treturn func(s *Server) {\n\t\ts.lis = lis\n\t}\n}\n"})}),"\n",(0,o.jsx)(r.h3,{id:"\u542f\u52a8-server",children:"\u542f\u52a8 Server"}),"\n",(0,o.jsx)(r.h4,{id:"newserveropts-serveroption-server",children:(0,o.jsx)(r.code,{children:"NewServer(opts ...ServerOption) *Server"})}),"\n",(0,o.jsx)(r.p,{children:"\u4f20\u5165opts\u914d\u7f6e\u5e76\u542f\u52a8HTTP Server"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'hs := http.NewServer()\napp := kratos.New(\n  kratos.Name("kratos"),\n  kratos.Version("v1.0.0"),\n  kratos.Server(hs),\n)\n'})}),"\n",(0,o.jsx)(r.h4,{id:"http-server-\u4e2d\u4f7f\u7528-kratos-middleware",children:"HTTP server \u4e2d\u4f7f\u7528 kratos middleware"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'hs := http.NewServer(\n\thttp.Address(":8000"),\n\thttp.Middleware(\n\t\tlogging.Server(),\n\t),\n)\n'})}),"\n",(0,o.jsx)(r.h4,{id:"middleware-\u4e2d\u5904\u7406-http-\u8bf7\u6c42",children:"middleware \u4e2d\u5904\u7406 http \u8bf7\u6c42"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"if tr, ok := transport.FromServerContext(ctx); ok {\n\tkind = tr.Kind().String()\n\toperation = tr.Operation()\n\t// \u65ad\u8a00\u6210HTTP\u7684Transport\u53ef\u4ee5\u62ff\u5230\u7279\u6b8a\u4fe1\u606f\n\tif ht, ok := tr.(*http.Transport); ok {\n\t\tfmt.Println(ht.Request())\n\t}\n}\n"})}),"\n",(0,o.jsx)(r.h3,{id:"server-router",children:"Server Router"}),"\n",(0,o.jsx)(r.h4,{id:"func-s-server-routeprefix-string-filters-filterfunc-router",children:(0,o.jsx)(r.code,{children:"func (s *Server) Route(prefix string, filters ...FilterFunc) *Router"})}),"\n",(0,o.jsx)(r.p,{children:"\u521b\u5efa\u4e00\u4e2a\u65b0\u7684HTTP Server Router\uff0c\u540c\u65f6\u53ef\u4ee5\u4f20\u9012kratos\u7684HTTP Filter\u62e6\u622a\u5668\n\u6211\u4eec\u770b\u4e0b\u7528\u6cd5\uff1a"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'r := s.Route("/v1")\nr.GET("/helloworld/{name}", _Greeter_SayHello0_HTTP_Handler(srv))\n'})}),"\n",(0,o.jsx)(r.h4,{id:"func-s-server-handlepath-string-h-httphandler",children:(0,o.jsx)(r.code,{children:"func (s *Server) Handle(path string, h http.Handler)"})}),"\n",(0,o.jsx)(r.p,{children:"\u5c06path\u6dfb\u52a0\u5230\u8def\u7531\u4e2d\uff0c\u5e76\u4f7f\u7528\u6807\u51c6\u7684HTTP Handler\u6765\u5904\u7406"}),"\n",(0,o.jsx)(r.h4,{id:"func-s-server-handleprefixprefix-string-h-httphandler",children:(0,o.jsx)(r.code,{children:"func (s *Server) HandlePrefix(prefix string, h http.Handler)"})}),"\n",(0,o.jsx)(r.p,{children:"\u524d\u7f00\u5339\u914d\u7684\u65b9\u5f0f\u5c06prefix\u6dfb\u52a0\u5230\u8def\u7531\u4e2d\uff0c\u5e76\u4f7f\u7528\u6807\u51c6\u7684HTTP Handler\u6765\u5904\u7406"}),"\n",(0,o.jsx)(r.h4,{id:"func-s-server-servehttpres-httpresponsewriter-req-httprequest",children:(0,o.jsx)(r.code,{children:"func (s *Server) ServeHTTP(res http.ResponseWriter, req *http.Request)"})}),"\n",(0,o.jsx)(r.p,{children:"\u5b9e\u73b0\u4e86\u6807\u51c6\u5e93\u7684HTTP Handler\u63a5\u53e3"}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsxs)(r.p,{children:["\u5176\u4ed6\u8def\u7531\u4f7f\u7528\u65b9\u6cd5\u53c2\u8003: ",(0,o.jsx)(r.a,{href:"https://github.com/go-kratos/examples/tree/main/http/middlewares",children:"https://github.com/go-kratos/examples/tree/main/http/middlewares"})]}),"\n"]}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsxs)(r.p,{children:["\u5728Kratos HTTP\u4e2d\u4f7f\u7528",(0,o.jsx)(r.a,{href:"https://github.com/gin-gonic/gin",children:"gin"}),"\u6846\u67b6: ",(0,o.jsx)(r.a,{href:"https://github.com/go-kratos/examples/blob/main/http/gin/main.go",children:"https://github.com/go-kratos/examples/blob/main/http/gin/main.go"})]}),"\n"]}),"\n",(0,o.jsx)(r.h2,{id:"client",children:"Client"}),"\n",(0,o.jsx)(r.h3,{id:"\u914d\u7f6e-1",children:"\u914d\u7f6e"}),"\n",(0,o.jsx)(r.h4,{id:"withtransporttrans-httproundtripper-clientoption",children:(0,o.jsx)(r.code,{children:"WithTransport(trans http.RoundTripper) ClientOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u7684HTTP RoundTripper"}),"\n",(0,o.jsx)(r.h4,{id:"withtimeoutd-timeduration-clientoption",children:(0,o.jsx)(r.code,{children:"WithTimeout(d time.Duration) ClientOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u9ed8\u8ba4\u8d85\u65f6\u65f6\u95f4\uff0c\u5982\u679c\u6709\u94fe\u8def\u8d85\u65f6\u4f18\u5148\u4f7f\u7528\u94fe\u8def\u8d85\u65f6\u65f6\u95f4"}),"\n",(0,o.jsx)(r.h4,{id:"withuseragentua-string-clientoption",children:(0,o.jsx)(r.code,{children:"WithUserAgent(ua string) ClientOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u7684\u9ed8\u8ba4User-Agent"}),"\n",(0,o.jsx)(r.h4,{id:"withmiddlewarem-middlewaremiddleware-clientoption",children:(0,o.jsx)(r.code,{children:"WithMiddleware(m ...middleware.Middleware) ClientOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u4f7f\u7528\u7684 kratos client\u4e2d\u95f4\u4ef6"}),"\n",(0,o.jsx)(r.h4,{id:"withendpointendpoint-string-clientoption",children:(0,o.jsx)(r.code,{children:"WithEndpoint(endpoint string) ClientOption"})}),"\n",(0,o.jsxs)(r.p,{children:["\u914d\u7f6e\u5ba2\u6237\u7aef\u4f7f\u7528\u7684\u5bf9\u7aef\u8fde\u63a5\u5730\u5740\uff0c\u5982\u679c\u4e0d\u4f7f\u7528\u670d\u52a1\u53d1\u73b0\u5219\u4e3aip",":port",",\u5982\u679c\u4f7f\u7528\u670d\u52a1\u53d1\u73b0\u5219\u683c\u5f0f\u4e3adiscovery://<authority>/<serviceName>,\u8fd9\u91cc<authority>\u53ef\u4ee5\u9ed8\u8ba4\u586b\u7a7a"]}),"\n",(0,o.jsx)(r.h4,{id:"withdiscoveryd-registrydiscovery-clientoption",children:(0,o.jsx)(r.code,{children:"WithDiscovery(d registry.Discovery) ClientOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u4f7f\u7528\u7684\u670d\u52a1\u53d1\u73b0"}),"\n",(0,o.jsx)(r.h4,{id:"withrequestencoderencoder-encoderequestfunc-clientoption",children:(0,o.jsx)(r.code,{children:"WithRequestEncoder(encoder EncodeRequestFunc) ClientOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u7684 HTTP Request Encode\u65b9\u6cd5\uff0c\u7528\u6765\u5c06\u6237\u5b9a\u4e49\u7684pb\u7ed3\u6784\u4f53\u4e2d\u5e8f\u5217\u5316\u81f3Request Body\n\u6211\u4eec\u770b\u4e0b\u9ed8\u8ba4\u7684encoder:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"func DefaultRequestEncoder(ctx context.Context, contentType string, in interface{}) ([]byte, error) {\n\t// \u901a\u8fc7\u5916\u90e8\u914d\u7f6e\u7684contentType\u83b7\u53d6encoder\u7c7b\u578b\n\tname := httputil.ContentSubtype(contentType)\n\t// \u62ff\u5230\u5b9e\u9645\u7684encoder\n\tbody, err := encoding.GetCodec(name).Marshal(in)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn body, err\n}\n"})}),"\n",(0,o.jsx)(r.h4,{id:"withresponsedecoderdecoder-decoderesponsefunc-clientoption",children:(0,o.jsx)(r.code,{children:"WithResponseDecoder(decoder DecodeResponseFunc) ClientOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u7684 HTTP Response Decode\u65b9\u6cd5\uff0c\u7528\u6765\u5c06Response Body\u89e3\u6790\u81f3\u7528\u6237\u5b9a\u4e49\u7684pb\u7ed3\u6784\u4f53\u4e2d\n\u6211\u4eec\u770b\u4e0bkratos\u4e2d\u9ed8\u8ba4\u7684decoder\u662f\u600e\u4e48\u5b9e\u73b0\u7684\uff1a"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"func DefaultResponseDecoder(ctx context.Context, res *http.Response, v interface{}) error {\n\tdefer res.Body.Close()\n\tdata, err := ioutil.ReadAll(res.Body)\n\tif err != nil {\n\t\treturn err\n\t}\n\t// \u8fd9\u91cc\u6839\u636eResponse Header\u4e2d\u7684Content-Type\u62ff\u5230\u5bf9\u5e94\u7684decoder\n\t// \u7136\u540e\u8fdb\u884cUnmarshal\n\treturn CodecForResponse(res).Unmarshal(data, v)\n}\n"})}),"\n",(0,o.jsx)(r.h4,{id:"witherrordecodererrordecoder-decodeerrorfunc-clientoption",children:(0,o.jsx)(r.code,{children:"WithErrorDecoder(errorDecoder DecodeErrorFunc) ClientOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u7684Error\u89e3\u6790\u65b9\u6cd5\n\u6211\u4eec\u770b\u4e0bkratos\u4e2d\u9ed8\u8ba4\u7684error decoder\u662f\u600e\u4e48\u5b9e\u73b0\u7684\uff1a"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"func DefaultErrorDecoder(ctx context.Context, res *http.Response) error {\n\t// HTTP Status Code \u4e3a\u6700\u9ad8\u4f18\u5148\u7ea7\n\tif res.StatusCode >= 200 && res.StatusCode <= 299 {\n\t\treturn nil\n\t}\n\tdefer res.Body.Close()\n\tdata, err := ioutil.ReadAll(res.Body)\n\tif err == nil {\n\t\te := new(errors.Error)\n\t\t// \u8fd9\u91cc\u6839\u636eResponse Header\u4e2d\u7684Content-Type\u62ff\u5230\u5bf9\u5e94\u7684response decoder\n\t\t// \u7136\u540e\u89e3\u6790\u51faerror\u4e3b\u4f53\u5185\u5bb9\n\t\tif err = CodecForResponse(res).Unmarshal(data, e); err == nil {\n\t\t\t// HTTP Status Code \u4e3a\u6700\u9ad8\u4f18\u5148\u7ea7\n\t\t\te.Code = int32(res.StatusCode)\n\t\t\treturn e\n\t\t}\n\t}\n\t// \u5982\u679c\u6ca1\u6709\u8fd4\u56de\u5408\u6cd5\u7684Response Body\u5219\u76f4\u63a5\u4ee5HTTP Status Code\u4e3a\u51c6\n\treturn errors.Errorf(res.StatusCode, errors.UnknownReason, err.Error())\n}\n"})}),"\n",(0,o.jsx)(r.h4,{id:"withbalancerb-balancerbalancer-clientoption",children:(0,o.jsx)(r.code,{children:"WithBalancer(b balancer.Balancer) ClientOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565"}),"\n",(0,o.jsx)(r.h4,{id:"withblock-clientoption",children:(0,o.jsx)(r.code,{children:"WithBlock() ClientOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u7684Dial\u7b56\u7565\u4e3a\u963b\u585e\uff08\u76f4\u5230\u670d\u52a1\u53d1\u73b0\u53d1\u73b0\u8282\u70b9\u624d\u8fd4\u56de\uff09\uff0c\u9ed8\u8ba4\u4e3a\u5f02\u6b65\u975e\u963b\u585e"}),"\n",(0,o.jsx)(r.h4,{id:"withtlsconfigc-tlsconfig-clientoption",children:(0,o.jsx)(r.code,{children:"WithTLSConfig(c *tls.Config) ClientOption"})}),"\n",(0,o.jsx)(r.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u7684tls"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"// WithTLSConfig with tls config.\nfunc WithTLSConfig(c *tls.Config) ClientOption {\n\treturn func(o *clientOptions) {\n\t\to.tlsConf = c\n\t}\n}\n"})}),"\n",(0,o.jsx)(r.h3,{id:"client\u4f7f\u7528\u65b9\u5f0f",children:"Client\u4f7f\u7528\u65b9\u5f0f"}),"\n",(0,o.jsx)(r.h4,{id:"\u521b\u5efa\u5ba2\u6237\u7aef\u8fde\u63a5",children:"\u521b\u5efa\u5ba2\u6237\u7aef\u8fde\u63a5"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'conn, err := http.NewClient(\n\tcontext.Background(),\n\thttp.WithEndpoint("127.0.0.1:8000"),\n)\n'})}),"\n",(0,o.jsx)(r.h4,{id:"\u4f7f\u7528\u4e2d\u95f4\u4ef6",children:"\u4f7f\u7528\u4e2d\u95f4\u4ef6"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'conn, err := http.NewClient(\n\tcontext.Background(),\n\thttp.WithEndpoint("127.0.0.1:9000"),\n\thttp.WithMiddleware(\n\t\trecovery.Recovery(),\n\t),\n)\n'})}),"\n",(0,o.jsx)(r.h4,{id:"\u4f7f\u7528\u670d\u52a1\u53d1\u73b0",children:"\u4f7f\u7528\u670d\u52a1\u53d1\u73b0"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'conn, err := http.NewClient(\n\tcontext.Background(),\n\thttp.WithEndpoint("discovery:///helloworld"),\n\thttp.WithDiscovery(r),\n)\n'})})]})}function p(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(a,{...e})}):a(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>s,x:()=>d});var t=n(6540);const o={},i=t.createContext(o);function s(e){const r=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),t.createElement(i.Provider,{value:r},e.children)}}}]);