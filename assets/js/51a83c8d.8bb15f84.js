"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6020],{2549:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>l,default:()=>a,frontMatter:()=>o,metadata:()=>t,toc:()=>s});const t=JSON.parse('{"id":"component/middleware/logging","title":"\u65e5\u5fd7","description":"Logging \u4e2d\u95f4\u4ef6\u7528\u4e8e\u6253\u5370\u670d\u52a1\u6536\u5230\u6216\u53d1\u8d77\u7684\u8bf7\u6c42\u8be6\u60c5\u3002","source":"@site/docs/component/middleware/04-logging.md","sourceDirName":"component/middleware","slug":"/component/middleware/logging","permalink":"/docs/component/middleware/logging","draft":false,"unlisted":false,"editUrl":"https://github.com/go-kratos/go-kratos.dev/edit/main/docs/component/middleware/04-logging.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"id":"logging","title":"\u65e5\u5fd7","keywords":["Go","Kratos","Toolkit","Framework","Microservices","Protobuf","gRPC","HTTP"]},"sidebar":"docs","previous":{"title":"\u7194\u65ad\u5668","permalink":"/docs/component/middleware/circuitbreaker"},"next":{"title":"\u76d1\u63a7","permalink":"/docs/component/middleware/metrics"}}');var i=n(4848),c=n(8453);const o={id:"logging",title:"\u65e5\u5fd7",keywords:["Go","Kratos","Toolkit","Framework","Microservices","Protobuf","gRPC","HTTP"]},l=void 0,d={},s=[{value:"\u4f7f\u7528\u65b9\u6cd5",id:"\u4f7f\u7528\u65b9\u6cd5",level:3},{value:"grpc server",id:"grpc-server",level:4},{value:"grpc client",id:"grpc-client",level:4},{value:"http server",id:"http-server",level:4},{value:"http client",id:"http-client",level:4},{value:"\u5728\u9879\u76ee\u4e2d\u4f7f\u7528",id:"\u5728\u9879\u76ee\u4e2d\u4f7f\u7528",level:3},{value:"grpc-server internal/server/grpc.go",id:"grpc-server-internalservergrpcgo",level:4},{value:"\u65e5\u5fd7\u589e\u52a0trace_id\u5b57\u6bb5  cmd/\u9879\u76ee\u540d/main.go",id:"\u65e5\u5fd7\u589e\u52a0trace_id\u5b57\u6bb5--cmd\u9879\u76ee\u540dmaingo",level:4},{value:"\u65e5\u5fd7\u6253\u5370trace_id",id:"\u65e5\u5fd7\u6253\u5370trace_id",level:4}];function g(e){const r={code:"code",h3:"h3",h4:"h4",p:"p",pre:"pre",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.p,{children:"Logging \u4e2d\u95f4\u4ef6\u7528\u4e8e\u6253\u5370\u670d\u52a1\u6536\u5230\u6216\u53d1\u8d77\u7684\u8bf7\u6c42\u8be6\u60c5\u3002"}),"\n",(0,i.jsx)(r.h3,{id:"\u4f7f\u7528\u65b9\u6cd5",children:"\u4f7f\u7528\u65b9\u6cd5"}),"\n",(0,i.jsx)(r.h4,{id:"grpc-server",children:"grpc server"}),"\n",(0,i.jsxs)(r.p,{children:["\u5728 ",(0,i.jsx)(r.code,{children:"grpc.ServerOption"})," \u4e2d\u5f15\u5165 ",(0,i.jsx)(r.code,{children:"logging.Server()"}),", \u5219\u4f1a\u5728\u6bcf\u6b21\u6536\u5230 gRPC \u8bf7\u6c42\u7684\u65f6\u5019\u6253\u5370\u8be6\u7ec6\u8bf7\u6c42\u4fe1\u606f\u3002"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:"logger := log.DefaultLogger\nvar opts = []grpc.ServerOption{\n\tgrpc.Middleware(\n\t\tlogging.Server(logger),\n\t),\n}\nsrv := grpc.NewServer(opts...)\n"})}),"\n",(0,i.jsx)(r.h4,{id:"grpc-client",children:"grpc client"}),"\n",(0,i.jsxs)(r.p,{children:["\u5728 ",(0,i.jsx)(r.code,{children:"grpc.WithMiddleware"})," \u4e2d\u5f15\u5165 ",(0,i.jsx)(r.code,{children:"logging.Client()"}),", \u5219\u4f1a\u5728\u6bcf\u6b21\u53d1\u8d77 grpc \u8bf7\u6c42\u7684\u65f6\u5019\u6253\u5370\u8be6\u7ec6\u8bf7\u6c42\u4fe1\u606f\u3002"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:'logger := log.DefaultLogger\nconn, err := grpc.DialInsecure(\n\tcontext.Background(),\n\tgrpc.WithEndpoint("127.0.0.1:9000"),\n\tgrpc.WithMiddleware(\n\t\tlogging.Client(logger),\n\t),\n)\n'})}),"\n",(0,i.jsx)(r.h4,{id:"http-server",children:"http server"}),"\n",(0,i.jsxs)(r.p,{children:["\u5728 ",(0,i.jsx)(r.code,{children:"http.ServerOption"})," \u4e2d\u5f15\u5165 ",(0,i.jsx)(r.code,{children:"logging.Server()"}),", \u5219\u4f1a\u5728\u6bcf\u6b21\u6536\u5230 Http \u8bf7\u6c42\u7684\u65f6\u5019\u6253\u5370\u8be6\u7ec6\u8bf7\u6c42\u4fe1\u606f\u3002"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:"logger := log.DefaultLogger\nvar opts = []http.ServerOption{\n\thttp.Middleware(\n\t\tlogging.Server(logger),\n\t),\n}\nsrv := http.NewServer(opts...)\n"})}),"\n",(0,i.jsx)(r.h4,{id:"http-client",children:"http client"}),"\n",(0,i.jsxs)(r.p,{children:["\u5728 ",(0,i.jsx)(r.code,{children:"http.WithMiddleware"})," \u4e2d\u5f15\u5165 ",(0,i.jsx)(r.code,{children:"logging.Client()"}),", \u5219\u4f1a\u5728\u6bcf\u6b21\u53d1\u8d77 Http \u8bf7\u6c42\u7684\u65f6\u5019\u6253\u5370\u8be6\u7ec6\u8bf7\u6c42\u4fe1\u606f\u3002"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:'logger := log.DefaultLogger\nconn, err := http.NewClient(\n\tcontext.Background(),\n\thttp.WithMiddleware(\n\t\tlogging.Client(logger),\n\t),\n\thttp.WithEndpoint("127.0.0.1:8000"),\n)\n'})}),"\n",(0,i.jsx)(r.p,{children:"Logging \u4e2d\u95f4\u4ef6\u5728server \u4e2d\u53ea\u6253\u5370 trace_id \u4e0d\u91c7\u96c6\u6570\u636e"}),"\n",(0,i.jsx)(r.h3,{id:"\u5728\u9879\u76ee\u4e2d\u4f7f\u7528",children:"\u5728\u9879\u76ee\u4e2d\u4f7f\u7528"}),"\n",(0,i.jsx)(r.h4,{id:"grpc-server-internalservergrpcgo",children:"grpc-server internal/server/grpc.go"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:'exporter, err := stdouttrace.New(stdouttrace.WithWriter(ioutil.Discard))\nif err != nil {\n\tfmt.Printf("creating stdout exporter: %v", err)\n\tpanic(err)\n}\ntp := tracesdk.NewTracerProvider(\n\ttracesdk.WithBatcher(exporter),\n\ttracesdk.WithResource(resource.NewSchemaless(\n\t\tsemconv.ServiceNameKey.String(Name)),\n\t))\nvar opts = []grpc.ServerOption{\n\t\tgrpc.Middleware(\n\t\t\ttracing.Server(tracing.WithTracerProvider(tp)),\n\t\t),\n\t}\nsrv := grpc.NewServer(opts...)\n'})}),"\n",(0,i.jsx)(r.h4,{id:"\u65e5\u5fd7\u589e\u52a0trace_id\u5b57\u6bb5--cmd\u9879\u76ee\u540dmaingo",children:"\u65e5\u5fd7\u589e\u52a0trace_id\u5b57\u6bb5  cmd/\u9879\u76ee\u540d/main.go"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:'logger := log.With(log.NewStdLogger(os.Stdout),\n\t\t"ts", log.DefaultTimestamp,\n\t\t"caller", log.DefaultCaller,\n\t\t"service.id", id,\n\t\t"service.name", Name,\n\t\t"service.version", Version,\n\t\t"trace_id", tracing.TraceID(),\n        "span_id", tracing.SpanID(),\n\t)\n'})}),"\n",(0,i.jsx)(r.h4,{id:"\u65e5\u5fd7\u6253\u5370trace_id",children:"\u65e5\u5fd7\u6253\u5370trace_id"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:'log.WithContext(ctx).Errorf("\u521b\u5efaxxx\u5931\u8d25: %s", err)\n'})})]})}function a(e={}){const{wrapper:r}={...(0,c.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(g,{...e})}):g(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>o,x:()=>l});var t=n(6540);const i={},c=t.createContext(i);function o(e){const r=t.useContext(c);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(c.Provider,{value:r},e.children)}}}]);