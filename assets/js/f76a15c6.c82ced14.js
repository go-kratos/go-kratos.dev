"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3132],{6517:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>c,default:()=>d,frontMatter:()=>a,metadata:()=>n,toc:()=>s});const n=JSON.parse('{"id":"component/middleware/tracing","title":"\u94fe\u8def\u8ffd\u8e2a","description":"Tracing \u4e2d\u95f4\u4ef6\u4f7f\u7528 OpenTelemetry \u5b9e\u73b0\u4e86\u94fe\u8def\u8ffd\u8e2a\u3002","source":"@site/docs/component/middleware/08-tracing.md","sourceDirName":"component/middleware","slug":"/component/middleware/tracing","permalink":"/docs/component/middleware/tracing","draft":false,"unlisted":false,"editUrl":"https://github.com/go-kratos/go-kratos.dev/edit/main/docs/component/middleware/08-tracing.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"id":"tracing","title":"\u94fe\u8def\u8ffd\u8e2a","keywords":["Go","Kratos","Toolkit","Framework","Microservices","Protobuf","gRPC","HTTP"]},"sidebar":"docs","previous":{"title":"\u5f02\u5e38\u6062\u590d","permalink":"/docs/component/middleware/recovery"},"next":{"title":"\u53c2\u6570\u6821\u9a8c","permalink":"/docs/component/middleware/validate"}}');var o=r(4848),i=r(8453);const a={id:"tracing",title:"\u94fe\u8def\u8ffd\u8e2a",keywords:["Go","Kratos","Toolkit","Framework","Microservices","Protobuf","gRPC","HTTP"]},c=void 0,l={},s=[{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:3},{value:"<code>WithTracerProvider</code>",id:"withtracerprovider",level:4},{value:"<code>WithPropagator</code>",id:"withpropagator",level:4},{value:"\u4f7f\u7528\u65b9\u6cd5",id:"\u4f7f\u7528\u65b9\u6cd5",level:3},{value:"server \u4e2d\u4f7f\u7528 tracing \u91c7\u96c6\u6570\u636e",id:"server-\u4e2d\u4f7f\u7528-tracing-\u91c7\u96c6\u6570\u636e",level:4},{value:"client \u4e2d\u4f7f\u7528 tracing \u91c7\u96c6\u6570\u636e",id:"client-\u4e2d\u4f7f\u7528-tracing-\u91c7\u96c6\u6570\u636e",level:4},{value:"\u81ea\u52a8\u91c7\u96c6\u6570\u636e",id:"\u81ea\u52a8\u91c7\u96c6\u6570\u636e",level:4},{value:"References",id:"references",level:3}];function p(e){const t={a:"a",code:"code",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"Tracing \u4e2d\u95f4\u4ef6\u4f7f\u7528 OpenTelemetry \u5b9e\u73b0\u4e86\u94fe\u8def\u8ffd\u8e2a\u3002"}),"\n",(0,o.jsx)(t.h3,{id:"\u914d\u7f6e",children:"\u914d\u7f6e"}),"\n",(0,o.jsxs)(t.p,{children:["\u6709\u4e24\u79cd\u65b9\u6cd5\u53ef\u7528\u4e8e\u4f7f\u7528",(0,o.jsx)(t.code,{children:"WithTracerProvider()"})," and ",(0,o.jsx)(t.code,{children:"WithPropagator()"}),"\u8fdb\u884c\u914d\u7f6e\u3002"]}),"\n",(0,o.jsx)(t.h4,{id:"withtracerprovider",children:(0,o.jsx)(t.code,{children:"WithTracerProvider"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-go",children:"func WithTracerProvider(provider trace.TracerProvider) Option {\n    return func(opts *options) {\n        opts.TracerProvider = provider\n    }\n}    \n"})}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.code,{children:"WithTracerProvider"})," \u7528\u4e8e\u8bbe\u7f6e provider\uff0c\u5b83\u63a5\u6536\u7684\u53c2\u6570\u4e3a ",(0,o.jsx)(t.code,{children:"trace.TracerProvider"}),"\u3002"]}),"\n",(0,o.jsx)(t.h4,{id:"withpropagator",children:(0,o.jsx)(t.code,{children:"WithPropagator"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-go",children:"func WithPropagator(propagator propagation.TextMapPropagator) Option {\n    return func(opts *options) {\n        opts.Propagator = propagator\n    }\n}\n"})}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.code,{children:"WithPropagator"})," \u7528\u4e8e\u8bbe\u7f6e text map propagator\uff0c\u5b83\u63a5\u6536\u7684\u53c2\u6570\u4e3a ",(0,o.jsx)(t.code,{children:"propagation.TextMapPropagator"}),"\u3002"]}),"\n",(0,o.jsx)(t.h3,{id:"\u4f7f\u7528\u65b9\u6cd5",children:"\u4f7f\u7528\u65b9\u6cd5"}),"\n",(0,o.jsx)(t.h4,{id:"server-\u4e2d\u4f7f\u7528-tracing-\u91c7\u96c6\u6570\u636e",children:"server \u4e2d\u4f7f\u7528 tracing \u91c7\u96c6\u6570\u636e"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-go",children:'package server\n\nimport (\n\t"github.com/go-kratos/kratos/v2/middleware/tracing"\n\t"github.com/go-kratos/kratos/v2/transport/grpc"\n\n\t"go.opentelemetry.io/otel"\n\t"go.opentelemetry.io/otel/attribute"\n\t"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"\n\t"go.opentelemetry.io/otel/sdk/resource"\n\ttracesdk "go.opentelemetry.io/otel/sdk/trace"\n\tsemconv "go.opentelemetry.io/otel/semconv/v1.4.0"\n)\n\n// \u8bbe\u7f6e\u5168\u5c40trace\nfunc initTracer(endpoint string) error {\n\t// \u521b\u5efa exporter\n\texporter, err := otlptracehttp.New(context.Background(),\n\t\totlptracehttp.WithEndpoint(endpoint),\n\t\totlptracehttp.WithInsecure(),\n\t)\n\tif err != nil {\n\t\treturn err\n\t}\n\ttp := tracesdk.NewTracerProvider(\n\t\t// \u5c06\u57fa\u4e8e\u7236span\u7684\u91c7\u6837\u7387\u8bbe\u7f6e\u4e3a100%\n\t\ttracesdk.WithSampler(tracesdk.ParentBased(tracesdk.TraceIDRatioBased(1.0))),\n\t\t// \u59cb\u7ec8\u786e\u4fdd\u5728\u751f\u4ea7\u4e2d\u6279\u91cf\u5904\u7406\n\t\ttracesdk.WithBatcher(exporter),\n\t\t// \u5728\u8d44\u6e90\u4e2d\u8bb0\u5f55\u6709\u5173\u6b64\u5e94\u7528\u7a0b\u5e8f\u7684\u4fe1\u606f\n\t\ttracesdk.WithResource(resource.NewSchemaless(\n\t\t\tsemconv.ServiceNameKey.String("kratos-trace"),\n\t\t\tattribute.String("exporter", "otlp"),\n\t\t\tattribute.Float64("float", 312.23),\n\t\t)),\n\t)\n\totel.SetTracerProvider(tp)\n\treturn nil\n}\n\n// NewGRPCServer new a gRPC server.\nfunc NewGRPCServer(c *conf.Server, executor *service.ExecutorService) *grpc.Server {\n\terr := initTracer("localhost:4318")\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\t//tr := otel.Tracer("component-main")\n\tvar opts = []grpc.ServerOption{\n\t\tgrpc.Middleware(\n\t\t\ttracing.Server(),\n\t\t),\n\t}\n\t// ...\n}\n'})}),"\n",(0,o.jsx)(t.h4,{id:"client-\u4e2d\u4f7f\u7528-tracing-\u91c7\u96c6\u6570\u636e",children:"client \u4e2d\u4f7f\u7528 tracing \u91c7\u96c6\u6570\u636e"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-go",children:'package client\n\nimport (\n\t"context"\n\n\t"github.com/go-kratos/kratos/v2/middleware/tracing"\n\t"github.com/go-kratos/kratos/v2/transport/grpc"\n\n\t"go.opentelemetry.io/otel"\n\t"go.opentelemetry.io/otel/attribute"\n\t"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"\n\t"go.opentelemetry.io/otel/sdk/resource"\n\ttracesdk "go.opentelemetry.io/otel/sdk/trace"\n\tsemconv "go.opentelemetry.io/otel/semconv/v1.4.0"\n\tgooglegrpc "google.golang.org/grpc"\n)\n\n// \u8bbe\u7f6e\u5168\u5c40trace\nfunc initTracer(endpoint string) error {\n\t// \u521b\u5efa exporter\n\texporter, err := otlptracehttp.New(context.Background(),\n\t\totlptracehttp.WithEndpoint(endpoint),\n\t\totlptracehttp.WithInsecure(),\n\t)\n\tif err != nil {\n\t\treturn err\n\t}\n\ttp := tracesdk.NewTracerProvider(\n\t\t// \u5c06\u57fa\u4e8e\u7236span\u7684\u91c7\u6837\u7387\u8bbe\u7f6e\u4e3a100%\n\t\ttracesdk.WithSampler(tracesdk.ParentBased(tracesdk.TraceIDRatioBased(1.0))),\n\t\t// \u59cb\u7ec8\u786e\u4fdd\u5728\u751f\u4ea7\u4e2d\u6279\u91cf\u5904\u7406\n\t\ttracesdk.WithBatcher(exporter),\n\t\t// \u5728\u8d44\u6e90\u4e2d\u8bb0\u5f55\u6709\u5173\u6b64\u5e94\u7528\u7a0b\u5e8f\u7684\u4fe1\u606f\n\t\ttracesdk.WithResource(resource.NewSchemaless(\n\t\t\tsemconv.ServiceNameKey.String("kratos-trace"),\n\t\t\tattribute.String("exporter", "otlp"),\n\t\t\tattribute.Float64("float", 312.23),\n\t\t)),\n\t)\n\totel.SetTracerProvider(tp)\n\treturn nil\n}\n\nfunc grpcCli() (*googlegrpc.ClientConn, error) {\n\t// \u5982\u679c\u672c\u9879\u76ee\u6ca1\u6709\u521d\u59cb\u5316initTracer \u8bf7\u521d\u59cb\u5316\n\treturn grpc.DialInsecure(\n\t\tcontext.Background(),\n\t\tgrpc.WithMiddleware(\n\t\t\ttracing.Client(),\n\t\t),\n\t)\n}\n'})}),"\n",(0,o.jsx)(t.h4,{id:"\u81ea\u52a8\u91c7\u96c6\u6570\u636e",children:"\u81ea\u52a8\u91c7\u96c6\u6570\u636e"}),"\n",(0,o.jsxs)(t.p,{children:["\u5982\u679c\u4e0d\u60f3\u624b\u52a8\u4fee\u6539\u4ee3\u7801\uff0c\u60a8\u8fd8\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e9b\u6846\u67b6\u8fdb\u884cOpenTelemetry\u6570\u636e\u7684\u81ea\u52a8\u91c7\u96c6\uff0c\u6bd4\u5982",(0,o.jsx)(t.a,{href:"https://github.com/alibaba/opentelemetry-go-auto-instrumentation",children:"Alibaba Go Auto Instrumentation"})," (\u540e\u7eed\u5c06\u6b63\u5f0f\u6350\u8d60\u81f3",(0,o.jsx)(t.a,{href:"https://github.com/open-telemetry/opentelemetry-go-compile-instrumentation",children:"OpenTelemetry\u5b98\u65b9"}),")\u3002"]}),"\n",(0,o.jsxs)(t.p,{children:["\u60a8\u53ef\u4ee5\u53c2\u8003",(0,o.jsx)(t.a,{href:"https://github.com/alibaba/opentelemetry-go-auto-instrumentation/blob/main/README.md",children:"\u6587\u6863"}),"\u6765\u7f16\u8bd1\u60a8\u7684Kratos\u5e94\u7528\u3002"]}),"\n",(0,o.jsx)(t.h3,{id:"references",children:"References"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"https://opentelemetry.io/",children:"https://opentelemetry.io/"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"https://github.com/open-telemetry/opentelemetry-go/tree/main/example",children:"https://github.com/open-telemetry/opentelemetry-go/tree/main/example"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"https://pkg.go.dev/go.opentelemetry.io/otel",children:"https://pkg.go.dev/go.opentelemetry.io/otel"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"https://github.com/alibaba/opentelemetry-go-auto-instrumentation",children:"https://github.com/alibaba/opentelemetry-go-auto-instrumentation"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"https://github.com/open-telemetry/opentelemetry-go-compile-instrumentation",children:"https://github.com/open-telemetry/opentelemetry-go-compile-instrumentation"})}),"\n"]})]})}function d(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}},8453:(e,t,r)=>{r.d(t,{R:()=>a,x:()=>c});var n=r(6540);const o={},i=n.createContext(o);function a(e){const t=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);