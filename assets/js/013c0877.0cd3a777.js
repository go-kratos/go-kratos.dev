"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[9762],{1674:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>a,frontMatter:()=>c,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"component/transport/grpc","title":"gRPC","description":"transporter/grpc \u4e2d\u57fa\u4e8e\u8c37\u6b4c\u7684 grpc \u6846\u67b6\u5b9e\u73b0\u4e86Transporter\uff0c\u7528\u4ee5\u6ce8\u518c grpc \u5230 kratos.Server() \u4e2d\u3002","source":"@site/docs/component/transport/03-grpc.md","sourceDirName":"component/transport","slug":"/component/transport/grpc","permalink":"/docs/component/transport/grpc","draft":false,"unlisted":false,"editUrl":"https://github.com/go-kratos/go-kratos.dev/edit/main/docs/component/transport/03-grpc.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"id":"grpc","title":"gRPC","keywords":["Go","Kratos","Toolkit","Framework","Microservices","Protobuf","gRPC","HTTP"]},"sidebar":"docs","previous":{"title":"HTTP","permalink":"/docs/component/transport/http"},"next":{"title":"\u7528\u6237\u6307\u5357","permalink":"/docs/category/\u7528\u6237\u6307\u5357"}}');var i=r(4848),o=r(8453);const c={id:"grpc",title:"gRPC",keywords:["Go","Kratos","Toolkit","Framework","Microservices","Protobuf","gRPC","HTTP"]},l=void 0,s={},d=[{value:"Server",id:"server",level:2},{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:3},{value:"<code>Network(network string) ServerOption </code>",id:"networknetwork-string-serveroption-",level:4},{value:"<code>Address(addr string) ServerOption</code>",id:"addressaddr-string-serveroption",level:4},{value:"<code>Timeout(timeout time.Duration) ServerOption</code>",id:"timeouttimeout-timeduration-serveroption",level:4},{value:"<code>Logger(logger log.Logger) ServerOption</code>",id:"loggerlogger-loglogger-serveroption",level:4},{value:"<code>Middleware(m ...middleware.Middleware) ServerOption</code>",id:"middlewarem-middlewaremiddleware-serveroption",level:4},{value:"<code>TLSConfig(c *tls.Config) ServerOption</code>",id:"tlsconfigc-tlsconfig-serveroption",level:4},{value:"<code>UnaryInterceptor(in ...grpc.UnaryServerInterceptor) ServerOption</code>",id:"unaryinterceptorin-grpcunaryserverinterceptor-serveroption",level:4},{value:"<code>StreamInterceptor(in ...grpc.StreamServerInterceptor) ServerOption</code>",id:"streaminterceptorin-grpcstreamserverinterceptor-serveroption",level:4},{value:"<code>Options(opts ...grpc.ServerOption) ServerOption</code>",id:"optionsopts-grpcserveroption-serveroption",level:4},{value:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282",id:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282",level:3},{value:"<code>NewServer()</code>",id:"newserver",level:4},{value:"<code>unaryServerInterceptor()</code>",id:"unaryserverinterceptor",level:4},{value:"\u4f7f\u7528\u65b9\u5f0f",id:"\u4f7f\u7528\u65b9\u5f0f",level:3},{value:"\u6ce8\u518c grpc server",id:"\u6ce8\u518c-grpc-server",level:4},{value:"grpc server \u4e2d\u4f7f\u7528 kratos middleware",id:"grpc-server-\u4e2d\u4f7f\u7528-kratos-middleware",level:4},{value:"middleware \u4e2d\u5904\u7406 grpc \u8bf7\u6c42",id:"middleware-\u4e2d\u5904\u7406-grpc-\u8bf7\u6c42",level:4},{value:"Client",id:"client",level:2},{value:"\u914d\u7f6e",id:"\u914d\u7f6e-1",level:3},{value:"<code>WithEndpoint(endpoint string) ClientOption</code>",id:"withendpointendpoint-string-clientoption",level:4},{value:"<code>WithTimeout(timeout time.Duration) ClientOption</code>",id:"withtimeouttimeout-timeduration-clientoption",level:4},{value:"<code>WithMiddleware(m ...middleware.Middleware) ClientOption</code>",id:"withmiddlewarem-middlewaremiddleware-clientoption",level:4},{value:"<code>WithDiscovery(d registry.Discovery) ClientOption</code>",id:"withdiscoveryd-registrydiscovery-clientoption",level:4},{value:"<code>WithTLSConfig(c *tls.Config) ClientOption</code>",id:"withtlsconfigc-tlsconfig-clientoption",level:4},{value:"<code>WithUnaryInterceptor(in ...grpc.UnaryClientInterceptor) ClientOption</code>",id:"withunaryinterceptorin-grpcunaryclientinterceptor-clientoption",level:4},{value:"<code>WithOptions(opts ...grpc.DialOption) ClientOption</code>",id:"withoptionsopts-grpcdialoption-clientoption",level:4},{value:"<code>WithHealthCheck(healthCheck bool) ClientOption</code>",id:"withhealthcheckhealthcheck-bool-clientoption",level:4},{value:"<code>WithNodeFilter(filters ...selector.NodeFilter) ClientOption</code>",id:"withnodefilterfilters-selectornodefilter-clientoption",level:4},{value:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282",id:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282-1",level:3},{value:"<code>dial()</code>",id:"dial",level:4},{value:"<code>unaryClientInterceptor()</code>",id:"unaryclientinterceptor",level:4},{value:"\u4f7f\u7528\u65b9\u5f0f",id:"\u4f7f\u7528\u65b9\u5f0f-1",level:3},{value:"\u521b\u5efa\u5ba2\u6237\u7aef\u8fde\u63a5",id:"\u521b\u5efa\u5ba2\u6237\u7aef\u8fde\u63a5",level:4},{value:"\u4f7f\u7528\u4e2d\u95f4\u4ef6",id:"\u4f7f\u7528\u4e2d\u95f4\u4ef6",level:4},{value:"\u4f7f\u7528\u670d\u52a1\u53d1\u73b0",id:"\u4f7f\u7528\u670d\u52a1\u53d1\u73b0",level:4},{value:"References",id:"references",level:2}];function p(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:["transporter/grpc \u4e2d\u57fa\u4e8e\u8c37\u6b4c\u7684 ",(0,i.jsx)(t.a,{href:"https://www.grpc.io/",children:"grpc"})," \u6846\u67b6\u5b9e\u73b0\u4e86",(0,i.jsx)(t.code,{children:"Transporter"}),"\uff0c\u7528\u4ee5\u6ce8\u518c grpc \u5230 ",(0,i.jsx)(t.code,{children:"kratos.Server()"})," \u4e2d\u3002"]}),"\n",(0,i.jsx)(t.h2,{id:"server",children:"Server"}),"\n",(0,i.jsx)(t.h3,{id:"\u914d\u7f6e",children:"\u914d\u7f6e"}),"\n",(0,i.jsx)(t.h4,{id:"networknetwork-string-serveroption-",children:(0,i.jsx)(t.code,{children:"Network(network string) ServerOption "})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u7684 network \u534f\u8bae\uff0c\u5982 tcp"}),"\n",(0,i.jsx)(t.h4,{id:"addressaddr-string-serveroption",children:(0,i.jsx)(t.code,{children:"Address(addr string) ServerOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u76d1\u542c\u7684\u5730\u5740"}),"\n",(0,i.jsx)(t.h4,{id:"timeouttimeout-timeduration-serveroption",children:(0,i.jsx)(t.code,{children:"Timeout(timeout time.Duration) ServerOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u7684\u8d85\u65f6\u8bbe\u7f6e"}),"\n",(0,i.jsx)(t.h4,{id:"loggerlogger-loglogger-serveroption",children:(0,i.jsx)(t.code,{children:"Logger(logger log.Logger) ServerOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u4f7f\u7528\u7684\u65e5\u5fd7\u7ec4\u4ef6"}),"\n",(0,i.jsx)(t.h4,{id:"middlewarem-middlewaremiddleware-serveroption",children:(0,i.jsx)(t.code,{children:"Middleware(m ...middleware.Middleware) ServerOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u7684 kratos \u4e2d\u95f4\u4ef6"}),"\n",(0,i.jsx)(t.h4,{id:"tlsconfigc-tlsconfig-serveroption",children:(0,i.jsx)(t.code,{children:"TLSConfig(c *tls.Config) ServerOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u7684 TLS \u914d\u7f6e"}),"\n",(0,i.jsx)(t.h4,{id:"unaryinterceptorin-grpcunaryserverinterceptor-serveroption",children:(0,i.jsx)(t.code,{children:"UnaryInterceptor(in ...grpc.UnaryServerInterceptor) ServerOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u4f7f\u7528\u7684 grpc \u5355\u5143\u62e6\u622a\u5668"}),"\n",(0,i.jsx)(t.h4,{id:"streaminterceptorin-grpcstreamserverinterceptor-serveroption",children:(0,i.jsx)(t.code,{children:"StreamInterceptor(in ...grpc.StreamServerInterceptor) ServerOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u670d\u52a1\u7aef\u4f7f\u7528\u7684 grpc \u6d41\u5a92\u4f53\u62e6\u622a\u5668"}),"\n",(0,i.jsx)(t.h4,{id:"optionsopts-grpcserveroption-serveroption",children:(0,i.jsx)(t.code,{children:"Options(opts ...grpc.ServerOption) ServerOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u4e00\u4e9b\u989d\u5916\u7684 grpc.ServerOption"}),"\n",(0,i.jsx)(t.h3,{id:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282",children:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282"}),"\n",(0,i.jsx)(t.h4,{id:"newserver",children:(0,i.jsx)(t.code,{children:"NewServer()"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'func NewServer(opts ...ServerOption) *Server {\n  \t// grpc server \u9ed8\u8ba4\u914d\u7f6e\n\tsrv := &Server{\n\t\tnetwork: "tcp",\n\t\taddress: ":0",\n\t\ttimeout: 1 * time.Second,\n\t\thealth:  health.NewServer(),\n\t\tlog:     log.NewHelper(log.GetLogger()),\n\t}\n  \t// \u9012\u5f52 opts\n\tfor _, o := range opts {\n\t\to(srv)\n\t}\n  \t// kratos middleware \u8f6c\u6362\u6210 grpc \u62e6\u622a\u5668\uff0c\u5e76\u5904\u7406\u4e00\u4e9b\u7ec6\u8282\n\tunaryInts := []grpc.UnaryServerInterceptor{\n\t\tsrv.unaryServerInterceptor(),\n\t}\n\tstreamInts := []grpc.StreamServerInterceptor{\n\t\tsrv.streamServerInterceptor(),\n\t}\n\n\tif len(srv.unaryInts) > 0 {\n\t\tunaryInts = append(unaryInts, srv.unaryInts...)\n\t}\n\tif len(srv.streamInts) > 0 {\n\t\tstreamInts = append(streamInts, srv.streamInts...)\n\t}\n\n  \t// \u5c06 UnaryInterceptor \u548c StreamInterceptor \u8f6c\u6362\u6210 ServerOption\n\tvar grpcOpts = []grpc.ServerOption{\n\t\tgrpc.ChainUnaryInterceptor(unaryInts...),\n\t\tgrpc.ChainStreamInterceptor(streamInts...),\n\t}\n\t// \u5c06 TLS \u914d\u7f6e\u8f6c\u5316\u6210 ServerOption\n\tif srv.tlsConf != nil {\n\t\tgrpcOpts = append(grpcOpts, grpc.Creds(credentials.NewTLS(srv.tlsConf)))\n\t}\n\t// \u8ffd\u52a0\u901a\u8fc7 Options(opts ...grpc.ServerOption) \u6dfb\u52a0\u7684options\n\tif len(srv.grpcOpts) > 0 {\n\t\tgrpcOpts = append(grpcOpts, srv.grpcOpts...)\n\t}\n  \t// \u521b\u5efa grpc server\n\tsrv.Server = grpc.NewServer(grpcOpts...)\n  \t// \u521b\u5efa metadata server\n\tsrv.metadata = apimd.NewServer(srv.Server)\n\t// \u914d\u7f6e lis \u548c endpoint\n\tsrv.err = srv.listenAndEndpoint()\n  \t// \u5185\u90e8\u6ce8\u518c\n\tgrpc_health_v1.RegisterHealthServer(srv.Server, srv.health)\n\tapimd.RegisterMetadataServer(srv.Server, srv.metadata)\n\treflection.Register(srv.Server)\n\treturn srv\n}\n'})}),"\n",(0,i.jsx)(t.h4,{id:"unaryserverinterceptor",children:(0,i.jsx)(t.code,{children:"unaryServerInterceptor()"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:"func (s *Server) unaryServerInterceptor() grpc.UnaryServerInterceptor {\n\treturn func(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (interface{}, error) {\n    \t// \u628a\u4e24\u4e2a ctx \u5408\u5e76\u6210\u4e00\u4e2a\n\t\tctx, cancel := ic.Merge(ctx, s.ctx)\n\t\tdefer cancel()\n    \t// \u4ece ctx \u4e2d\u53d6\u51fa metadata\n\t\tmd, _ := grpcmd.FromIncomingContext(ctx)\n    \t// \u628a\u4e00\u4e9b\u4fe1\u606f\u7ed1\u5b9a\u5230 ctx \u4e0a\n\t\treplyHeader := grpcmd.MD{}\n\t\tctx = transport.NewServerContext(ctx, &Transport{\n\t\t\tendpoint:    s.endpoint.String(),\n\t\t\toperation:   info.FullMethod,\n\t\t\treqHeader:   headerCarrier(md),\n\t\t\treplyHeader: headerCarrier(replyHeader),\n\t\t})\n    \t// ctx \u8d85\u65f6\u8bbe\u7f6e\n\t\tif s.timeout > 0 {\n\t\t\tctx, cancel = context.WithTimeout(ctx, s.timeout)\n\t\t\tdefer cancel()\n\t\t}\n    \t// \u4e2d\u95f4\u4ef6\u5904\u7406\n\t\th := func(ctx context.Context, req interface{}) (interface{}, error) {\n\t\t\treturn handler(ctx, req)\n\t\t}\n\t\tif len(s.middleware) > 0 {\n\t\t\th = middleware.Chain(s.middleware...)(h)\n\t\t}\n\t\t// \u6267\u884c\u4e2d\u95f4\u4ef6 handler\n\t\treply, err := h(ctx, req)\n\t\tif len(replyHeader) > 0 {\n\t\t\t_ = grpc.SetHeader(ctx, replyHeader)\n\t\t}\n\t\treturn reply, err\n\t}\n}\n"})}),"\n",(0,i.jsx)(t.h3,{id:"\u4f7f\u7528\u65b9\u5f0f",children:"\u4f7f\u7528\u65b9\u5f0f"}),"\n",(0,i.jsx)(t.p,{children:"\u7b80\u5355\u5217\u4e3e\u4e86\u4e00\u4e9b kratos \u4e2d grpc \u7684\u7528\u6cd5\uff0c\u5176\u4ed6 grpc \u7528\u6cd5\u53ef\u4ee5\u5230 grpc \u4ed3\u5e93\u4e2d\u67e5\u770b\u3002"}),"\n",(0,i.jsx)(t.h4,{id:"\u6ce8\u518c-grpc-server",children:"\u6ce8\u518c grpc server"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'gs := grpc.NewServer()\napp := kratos.New(\n\tkratos.Name("kratos"),\n\tkratos.Version("v1.0.0"),\n\tkratos.Server(gs),\n)\n'})}),"\n",(0,i.jsx)(t.h4,{id:"grpc-server-\u4e2d\u4f7f\u7528-kratos-middleware",children:"grpc server \u4e2d\u4f7f\u7528 kratos middleware"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'grpcSrv := grpc.NewServer(\n\tgrpc.Address(":9000"),\n\tgrpc.Middleware(\n\t\tlogging.Server(),\n\t),\n)\n'})}),"\n",(0,i.jsx)(t.h4,{id:"middleware-\u4e2d\u5904\u7406-grpc-\u8bf7\u6c42",children:"middleware \u4e2d\u5904\u7406 grpc \u8bf7\u6c42"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:"if info, ok := transport.FromServerContext(ctx); ok {\n  kind = info.Kind().String()\n  operation = info.Operation()\n}\n"})}),"\n",(0,i.jsx)(t.h2,{id:"client",children:"Client"}),"\n",(0,i.jsx)(t.h3,{id:"\u914d\u7f6e-1",children:"\u914d\u7f6e"}),"\n",(0,i.jsx)(t.h4,{id:"withendpointendpoint-string-clientoption",children:(0,i.jsx)(t.code,{children:"WithEndpoint(endpoint string) ClientOption"})}),"\n",(0,i.jsxs)(t.p,{children:["\u914d\u7f6e\u5ba2\u6237\u7aef\u4f7f\u7528\u7684\u5bf9\u7aef\u8fde\u63a5\u5730\u5740\uff0c\u5982\u679c\u4e0d\u4f7f\u7528\u670d\u52a1\u53d1\u73b0\u5219\u4e3aip",":port",",\u5982\u679c\u4f7f\u7528\u670d\u52a1\u53d1\u73b0\u5219\u683c\u5f0f\u4e3adiscovery://<authority>/<serviceName>"]}),"\n",(0,i.jsx)(t.h4,{id:"withtimeouttimeout-timeduration-clientoption",children:(0,i.jsx)(t.code,{children:"WithTimeout(timeout time.Duration) ClientOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u9ed8\u8ba4\u8d85\u65f6\u65f6\u95f4\uff0c\u5982\u679c\u6709\u94fe\u8def\u8d85\u65f6\u4f18\u5148\u4f7f\u7528\u94fe\u8def\u8d85\u65f6\u65f6\u95f4"}),"\n",(0,i.jsx)(t.h4,{id:"withmiddlewarem-middlewaremiddleware-clientoption",children:(0,i.jsx)(t.code,{children:"WithMiddleware(m ...middleware.Middleware) ClientOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u4f7f\u7528\u7684 kratos \u4e2d\u95f4\u4ef6"}),"\n",(0,i.jsx)(t.h4,{id:"withdiscoveryd-registrydiscovery-clientoption",children:(0,i.jsx)(t.code,{children:"WithDiscovery(d registry.Discovery) ClientOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u4f7f\u7528\u7684\u670d\u52a1\u53d1\u73b0"}),"\n",(0,i.jsx)(t.h4,{id:"withtlsconfigc-tlsconfig-clientoption",children:(0,i.jsx)(t.code,{children:"WithTLSConfig(c *tls.Config) ClientOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u4f7f\u7528\u7684 TLS \u914d\u7f6e"}),"\n",(0,i.jsx)(t.h4,{id:"withunaryinterceptorin-grpcunaryclientinterceptor-clientoption",children:(0,i.jsx)(t.code,{children:"WithUnaryInterceptor(in ...grpc.UnaryClientInterceptor) ClientOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u5ba2\u6237\u7aef\u4f7f\u7528\u7684 grpc \u539f\u751f\u62e6\u622a\u5668"}),"\n",(0,i.jsx)(t.h4,{id:"withoptionsopts-grpcdialoption-clientoption",children:(0,i.jsx)(t.code,{children:"WithOptions(opts ...grpc.DialOption) ClientOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u4e00\u4e9b\u989d\u5916\u7684 grpc.ClientOption"}),"\n",(0,i.jsx)(t.h4,{id:"withhealthcheckhealthcheck-bool-clientoption",children:(0,i.jsx)(t.code,{children:"WithHealthCheck(healthCheck bool) ClientOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u662f\u5426\u5f00\u542f\u5065\u5eb7\u68c0\u67e5"}),"\n",(0,i.jsx)(t.h4,{id:"withnodefilterfilters-selectornodefilter-clientoption",children:(0,i.jsx)(t.code,{children:"WithNodeFilter(filters ...selector.NodeFilter) ClientOption"})}),"\n",(0,i.jsx)(t.p,{children:"\u914d\u7f6e\u8fc7\u6ee4\u67d0\u4e9b\u4e0d\u5e0c\u671b\u88ab\u8bf7\u6c42\u7684\u8282\u70b9"}),"\n",(0,i.jsx)(t.h3,{id:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282-1",children:"\u4e3b\u8981\u7684\u5b9e\u73b0\u7ec6\u8282"}),"\n",(0,i.jsx)(t.h4,{id:"dial",children:(0,i.jsx)(t.code,{children:"dial()"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'func dial(ctx context.Context, insecure bool, opts ...ClientOption) (*grpc.ClientConn, error) {\n\t// \u9ed8\u8ba4\u914d\u7f6e\n\toptions := clientOptions{\n\t\ttimeout:      2000 * time.Millisecond,\n\t\tbalancerName: wrr.Name,\n\t\tlogger:       log.GetLogger(),\n\t}\n\t// \u904d\u5386 opts\n\tfor _, o := range opts {\n\t\to(&options)\n\t}\n\t// \u5c06 kratos \u4e2d\u95f4\u4ef6\u8f6c\u5316\u6210 grpc \u62e6\u622a\u5668\n\tints := []grpc.UnaryClientInterceptor{\n\t\tunaryClientInterceptor(options.middleware, options.timeout, options.filters),\n\t}\n\tif len(options.ints) > 0 {\n\t\tints = append(ints, options.ints...)\n\t}\n\t// \u8d1f\u8f7d\u5747\u8861\n\tgrpcOpts := []grpc.DialOption{\n\t\tgrpc.WithDefaultServiceConfig(fmt.Sprintf(`{"LoadBalancingPolicy": "%s"}`, options.balancerName)),\n\t\tgrpc.WithChainUnaryInterceptor(ints...),\n\t}\n\tif options.discovery != nil {\n    \t// \u5982\u679c\u5b58\u5728\u670d\u52a1\u53d1\u73b0\u914d\u7f6e\uff0c\u5c31\u914d\u7f6e grpc \u7684 Resolvers\n\t\tgrpcOpts = append(grpcOpts,\n\t\t\tgrpc.WithResolvers(\n\t\t\t\tdiscovery.NewBuilder(\n\t\t\t\t\toptions.discovery,\n\t\t\t\t\tdiscovery.WithInsecure(insecure),\n\t\t\t\t\tdiscovery.WithLogger(options.logger),\n\t\t\t\t)))\n\t}\n\tif insecure {\n    \t// \u8df3\u8fc7\u8bc1\u4e66\u9a8c\u8bc1\n\t\tgrpcOpts = append(grpcOpts, grpc.WithTransportCredentials(grpcinsecure.NewCredentials()))\n\t}\n\t// TLS \u914d\u7f6e\n\tif options.tlsConf != nil {\n\t\tgrpcOpts = append(grpcOpts, grpc.WithTransportCredentials(credentials.NewTLS(options.tlsConf)))\n\t}\n\tif len(options.grpcOpts) > 0 {\n\t\tgrpcOpts = append(grpcOpts, options.grpcOpts...)\n\t}\n\treturn grpc.DialContext(ctx, options.endpoint, grpcOpts...)\n}\n'})}),"\n",(0,i.jsx)(t.h4,{id:"unaryclientinterceptor",children:(0,i.jsx)(t.code,{children:"unaryClientInterceptor()"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:"func unaryClientInterceptor(ms []middleware.Middleware, timeout time.Duration) grpc.UnaryClientInterceptor {\n\treturn func(ctx context.Context, method string, req, reply interface{}, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption) error {\n    \t// \u628a\u4e00\u4e9b\u4fe1\u606f\u7ed1\u5b9a\u5230 ctx \u4e0a\n\t\tctx = transport.NewClientContext(ctx, &Transport{\n\t\t\tendpoint:  cc.Target(),\n\t\t\toperation: method,\n\t\t\treqHeader: headerCarrier{},\n\t\t\tfilters:   filters,\n\t\t})\n\t\tif timeout > 0 {\n      \t\t// timeout \u5982\u679c\u5927\u4e8e 0\uff0c\u5c31\u91cd\u65b0\u8bbe\u7f6e\u4e00\u4e0b ctx \u7684\u8d85\u65f6\u65f6\u95f4\n\t\t\tvar cancel context.CancelFunc\n\t\t\tctx, cancel = context.WithTimeout(ctx, timeout)\n\t\t\tdefer cancel()\n\t\t}\n    \t// \u4e2d\u95f4\u4ef6\u5904\u7406\n\t\th := func(ctx context.Context, req interface{}) (interface{}, error) {\n\t\t\tif tr, ok := transport.FromClientContext(ctx); ok {\n\t\t\t\theader := tr.RequestHeader()\n\t\t\t\tkeys := header.Keys()\n\t\t\t\tkeyvals := make([]string, 0, len(keys))\n\t\t\t\tfor _, k := range keys {\n\t\t\t\t\tkeyvals = append(keyvals, k, header.Get(k))\n\t\t\t\t}\n\t\t\t\tctx = grpcmd.AppendToOutgoingContext(ctx, keyvals...)\n\t\t\t}\n\t\t\treturn reply, invoker(ctx, method, req, reply, cc, opts...)\n\t\t}\n\t\tif len(ms) > 0 {\n\t\t\th = middleware.Chain(ms...)(h)\n\t\t}\n\t\t_, err := h(ctx, req)\n\t\treturn err\n\t}\n}\n"})}),"\n",(0,i.jsx)(t.h3,{id:"\u4f7f\u7528\u65b9\u5f0f-1",children:"\u4f7f\u7528\u65b9\u5f0f"}),"\n",(0,i.jsx)(t.h4,{id:"\u521b\u5efa\u5ba2\u6237\u7aef\u8fde\u63a5",children:"\u521b\u5efa\u5ba2\u6237\u7aef\u8fde\u63a5"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'conn, err := grpc.DialInsecure(\n\t\tcontext.Background(),\n\t\tgrpc.WithEndpoint("127.0.0.1:9000"),\n\t)\n'})}),"\n",(0,i.jsx)(t.h4,{id:"\u4f7f\u7528\u4e2d\u95f4\u4ef6",children:"\u4f7f\u7528\u4e2d\u95f4\u4ef6"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'conn, err := grpc.DialInsecure(\n\tcontext.Background(),\n\tgrpc.WithEndpoint("127.0.0.1:9000"),\n\tgrpc.WithTimeout(3600 * time.Second),\n  \tgrpc.WithMiddleware(\n\t\t  recovery.Recovery(),\n\t\t  validate.Validator(),\n\t),\n)\n'})}),"\n",(0,i.jsx)(t.h4,{id:"\u4f7f\u7528\u670d\u52a1\u53d1\u73b0",children:"\u4f7f\u7528\u670d\u52a1\u53d1\u73b0"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'conn, err := grpc.DialInsecure(\n\tcontext.Background(),\n\tgrpc.WithEndpoint("discovery:///helloworld"),\n\tgrpc.WithDiscovery(r),\n)\n'})}),"\n",(0,i.jsx)(t.h2,{id:"references",children:"References"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://www.grpc.io/",children:"https://www.grpc.io/"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://www.grpc.io/docs/languages/go/quickstart/",children:"https://www.grpc.io/docs/languages/go/quickstart/"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://github.com/grpc/grpc-go",children:"https://github.com/grpc/grpc-go"})}),"\n"]})]})}function a(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}},8453:(e,t,r)=>{r.d(t,{R:()=>c,x:()=>l});var n=r(6540);const i={},o=n.createContext(i);function c(e){const t=n.useContext(o);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),n.createElement(o.Provider,{value:t},e.children)}}}]);