<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://go-kratos.dev/en/blog</id>
    <title>Kratos Blog</title>
    <updated>2021-07-14T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://go-kratos.dev/en/blog"/>
    <subtitle>Kratos Blog</subtitle>
    <icon>https://go-kratos.dev/en/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Goå·¥ç¨‹åŒ– - ä¾èµ–æ³¨å…¥]]></title>
        <id>go-project-wire</id>
        <link href="https://go-kratos.dev/en/blog/go-project-wire"/>
        <updated>2021-07-14T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[wireä¹çœ‹èµ·æ¥æ¯”è¾ƒè¿åç›´è§‰ï¼Œå¯¼è‡´å¾ˆå¤šåŒå­¦ä¸ç†è§£ä¸ºä»€ä¹ˆè¦ç”¨æˆ–ä¸æ¸…æ¥šå¦‚ä½•ç”¨ï¼ˆä¹ŸåŒ…æ‹¬æ›¾ç»çš„æˆ‘ï¼‰ï¼Œæœ¬æ–‡æ¥å¸®åŠ©å¤§å®¶ç†è§£wireçš„ä½¿ç”¨ã€‚]]></summary>
        <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨å¾®æœåŠ¡æ¡†æ¶<a href="https://github.com/go-kratos/kratos">kratos v2</a>çš„é»˜è®¤é¡¹ç›®æ¨¡æ¿ä¸­<a href="https://github.com/go-kratos/kratos-layout">kratos-layout</a>ä½¿ç”¨äº†<a href="https://github.com/google/wire">google/wire</a>è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œä¹Ÿå»ºè®®å¼€å‘è€…åœ¨ç»´æŠ¤é¡¹ç›®æ—¶ä½¿ç”¨è¯¥å·¥å…·ã€‚</p><p>wire ä¹çœ‹èµ·æ¥æ¯”è¾ƒè¿åç›´è§‰ï¼Œå¯¼è‡´å¾ˆå¤šåŒå­¦ä¸ç†è§£ä¸ºä»€ä¹ˆè¦ç”¨æˆ–ä¸æ¸…æ¥šå¦‚ä½•ç”¨ï¼ˆä¹ŸåŒ…æ‹¬æ›¾ç»çš„æˆ‘ï¼‰ï¼Œæœ¬æ–‡æ¥å¸®åŠ©å¤§å®¶ç†è§£ wire çš„ä½¿ç”¨ã€‚</p><h2>What</h2><p><a href="https://github.com/google/wire">wire</a>æ˜¯ç”± google å¼€æºçš„ä¸€ä¸ªä¾› Go è¯­è¨€ä½¿ç”¨çš„ä¾èµ–æ³¨å…¥ä»£ç ç”Ÿæˆå·¥å…·ã€‚å®ƒèƒ½å¤Ÿæ ¹æ®ä½ çš„ä»£ç ï¼Œç”Ÿæˆç›¸åº”çš„ä¾èµ–æ³¨å…¥ go ä»£ç ã€‚</p><p>è€Œä¸å…¶å®ƒä¾é åå°„å®ç°çš„ä¾èµ–æ³¨å…¥å·¥å…·ä¸åŒçš„æ˜¯ï¼Œwire èƒ½åœ¨ç¼–è¯‘æœŸï¼ˆå‡†ç¡®åœ°è¯´æ˜¯ä»£ç ç”Ÿæˆæ—¶ï¼‰å¦‚æœä¾èµ–æ³¨å…¥æœ‰é—®é¢˜ï¼Œåœ¨ä»£ç ç”Ÿæˆæ—¶å³å¯æŠ¥å‡ºæ¥ï¼Œä¸ä¼šæ‹–åˆ°è¿è¡Œæ—¶æ‰æŠ¥ï¼Œæ›´ä¾¿äº debugã€‚</p><h2>Why</h2><h3>ç†è§£ä¾èµ–æ³¨å…¥</h3><p>ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿä¸ºä»€ä¹ˆè¦ä¾èµ–æ³¨å…¥ï¼Ÿ
<del>ä¾èµ–æ³¨å…¥å°±æ˜¯ Java é—æ¯’</del>ï¼ˆä¸æ˜¯ï¼‰</p><p><a href="https://zh.wikipedia.org/wiki/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5">ä¾èµ–æ³¨å…¥</a> (Dependency Injectionï¼Œç¼©å†™ä¸º DI)ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ç§ä»£ç çš„æ„é€ æ¨¡å¼ï¼ˆå°±æ˜¯å†™æ³•ï¼‰ï¼ŒæŒ‰ç…§è¿™æ ·çš„æ–¹å¼æ¥å†™ï¼Œèƒ½å¤Ÿè®©ä½ çš„ä»£ç æ›´åŠ å®¹æ˜“ç»´æŠ¤ã€‚</p><p>å¯¹äºå¾ˆå¤šè½¯ä»¶è®¾è®¡æ¨¡å¼å’Œæ¶æ„çš„ç†å¿µï¼Œæˆ‘ä»¬éƒ½æ— æ³•ç†è§£ä»–ä»¬è¦ç»•å¥½å¤§ä¸€åœˆåšå¤æ‚çš„ä½“æ“ã€ç”¨å¥‡æ€ªçš„æ–¹å¼è¿›è¡Œå®ç°çš„æ„ä¹‰ã€‚ä»–ä»¬é€šå¸¸éƒ½åªæ˜¯ä¸¢å‡ºæ¥ä¸€æ®µæ ·ä¾‹ï¼Œè¯´è¿™æ ·å†™å°±å¾ˆå¥½å¾ˆä¼˜é›…ï¼Œç”±äºçœç•¥æ‰äº†è¿™ç§æ¨¡å¼æ˜¯å¦‚ä½•å‘å±•å‡ºæ¥çš„æ¨å¯¼è¿‡ç¨‹ï¼Œæˆ‘ä»¬åªçœ‹åˆ°äº†ç»“æœï¼Œå¯¼è‡´ç†è§£èµ·æ¥å¾ˆå›°éš¾ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å°è¯•æ¨å¯¼è¿˜åŸä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼Œçœ‹çœ‹ä»£ç æ˜¯å¦‚ä½•å’Œä¸ºä»€ä¹ˆæ¼”è¿›åˆ°ä¾èµ–æ³¨å…¥æ¨¡å¼çš„ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ›´å¥½ç†è§£ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æ„ä¹‰ã€‚</p><h4>ä¾èµ–æ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>è¿™é‡Œçš„ä¾èµ–æ˜¯ä¸ªåè¯ï¼Œä¸æ˜¯æŒ‡è½¯ä»¶åŒ…çš„ä¾èµ–ï¼ˆæ¯”å¦‚é‚£å¨å¡åœ¨ node_modules é‡Œé¢çš„ä¸œè¥¿ï¼‰ï¼Œè€Œæ˜¯æŒ‡è½¯ä»¶ä¸­æŸä¸€ä¸ªæ¨¡å—ï¼ˆå¯¹è±¡/å®ä¾‹ï¼‰æ‰€ä¾èµ–çš„å…¶å®ƒå¤–éƒ¨æ¨¡å—ï¼ˆå¯¹è±¡/å®ä¾‹ï¼‰ã€‚</p><h4>æ³¨å…¥åˆ°å“ªé‡Œï¼Ÿ</h4><p>è¢«ä¾èµ–çš„æ¨¡å—ï¼Œåœ¨åˆ›å»ºæ¨¡å—æ—¶ï¼Œè¢«æ³¨å…¥åˆ°ï¼ˆå³å½“ä½œå‚æ•°ä¼ å…¥ï¼‰æ¨¡å—çš„é‡Œé¢ã€‚</p><h4>ä¸ DI æ˜¯å•¥æ ·ï¼ŸDI äº†åˆæ ·å­ï¼Ÿ</h4><p>ä¸‹é¢ç”¨ go ä¼ªä»£ç æ¥åšä¾‹å­ï¼Œé¢†ä¼šç²¾ç¥å³å¯ã€‚</p><p>å‡è®¾ä¸ªåœºæ™¯ï¼Œä½ åœ¨æ‰“å·¥æä¸€ä¸ª web åº”ç”¨ï¼Œå®ƒæœ‰ä¸€ä¸ªç®€å•æ¥å£ã€‚æœ€å¼€å§‹çš„é¡¹ç›®ä»£ç å¯èƒ½é•¿è¿™ä¸ªæ ·å­ï¼š</p><pre><code class="language-go"># ä¸‹é¢ä¸ºä¼ªä»£ç ï¼Œå¿½ç•¥äº†å¾ˆå¤šä¸ä¸»é¢˜æ— å…³çš„ç»†èŠ‚

type App struct {
}

# å‡è®¾è¿™ä¸ªæ–¹æ³•å°†ä¼šåŒ¹é…å¹¶å¤„ç† GET /biu/&lt;id&gt; è¿™æ ·çš„è¯·æ±‚
func (a *App) GetData(id string) string {
    # todo: write your data query
    return &quot;some data&quot;
}

func NewApp() *App {
    return &amp;App{}
}

app := App()
app.Run()
</code></pre><p>ä½ è¦åšçš„æ˜¯æ¥ä¸€ä¸ª mysqlï¼Œä»é‡Œé¢æŠŠæ•°æ®æŒ‰ç…§ id æŸ¥å‡ºæ¥ï¼Œè¿”å›ã€‚
è¦è¿ mysql çš„è¯ï¼Œå‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†ä¸ª<code>NewMySQLClient</code>çš„æ–¹æ³•è¿”å› client ç»™ä½ ï¼Œåˆå§‹åŒ–æ—¶ä¼ ä¸ªåœ°å€è¿›å»å°±èƒ½æ‹¿åˆ°æ•°æ®åº“è¿æ¥ï¼Œå¹¶å‡è®¾å®ƒæœ‰ä¸ª<code>Exec</code>çš„æ–¹æ³•ç»™ä½ æ‰§è¡Œå‚æ•°ã€‚</p><h5>ä¸ç”¨ DIï¼Œé€šè¿‡å…¨å±€å˜é‡ä¼ é€’ä¾èµ–å®ä¾‹</h5><p>ä¸€ç§å†™æ³•æ˜¯ï¼Œåœ¨å¤–é¢å…¨å±€åˆå§‹åŒ–å¥½ clientï¼Œç„¶å App ç›´æ¥æ‹¿æ¥è°ƒç”¨ã€‚</p><pre><code class="language-go">
var mysqlUrl = &quot;mysql://blabla&quot;
var db = NewMySQLClient(mysqlUrl)


type App struct {

}

func (a *App) GetData(id string) string {
    data := db.Exec(&quot;select data from biu where id = ? limit 1&quot;, id)
    return data
}


func NewApp() *App {
    return &amp;App{}
}
func main() {
    app := App()
    app.Run()
}
</code></pre><p>è¿™å°±æ˜¯æ²¡ç”¨ä¾èµ–æ³¨å…¥ï¼Œapp ä¾èµ–äº†å…¨å±€å˜é‡ dbï¼Œè¿™æ˜¯æ¯”è¾ƒç³Ÿç³•çš„ä¸€ç§åšæ³•ã€‚db è¿™ä¸ªå¯¹è±¡æ¸¸ç¦»åœ¨å…¨å±€ä½œç”¨åŸŸï¼Œæš´éœ²ç»™åŒ…ä¸‹çš„å…¶ä»–æ¨¡å—ï¼Œæ¯”è¾ƒå±é™©ã€‚ï¼ˆè®¾æƒ³å¦‚æœè¿™ä¸ªåŒ…é‡Œå…¶ä»–ä»£ç åœ¨è¿è¡Œæ—¶æ‚„æ‚„æŠŠä½ çš„è¿™ä¸ª db å˜é‡æ›¿æ¢æ‰ä¼šå‘ç”Ÿå•¥ï¼‰</p><h5>ä¸ç”¨ DIï¼Œåœ¨ App çš„åˆå§‹åŒ–æ–¹æ³•é‡Œåˆ›å»ºä¾èµ–å®ä¾‹</h5><p>å¦ä¸€ç§æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š</p><pre><code class="language-go">type App struct {
    db *MySQLClient
}

func (a *App) GetData(id string) string {
    data := a.db.Exec(&quot;select data from biu where id = ? limit 1&quot;, id)
    return data
}


func NewApp() *App {
    return &amp;App{db: NewMySQLClient(mysqlUrl)}
}
func main() {
    app := NewApp(&quot;mysql://blabla&quot;)
    app.Run()
}
</code></pre><p>è¿™ç§æ–¹æ³•ç¨å¾®å¥½ä¸€äº›ï¼Œdb è¢«å¡åˆ° app é‡Œé¢äº†ï¼Œä¸ä¼šæœ‰ app ä¹‹å¤–çš„æ— å…³ä»£ç ç¢°å®ƒï¼Œæ¯”è¾ƒå®‰å…¨ï¼Œä½†è¿™ä¾ç„¶ä¸æ˜¯ä¾èµ–æ³¨å…¥ï¼Œè€Œæ˜¯åœ¨å†…éƒ¨åˆ›å»ºäº†ä¾èµ–ï¼Œæ¥ä¸‹æ¥ä½ ä¼šçœ‹åˆ°å®ƒå¸¦æ¥çš„é—®é¢˜ã€‚</p><h5>è€æ¿ï¼šæˆ‘ä»¬çš„æ•°æ®è¦æ¢ä¸ªåœ°æ–¹å­˜ ï¼ˆéœ€è¦å˜æ›´å®ç°ï¼‰</h5><p>ä½ çš„è€æ¿ä¸çŸ¥é“ä»å“ªå¬è¯´â€”â€”Redis è´¼ç‰¹ä¹ˆå¿«ï¼Œè¦ä¸æˆ‘ä»¬çš„æ•°æ®æ”¹ä» Redis é‡Œè¯»å§ã€‚è¿™ä¸ªæ—¶å€™ä½ çš„å†…å¿ƒæœ‰ç‚¹å´©æºƒï¼Œä½†æ¯•ç«Ÿè¦æ°é¥­çš„ï¼Œå°±ç¡¬ç€å¤´çš®æ”¹ä¸Šé¢çš„ä»£ç ã€‚</p><pre><code class="language-go">type App struct {
    ds *RedisClient
}

func (a *App) GetData(id string) string {
    data := a.ds.Do(&quot;GET&quot;, &quot;biu_&quot;+id)
    return data
}


func NewApp() *App {
    return &amp;App{ds: NewRedisClient(redisAddr)}
}

func main() {
    app := NewApp(&quot;redis://ooo&quot;)
    app.Run()
}
</code></pre><p>ä¸Šé¢åŸºæœ¬è¿›è¡Œäº† 3 å¤„ä¿®æ”¹ï¼š</p><ol><li>App åˆå§‹åŒ–æ–¹æ³•é‡Œæ”¹æˆäº†åˆå§‹åŒ– RedisClient</li><li>get_data é‡Œå–æ•°æ®æ—¶æ”¹ç”¨ run æ–¹æ³•ï¼Œå¹¶ä¸”æŸ¥è¯¢è¯­å¥ä¹Ÿæ¢äº†</li><li>App å®ä¾‹åŒ–æ—¶ä¼ å…¥çš„å‚æ•°æ”¹æˆäº† redis åœ°å€</li></ol><h5>è€æ¿ï¼šè¦ä¸ï¼Œæˆ‘ä»¬å†æ¢ä¸ªåœ°æ–¹å­˜ï¼Ÿ/æˆ‘ä»¬è¦åŠ æµ‹è¯•ï¼Œéœ€è¦ Mock</h5><p>è€æ¿çš„æ€è·¯æ€»æ˜¯å¾ˆå¹¿çš„ï¼Œåˆè¿‡äº†ä¸¤å¤©ä»–åˆæƒ³æ¢æˆ Postgres å­˜äº†ï¼›æˆ–è€…è®©ä½ ä»¬ç»™ App å†™ç‚¹æµ‹è¯•ä»£ç ï¼Œåªæµ‹æ¥å£é‡Œé¢çš„é€»è¾‘ï¼Œé€šå¸¸æˆ‘ä»¬ä¸å¤ªæ„¿æ„åœ¨æ—è¾¹å†èµ·ä¸€ä¸ªæ•°æ®åº“ï¼Œé‚£ä¹ˆå°±éœ€è¦ mock æ‰æ•°æ®æºè¿™å—ä¸œè¥¿ï¼Œè®©å®ƒç›´æ¥è¿”å›æ•°æ®ç»™è¯·æ±‚çš„ handler ç”¨ï¼Œæ¥è¿›è¡Œé’ˆå¯¹æ€§çš„æµ‹è¯•ã€‚</p><p>è¿™ç§æƒ…å†µæ€ä¹ˆåŠï¼Ÿå†æ”¹é‡Œé¢çš„ä»£ç ï¼Ÿè¿™ä¸ç§‘å­¦ã€‚</p><h5>é¢å‘æ¥å£ç¼–ç¨‹</h5><p>ä¸€ä¸ªå¾ˆé‡è¦çš„æ€è·¯å°±æ˜¯è¦<strong>é¢å‘æ¥å£(interface)ç¼–ç¨‹</strong>ï¼Œè€Œä¸æ˜¯é¢å‘å…·ä½“å®ç°ç¼–ç¨‹ã€‚</p><p>ä»€ä¹ˆå«é¢å‘å…·ä½“å®ç°ç¼–ç¨‹å‘¢ï¼Ÿæ¯”å¦‚ä¸Šè¿°çš„ä¾‹å­é‡Œæ”¹åŠ¨çš„éƒ¨åˆ†ï¼šè°ƒ mysqlclient çš„ exec_sql æ‰§è¡Œä¸€æ¡ sqlï¼Œè¢«æ”¹æˆäº†ï¼šè°ƒ redisclient çš„ do æ‰§è¡Œä¸€å¥ get æŒ‡ä»¤ã€‚ç”±äºæ¯ç§ client çš„æ¥å£è®¾è®¡ä¸åŒï¼Œæ¯æ¢ä¸€ä¸ªå®ç°ï¼Œå°±å¾—æ”¹ä¸€éã€‚</p><p>è€Œé¢å‘æ¥å£ç¼–ç¨‹çš„æ€è·¯ï¼Œåˆ™å®Œå…¨ä¸åŒã€‚æˆ‘ä»¬ä¸è¦å¬è€æ¿æƒ³ç”¨å•¥å°±é©¬ä¸Šå†™ä»£ç ã€‚é¦–å…ˆå°±å¾—é¢„æ–™åˆ°ï¼Œè¿™ä¸ªæ•°æ®æºçš„å®ç°å¾ˆæœ‰å¯èƒ½è¢«æ›´æ¢ï¼Œå› æ­¤åœ¨ä¸€å¼€å§‹å°±åº”è¯¥åšå¥½å‡†å¤‡ï¼ˆè®¾è®¡ï¼‰ã€‚</p><h6>è®¾è®¡æ¥å£</h6><p>Python é‡Œé¢æœ‰ä¸ªæ¦‚å¿µå«é¸­å­ç±»å‹(duck-typing)ï¼Œå°±æ˜¯å¦‚æœä½ å«èµ·æ¥åƒé¸­å­ï¼Œèµ°è·¯åƒé¸­å­ï¼Œæ¸¸æ³³åƒé¸­å­ï¼Œé‚£ä¹ˆä½ å°±æ˜¯ä¸€åªé¸­å­ã€‚è¿™é‡Œçš„å«ã€èµ°è·¯ã€æ¸¸æ³³å°±æ˜¯æˆ‘ä»¬çº¦å®šçš„é¸­å­æ¥å£ï¼Œè€Œä½ å¦‚æœå®Œæ•´å®ç°äº†è¿™äº›æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥åƒå¯¹å¾…ä¸€ä¸ªé¸­å­ä¸€æ ·å¯¹å¾…ä½ ã€‚</p><p>åœ¨æˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä¸è®ºæ˜¯ Mysql å®ç°è¿˜æ˜¯ Redis å®ç°ï¼Œä»–ä»¬éƒ½æœ‰ä¸ªå…±åŒçš„åŠŸèƒ½ï¼šç”¨ä¸€ä¸ª idï¼ŒæŸ¥ä¸€ä¸ªæ•°æ®å‡ºæ¥ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯å…±åŒçš„æ¥å£ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çº¦å®šä¸€ä¸ªå« DataSource çš„æ¥å£ï¼Œå®ƒå¿…é¡»æœ‰ä¸€ä¸ªæ–¹æ³•å« GetByIdï¼ŒåŠŸèƒ½æ˜¯è¦æ¥æ”¶ä¸€ä¸ª idï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²</p><pre><code class="language-go">type DataSource interface {
    GetById(id string) string
}
</code></pre><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥æŠŠå„ä¸ªæ•°æ®æºåˆ†åˆ«è¿›è¡Œå°è£…ï¼ŒæŒ‰ç…§è¿™ä¸ª interface å®šä¹‰å®ç°æ¥å£ï¼Œè¿™æ ·æˆ‘ä»¬çš„ App é‡Œå¤„ç†è¯·æ±‚çš„éƒ¨åˆ†å°±å¯ä»¥ç¨³å®šåœ°è°ƒç”¨ GetById è¿™ä¸ªæ–¹æ³•ï¼Œè€Œåº•å±‚æ•°æ®å®ç°åªè¦å®ç°äº† DataSource è¿™ä¸ª interface å°±èƒ½èŠ±å¼æ›¿æ¢ï¼Œä¸ç”¨æ”¹ App å†…éƒ¨çš„ä»£ç äº†ã€‚</p><pre><code class="language-go">// å°è£…ä¸ªredis
type redis struct {
    r *RedisClient
}

func NewRedis(addr string) *redis {
    return &amp;redis{r: NewRedisClient(addr)}
}

func (r *redis) GetById(id string) string {
    return r.r.Do(&quot;GET&quot;, &quot;biu_&quot;+id)
}


// å†å°è£…ä¸ªmysql
type mysql struct {
    m *MySQLClient
}

func NewMySQL(addr string) *redis {
    return &amp;mysql{m: NewMySQLClient(addr)}
}

func (m *mysql) GetById(id string) string {
    return r.m.Exec(&quot;select data from biu where id = ? limit 1&quot;, id)
}


type App struct {
    ds DataSource
}

func NewApp(addr string) *App {
    //éœ€è¦ç”¨Mysqlçš„æ—¶å€™
    return &amp;App{ds: NewMySQLClient(addr)}

    //éœ€è¦ç”¨Redisçš„æ—¶å€™
    return &amp;App{ds: NewRedisClient(addr)}
}

</code></pre><p>ç”±äºä¸¤ç§æ•°æ®æºéƒ½å®ç°äº† DataSource æ¥å£ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªå¡åˆ° App é‡Œé¢äº†ï¼Œæƒ³ç”¨å“ªä¸ªç”¨å“ªä¸ªï¼Œçœ‹ç€è¿˜ä¸é”™ï¼Ÿ</p><h5>ç­‰ä¸€ç­‰ï¼Œå¥½åƒå°‘äº†äº›ä»€ä¹ˆ</h5><p>addr ä½œä¸ºå‚æ•°ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹ç®€å•ï¼Ÿé€šå¸¸åˆå§‹åŒ–ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œå¯èƒ½æœ‰ä¸€å †å‚æ•°ï¼Œé…åœ¨ä¸€ä¸ª yaml æ–‡ä»¶é‡Œï¼Œéœ€è¦è§£æåˆ°ä¸€ä¸ª struct é‡Œé¢ï¼Œç„¶åå†ä¼ ç»™å¯¹åº”çš„ New æ–¹æ³•ã€‚</p><p>é…ç½®æ–‡ä»¶å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p><pre><code class="language-yaml">redis:
    addr: 127.0.0.1:6379
    read_timeout: 0.2s
    write_timeout: 0.2s
</code></pre><p>è§£æç»“æ„ä½“æ˜¯è¿™æ ·çš„ï¼š</p><pre><code class="language-go">type RedisConfig struct {
    Network      string             `json:&quot;network,omitempty&quot;`
    Addr         string             `json:&quot;addr,omitempty&quot;`
    ReadTimeout  *duration.Duration `json:&quot;read_timeout,omitempty&quot;`
    WriteTimeout *duration.Duration `json:&quot;write_timeout,omitempty&quot;`
}
</code></pre><p>ç»“æœä½ çš„<code>NewApp</code>æ–¹æ³•å¯èƒ½å°±å˜æˆäº†è¿™ä¸ªå¾·æ€§ï¼š</p><pre><code class="language-go">func NewApp() *App {
    var conf *RedisConfig
    yamlFile, err := ioutil.ReadFile(&quot;redis_conf.yaml&quot;)
    if err != nil {
        panic(err)
    }
    err = yaml.Unmarshal(yamlFile, &amp;conf)
    if err != nil {
        panic(err)
    }
    return &amp;App{ds: NewRedisClient(conf)}
}
</code></pre><p>NewApp è¯´ï¼Œåœåœï¼Œä½ ä»¬å¹´è½»äººä¸è®²æ­¦å¾·ï¼Œæˆ‘çš„è´£ä»»å°±æ˜¯åˆ›å»ºä¸€ä¸ª App å®ä¾‹ï¼Œæˆ‘åªéœ€è¦ä¸€ä¸ª DataSource æ³¨å†Œè¿›å»ï¼Œè‡³äºè¿™ä¸ª DataSource æ˜¯æ€ä¹ˆæ¥çš„æˆ‘ä¸æƒ³ç®¡ï¼Œè¿™ä¹ˆä¸€å¨å¤„ç† conf çš„ä»£ç å‡­ä»€ä¹ˆè¦æ”¾åœ¨æˆ‘è¿™é‡Œï¼Œæˆ‘ä¹Ÿä¸æƒ³å…³å¿ƒä½ è¿™é…ç½®æ–‡ä»¶æ˜¯é€šè¿‡ç½‘ç»œè¯·æ±‚æ‹¿æ¥çš„è¿˜æ˜¯ä»æœ¬åœ°ç£ç›˜è¯»çš„ï¼Œæˆ‘åªæƒ³æŠŠ App ç»„è£…å¥½æ‰”å‡ºå»ç›´æ¥ä¸‹ç­ã€‚</p><h5>ä¾èµ–æ³¨å…¥ç»ˆäºå¯ä»¥ç™»åœºäº†</h5><p>è¿˜è®°å¾—å‰é¢æ˜¯æ€ä¹ˆè¯´ä¾èµ–æ³¨å…¥çš„å—ï¼Ÿè¢«ä¾èµ–çš„æ¨¡å—ï¼Œåœ¨åˆ›å»ºæ¨¡å—æ—¶ï¼Œè¢«æ³¨å…¥åˆ°ï¼ˆå³å½“ä½œå‚æ•°ä¼ å…¥ï¼‰åˆå§‹åŒ–å‡½æ•°é‡Œé¢ã€‚é€šè¿‡è¿™ç§æ¨¡å¼ï¼Œæ­£å¥½å¯ä»¥è®© NewApp æ—©ç‚¹ä¸‹ç­ã€‚æˆ‘ä»¬åœ¨å¤–é¢åˆå§‹åŒ–å¥½ NewRedis æˆ–è€… NewMysqlï¼Œå¾—åˆ°çš„ DataSource ç›´æ¥æ‰”ç»™ NewAppã€‚</p><p>ä¹Ÿå°±æ˜¯è¿™æ ·</p><pre><code class="language-go">func NewApp(ds DataSource) *App {
    return &amp;App{ds: ds}
}
</code></pre><p>é‚£å¨è¯»é…ç½®æ–‡ä»¶åˆå§‹åŒ– redis çš„ä»£ç æ‰”åˆ°åˆå§‹åŒ– DataSource çš„æ–¹æ³•é‡Œå»</p><pre><code class="language-go">func NewRedis() DataSource {
    var conf *RedisConfig
    yamlFile, err := ioutil.ReadFile(&quot;redis_conf.yaml&quot;)
    if err != nil {
        panic(err)
    }
    err = yaml.Unmarshal(yamlFile, &amp;conf)
    if err != nil {
        panic(err)
    }
    return &amp;redis{r: NewRedisClient(conf)}
}
</code></pre><p>æ›´è¿›ä¸€æ­¥ï¼ŒNewRedis è¿™ä¸ªæ–¹æ³•ç”šè‡³ä¹Ÿä¸éœ€è¦å…³å¿ƒæ–‡ä»¶æ˜¯æ€ä¹ˆè¯»çš„ï¼Œå®ƒçš„è´£ä»»åªæ˜¯é€šè¿‡ conf åˆå§‹åŒ–ä¸€ä¸ª DataSource å‡ºæ¥ï¼Œå› æ­¤ä½ å¯ä»¥ç»§ç»­æŠŠè¯» config çš„ä»£ç å¾€å¤–æŠ½ï¼ŒæŠŠ NewRedis åšæˆæ¥æ”¶ä¸€ä¸ª confï¼Œè¾“å‡ºä¸€ä¸ª DataSource</p><pre><code class="language-go">func GetRedisConf() *RedisConfig
func NewRedis(conf *RedisConfig) DataSource
</code></pre><p>å› ä¸ºä¹‹å‰æ•´ä¸ªç»„è£…è¿‡ç¨‹æ˜¯æ•£æ”¾åœ¨ main å‡½æ•°ä¸‹é¢çš„ï¼Œæˆ‘ä»¬æŠŠå®ƒæŠ½å‡ºæ¥ææˆä¸€ä¸ªç‹¬ç«‹çš„ initApp æ–¹æ³•ã€‚æœ€åä½ çš„ App åˆå§‹åŒ–é€»è¾‘å°±å˜æˆäº†è¿™æ ·</p><pre><code class="language-go">func initApp() *App {
    c := GetRedisConf()
    r := NewRedis(c)
    app := NewApp(r)
    return app
}

func main() {
    app := initApp()
    app.Run()
}
</code></pre><p>ç„¶åä½ å¯ä»¥é€šè¿‡å®ç° DataSource çš„æ¥å£ï¼Œæ›´æ¢å‰é¢çš„è¯»å–é…ç½®æ–‡ä»¶çš„æ–¹æ³•ï¼Œå’Œæ›´æ¢åˆ›å»º DataSource çš„æ–¹æ³•ï¼Œæ¥ä»»æ„ä¿®æ”¹ä½ çš„åº•å±‚å®ç°ï¼ˆè¯»é…ç½®æ–‡ä»¶çš„å®ç°ï¼Œå’Œç”¨å“ªç§ DataSource æ¥æŸ¥æ•°æ®ï¼‰ï¼Œè€Œä¸ç”¨æ¯æ¬¡éƒ½æ”¹ä¸€å¤§å †ä»£ç ã€‚è¿™ä½¿å¾—ä½ çš„ä»£ç å±‚æ¬¡åˆ’åˆ†å¾—æ›´åŠ æ¸…æ¥šï¼Œæ›´å®¹æ˜“ç»´æŠ¤äº†ã€‚</p><p>è¿™å°±æ˜¯ä¾èµ–æ³¨å…¥ã€‚</p><h5>æ‰‹å·¥ä¾èµ–æ³¨å…¥çš„é—®é¢˜</h5><p>ä¸Šæ–‡è¿™ä¸€å¨ä»£ç ï¼ŒæŠŠå„ä¸ªå®ä¾‹åˆå§‹åŒ–å¥½ï¼Œå†æŒ‰ç…§å„ä¸ªåˆå§‹åŒ–æ–¹æ³•çš„éœ€æ±‚å¡è¿›å»ï¼Œæœ€ç»ˆæ„é€ å‡º app çš„è¿™å¨ä»£ç ï¼Œå°±æ˜¯æ³¨å…¥ä¾èµ–çš„è¿‡ç¨‹ã€‚</p><pre><code class="language-go">c := GetRedisConf()
r := NewRedis(c)
app := NewApp(r)
</code></pre><p>ç›®å‰åªæœ‰ä¸€ä¸ª DataSourceï¼Œè¿™æ ·æ‰‹å†™æ³¨å…¥è¿‡ç¨‹è¿˜å¯ä»¥ï¼Œä¸€æ—¦ä½ è¦ç»´æŠ¤çš„ä¸œè¥¿å¤šäº†ï¼Œæ¯”å¦‚ä½ çš„ NewApp æ˜¯è¿™æ ·çš„<code>NewApp(r *Redis, es *ES, us *UserSerivce, db *MySQL) *App</code>ç„¶åå…¶ä¸­ UserService æ˜¯è¿™æ ·çš„<code>UserService(pg *Postgres, mm *Memcached)</code>ï¼Œè¿™æ ·å½¢æˆäº†å¤šå±‚æ¬¡çš„ä¸€å †ä¾èµ–éœ€è¦æ³¨å…¥ï¼Œå¾’æ‰‹å»å†™éå¸¸éº»çƒ¦ã€‚</p><p>è€Œè¿™éƒ¨åˆ†ï¼Œå°±æ˜¯ wire è¿™æ ·çš„ä¾èµ–æ³¨å…¥å·¥å…·èƒ½å¤Ÿèµ·ä½œç”¨çš„åœ°æ–¹äº†â€”â€”ä»–çš„åŠŸèƒ½åªæ˜¯é€šè¿‡ç”Ÿæˆä»£ç <strong>å¸®ä½ æ³¨å…¥ä¾èµ–</strong>ï¼Œè€Œå®é™…çš„ä¾èµ–å®ä¾‹éœ€è¦ä½ è‡ªå·±åˆ›å»ºï¼ˆåˆå§‹åŒ–ï¼‰ã€‚</p><h2>How</h2><p>wire çš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œ<del>çœ‹æ–‡æ¡£å­¦ä¸ä¼š</del>ã€‚åæ­£æˆ‘æœ€åˆçœ‹å®Œæ–‡æ¡£ä¹‹åæ˜¯ä¸€å¤´é›¾æ°´â€”â€”è¿™æ˜¯å•¥ï¼Œè¿™è¦å¹²å•¥ï¼Ÿä½†é€šè¿‡æˆ‘ä»¬åˆšæ‰çš„æ¨å¯¼è¿‡ç¨‹ï¼Œåº”è¯¥å¤§æ¦‚ç†è§£äº†ä¸ºä»€ä¹ˆè¦ç”¨ä¾èµ–æ³¨å…¥ï¼Œä»¥åŠ wire åœ¨è¿™å…¶ä¸­èµ·åˆ°ä»€ä¹ˆä½œç”¨â€”â€”é€šè¿‡ç”Ÿæˆä»£ç <strong>å¸®ä½ æ³¨å…¥ä¾èµ–</strong>ï¼Œè€Œå®é™…çš„ä¾èµ–å®ä¾‹éœ€è¦ä½ è‡ªå·±åˆ›å»ºï¼ˆåˆå§‹åŒ–ï¼‰ã€‚</p><p>æ¥ä¸‹æ¥å°±æ¯”è¾ƒæ¸…æ¥šäº†ã€‚</p><p>é¦–å…ˆè¦å®ç°ä¸€ä¸ª<code>wire.go</code>çš„æ–‡ä»¶ï¼Œé‡Œé¢å®šä¹‰å¥½ Injectorã€‚</p><pre><code>// +build wireinject

func initApp() (*App) {
    panic(wire.Build(GetRedisConf, NewRedis, SomeProviderSet, NewApp))
}
</code></pre><p>ç„¶ååˆ†åˆ«å®ç°å¥½ Providerã€‚</p><p>æ‰§è¡Œ<code>wire</code>å‘½ä»¤å
ä»–ä¼šæ‰«ææ•´ä¸ªé¡¹ç›®ï¼Œå¹¶å¸®ä½ ç”Ÿæˆä¸€ä¸ª<code>wire_gen.go</code>æ–‡ä»¶ï¼Œå¦‚æœä½ æœ‰ä»€ä¹ˆæ²¡æœ‰å®ç°å¥½ï¼Œå®ƒä¼šæŠ¥é”™å‡ºæ¥ã€‚</p><p><del>ä½ å­¦ä¼šäº†å—ï¼Ÿ</del></p><h3>é‡æ–°ç†è§£</h3><p>ç­‰ä¸€ç­‰ï¼Œå…ˆåˆ«æ”¾å¼ƒæ²»ç–—ï¼Œè®©æˆ‘ä»¬ç”¨<del>ç¥å¥‡çš„ä¸­æ–‡ç¼–ç¨‹</del>æ¥è§£é‡Šä¸€ä¸‹è¦æ€ä¹ˆåšã€‚</p><h4>è°å‚ä¸ç¼–è¯‘ï¼Ÿ</h4><p>ä¸Šé¢é‚£ä¸ª<code>initApp</code>æ–¹æ³•ï¼Œå®˜æ–¹æ–‡æ¡£å«å®ƒ Injectorï¼Œç”±äºæ–‡ä»¶é‡Œé¦–è¡Œ<code>// +build wireinject</code>è¿™å¥æ³¨é‡Šï¼Œè¿™ä¸ª wire.go æ–‡ä»¶åªä¼šç”± wire è¯»å–ï¼Œåœ¨ go ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä»£ç æ—¶ä¸ä¼šå»ç®¡å®ƒï¼Œå®é™…ä¼šè¯»çš„æ˜¯ç”Ÿæˆçš„ wire_gen.go æ–‡ä»¶ã€‚</p><p>è€Œ Provider å°±æ˜¯ä½ ä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œè‚¯å®šä¼šå‚ä¸åˆ°ç¼–è¯‘è¿‡ç¨‹ã€‚</p><h4>Injector æ˜¯ä»€ä¹ˆé¬¼ä¸œè¥¿ï¼Ÿ</h4><p>Injector å°±æ˜¯ä½ æœ€ç»ˆæƒ³è¦çš„ç»“æœâ€”â€”æœ€ç»ˆçš„ App å¯¹è±¡çš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å‰é¢é‚£ä¸ªä¾‹å­é‡Œçš„<code>initApp</code>æ–¹æ³•ã€‚</p><p>æŠŠå®ƒç†è§£ä¸ºä½ å»åƒé‡‘æ‹±é—¨ï¼Œè¿›é—¨çœ‹åˆ°ç‚¹é¤æœºï¼Œå™¼é‡Œå•ªå•¦ç‚¹äº†ä¸€å †ï¼Œæœ€åæ‰“å‡ºä¸€å¼ å•å­ã€‚</p><pre><code class="language-go">// +build wireinject

func æ¥ä¸€è¢‹åƒåœ¾é£Ÿå“() ä¸€è¢‹åƒåœ¾é£Ÿå“ {
    panic(wire.Build(æ¥ä¸€ä»½å·¨æ— éœ¸å¥—é¤, æ¥ä¸€ä»½åŒå±‚é³•é±¼å ¡å¥—é¤, æ¥ä¸€ç›’éº¦ä¹é¸¡, åƒåœ¾é£Ÿå“æ‰“åŒ…))
}
</code></pre><p>è¿™å°±æ˜¯ä½ ç‚¹çš„å•å­ï¼Œå®ƒä¸å‚ä¸ç¼–è¯‘ï¼Œå®é™…å‚ä¸ç¼–è¯‘çš„ä»£ç æ˜¯ç”± wire å¸®ä½ ç”Ÿæˆçš„ã€‚</p><h4>Provider æ˜¯ä»€ä¹ˆé¬¼ä¸œè¥¿ï¼Ÿ</h4><p>Provider å°±æ˜¯åˆ›å»ºå„ä¸ªä¾èµ–çš„æ–¹æ³•ï¼Œæ¯”å¦‚å‰é¢ä¾‹å­é‡Œçš„ NewRedis å’Œ NewApp ç­‰ã€‚</p><p>ä½ å¯ä»¥ç†è§£ä¸ºï¼Œè¿™äº›æ˜¯é‡‘æ‹±é—¨çš„æœåŠ¡å‘˜å’Œåå¨è¦å¹²çš„äº‹æƒ…ï¼š
é‡‘æ‹±é—¨åå¨éœ€è¦æä¾›è¿™äº›é£Ÿå“çš„åˆ¶ä½œæœåŠ¡â€”â€”å®ç°è¿™äº›å®ä¾‹åˆå§‹åŒ–æ–¹æ³•ã€‚</p><pre><code class="language-go">func æ¥ä¸€ç›’éº¦ä¹é¸¡() ä¸€ç›’éº¦ä¹é¸¡ {}
func åƒåœ¾é£Ÿå“æ‰“åŒ…(ä¸€ä»½å·¨æ— éœ¸å¥—é¤, ä¸€ä»½åŒå±‚é³•é±¼å ¡å¥—é¤, ä¸€ç›’éº¦ä¹é¸¡) ä¸€è¢‹åƒåœ¾é£Ÿå“ {}
</code></pre><p>wire é‡Œé¢è¿˜æœ‰ä¸ª ProviderSet çš„æ¦‚å¿µï¼Œå°±æ˜¯æŠŠä¸€ç»„ Provider æ‰“åŒ…ï¼Œå› ä¸ºé€šå¸¸ä½ ç‚¹å•çš„æ—¶å€™å¾ˆæ‡’ï¼Œä¸æƒ³è¿™æ ·ç‚¹ä½ çš„å·¨æ— éœ¸å¥—é¤ï¼šæˆ‘è¦ä¸€æ¯å¯ä¹ï¼Œä¸€åŒ…è–¯æ¡ï¼Œä¸€ä¸ªå·¨æ— éœ¸æ±‰å ¡ï¼›ä½ æƒ³ç›´æ¥æˆ³ä¸€ä¸‹å°±å¥½äº†ï¼Œæ¥ä¸€ä»½å·¨æ— éœ¸å¥—é¤ã€‚è¿™ä¸ªå¥—é¤å°±æ˜¯ ProviderSetï¼Œä¸€ç»„çº¦å®šå¥½çš„é…æ–¹ï¼Œä¸ç„¶ä½ çš„ç‚¹å•åˆ—è¡¨ï¼ˆinjector é‡Œçš„ Buildï¼‰å°±ä¼šå˜å¾—è¶…çº§é•¿ï¼Œè¿™æ ·ä½ å¾ˆéº»çƒ¦ï¼ŒæœåŠ¡å‘˜çœ‹ç€ä¹Ÿå¾ˆç´¯ã€‚</p><p>ç”¨å…¶ä¸­ä¸€ä¸ªå¥—é¤ä¸¾ä¾‹</p><pre><code class="language-go">// å…ˆå®šä¹‰å¥—é¤å†…å®¹
var å·¨æ— éœ¸å¥—é¤ = wire.NewSet(æ¥ä¸€æ¯å¯ä¹ï¼Œæ¥ä¸€åŒ…è–¯æ¡ï¼Œæ¥ä¸€ä¸ªå·¨æ— éœ¸æ±‰å ¡)

// ç„¶åå®ç°å„ä¸ªé£Ÿå“çš„åšæ³•
func æ¥ä¸€æ¯å¯ä¹() ä¸€æ¯å¯ä¹ {}
func æ¥ä¸€åŒ…è–¯æ¡() ä¸€åŒ…è–¯æ¡ {}
func æ¥ä¸€ä¸ªå·¨æ— éœ¸æ±‰å ¡() ä¸€ä¸ªå·¨æ— éœ¸æ±‰å ¡ {}
</code></pre><h4>wire å·¥å…·åšäº†å•¥ï¼Ÿ</h4><p>é‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼Œé€šè¿‡ç”Ÿæˆä»£ç <strong>å¸®ä½ æ³¨å…¥ä¾èµ–</strong>ã€‚</p><p>åœ¨é‡‘æ‹±é—¨çš„ä¾‹å­é‡Œå°±æ˜¯ï¼Œwire å°±æ˜¯ä¸ªæœåŠ¡å‘˜ï¼Œå®ƒæŒ‰ç…§ä½ çš„è®¢å•ï¼Œå»å«åšç›¸åº”çš„åŒäº‹æŠŠå„ä¸ªé£Ÿç‰©/å¥—é¤åšå¥½ï¼Œç„¶åæœ€ç»ˆæŒ‰éœ€æ±‚æ‰“åŒ…ç»™ä½ ã€‚è¿™ä¸ªä¸­é—´åè°ƒæ„å»ºçš„è¿‡ç¨‹ï¼Œå°±æ˜¯æ³¨å…¥ä¾èµ–ã€‚</p><p>è¿™æ ·çš„å¥½å¤„å°±æ˜¯ï¼Œ
å¯¹äºé‡‘æ‹±é—¨ï¼Œå‡è®¾ä»–ä»¬çªç„¶æ¢å¯ä¹ä¾›åº”å•†äº†ï¼Œç›´æ¥æŠŠ<code>æ¥ä¸€æ¯å¯ä¹</code>æ›¿æ¢æ‰å°±è¡Œï¼Œè¿”å›ä¸€ç§æ–°çš„å¯ä¹ï¼Œè€Œå¯¹äºé¡¾å®¢ä¸éœ€è¦æœ‰å•¥æ”¹åŠ¨ã€‚
å¯¹äºé¡¾å®¢æ¥è¯´ï¼Œç‚¹å•å†…å®¹å¯ä»¥å˜æ¢ï¼Œæ¯”å¦‚æˆ‘ä»Šå¤©ä¸æƒ³è¦éº¦ä¹é¸¡äº†ï¼Œæˆ–è€…æƒ³åŠ ç‚¹åˆ«çš„ï¼Œåªè¦æ”¹åŠ¨æˆ‘çš„ç‚¹å•(åªè¦é‡‘æ‹±é—¨èƒ½åšå¾—å‡ºæ¥)ï¼Œç„¶åé€šè¿‡ wire é‡æ–°å»ç”Ÿæˆå³å¯ï¼Œä¸éœ€è¦å…³æ³¨è¿™ä¸ªæœåŠ¡å‘˜æ˜¯å¦‚ä½•å»åšè¿™ä¸ªè®¢å•çš„ã€‚</p><p>ç°åœ¨ä½ åº”è¯¥å¤§æ¦‚ç†è§£ wire çš„ç”¨å¤„å’Œå¥½å¤„äº†ã€‚</p><h4>æ€»ç»“</h4><p>è®©æˆ‘ä»¬ä»é‡‘æ‹±é—¨å›æ¥ï¼Œé‡æ–°æ€»ç»“ä¸€ä¸‹ç”¨ wire åšä¾èµ–æ³¨å…¥çš„è¿‡ç¨‹ã€‚</p><h5>1. å®šä¹‰ Injector</h5><p>åˆ›å»º<code>wire.go</code>æ–‡ä»¶ï¼Œå®šä¹‰ä¸‹ä½ æœ€ç»ˆæƒ³ç”¨çš„å®ä¾‹åˆå§‹åŒ–å‡½æ•°ä¾‹å¦‚<code>initApp</code>ï¼ˆå³ Injectorï¼‰ï¼Œå®šå¥½å®ƒè¿”å›çš„ä¸œè¥¿<code>*App</code>ï¼Œåœ¨æ–¹æ³•é‡Œç”¨<code>panic(wire.Build(NewRedis, SomeProviderSet, NewApp))</code>ç½—åˆ—å‡ºå®ƒä¾èµ–å“ªäº›å®ä¾‹çš„åˆå§‹åŒ–æ–¹æ³•ï¼ˆå³ Providerï¼‰/æˆ–è€…å“ªäº›ç»„åˆå§‹åŒ–æ–¹æ³•ï¼ˆProviderSetï¼‰</p><h5>2. å®šä¹‰ ProviderSetï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</h5><p>ProviderSet å°±æ˜¯ä¸€ç»„åˆå§‹åŒ–å‡½æ•°ï¼Œæ˜¯ä¸ºäº†å°‘å†™ä¸€äº›ä»£ç ï¼Œèƒ½å¤Ÿæ›´æ¸…æ™°çš„ç»„ç»‡å„ä¸ªæ¨¡å—çš„ä¾èµ–æ‰å‡ºç°çš„ã€‚ä¹Ÿå¯ä»¥ä¸ç”¨ï¼Œä½† Injector é‡Œé¢çš„ä¸œè¥¿å°±éœ€è¦å†™ä¸€å †ã€‚
åƒè¿™æ · <code>var SomeProviderSet = wire.NewSet(NewES,NewDB)</code>å®šä¹‰ ProviderSet é‡Œé¢åŒ…å«å“ªäº› Provider</p><h5>3. å®ç°å„ä¸ª Provider</h5><p>Provider å°±æ˜¯åˆå§‹åŒ–æ–¹æ³•ï¼Œä½ éœ€è¦è‡ªå·±å®ç°ï¼Œæ¯”å¦‚ NewAppï¼ŒNewRedisï¼ŒNewMySQLï¼ŒGetConfig ç­‰ï¼Œæ³¨æ„ä»–ä»¬ä»¬å„è‡ªçš„è¾“å…¥è¾“å‡º</p><h5>4. ç”Ÿæˆä»£ç </h5><p>æ‰§è¡Œ wire å‘½ä»¤ç”Ÿæˆä»£ç ï¼Œå·¥å…·ä¼šæ‰«æä½ çš„ä»£ç ï¼Œä¾ç…§ä½ çš„ Injector å®šä¹‰æ¥ç»„ç»‡å„ä¸ª Provider çš„æ‰§è¡Œé¡ºåºï¼Œå¹¶è‡ªåŠ¨æŒ‰ç…§ Provider ä»¬çš„ç±»å‹éœ€æ±‚æ¥æŒ‰ç…§é¡ºåºæ‰§è¡Œå’Œå®‰æ’å‚æ•°ä¼ é€’ï¼Œå¦‚æœæœ‰å“ªäº› Provider çš„è¦æ±‚æ²¡æœ‰æ»¡è¶³ï¼Œä¼šåœ¨ç»ˆç«¯æŠ¥å‡ºæ¥ï¼ŒæŒç»­ä¿®å¤æ‰§è¡Œ wireï¼Œç›´åˆ°æˆåŠŸç”Ÿæˆ<code>wire_gen.go</code>æ–‡ä»¶ã€‚æ¥ä¸‹æ¥å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨<code>initApp</code>æ¥å†™ä½ åç»­çš„ä»£ç äº†ã€‚</p><p>å¦‚æœéœ€è¦æ›¿æ¢å®ç°ï¼Œå¯¹ Injector è¿›è¡Œç›¸åº”çš„ä¿®æ”¹ï¼Œå®ç°å¿…é¡»çš„ Providerï¼Œé‡æ–°ç”Ÿæˆå³å¯ã€‚</p><p>å®ƒç”Ÿæˆçš„ä»£ç å…¶å®å°±æ˜¯ç±»ä¼¼æˆ‘ä»¬ä¹‹å‰éœ€è¦æ‰‹å†™çš„è¿™ä¸ª</p><pre><code>func initApp() *App {  // injector
    c := GetRedisConf() // provider
    r := NewRedis(c)  // provider
    app := NewApp(r) // provider
    return app
}
</code></pre><p>ç”±äºæˆ‘ä»¬çš„ä¾‹å­æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡ wire ç”Ÿæˆä½“ç°ä¸å‡ºä¼˜åŠ¿ï¼Œä½†å¦‚æœæˆ‘ä»¬çš„è½¯ä»¶å¤æ‚ï¼Œæœ‰å¾ˆå¤šå±‚çº§çš„ä¾èµ–ï¼Œä½¿ç”¨ wire è‡ªåŠ¨ç”Ÿæˆæ³¨å…¥é€»è¾‘ï¼Œæ— ç–‘æ›´åŠ æ–¹ä¾¿å’Œå‡†ç¡®ã€‚</p><h5>5. é«˜çº§ç”¨æ³•</h5><p>wire è¿˜æœ‰æ›´å¤šåŠŸèƒ½ï¼Œæ¯”å¦‚ cleanup, bind ç­‰ç­‰ï¼Œè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£æ¥ä½¿ç”¨ã€‚</p><p>æœ€åï¼Œå…¶å®å¤šæŠ˜è…¾å‡ æ¬¡ï¼Œå°±ä¼šä½¿ç”¨äº†ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½å¯¹æ‚¨èµ·åˆ°ä¸€å®šç¨‹åº¦ä¸Šçš„å¸®åŠ©ã€‚</p><h2>ç›¸å…³æ–‡çŒ®</h2><ul><li><a href="https://github.com/google/wire">https://github.com/google/wire</a></li><li><a href="https://go-kratos.dev/docs/getting-started/wire">https://go-kratos.dev/docs/getting-started/wire</a></li><li><a href="https://github.com/go-kratos/kratos-layout">https://github.com/go-kratos/kratos-layout</a></li><li><a href="https://farer.org">https://farer.org</a></li></ul>]]></content>
        <author>
            <name>Windfarer</name>
            <uri>https://github.com/Windfarer</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kratos å­¦ä¹ ç¬”è®° - åŸºäº OpenTelemetry çš„é“¾è·¯è¿½è¸ª]]></title>
        <id>go-kratos-opentelemetry-practice</id>
        <link href="https://go-kratos.dev/en/blog/go-kratos-opentelemetry-practice"/>
        <updated>2021-06-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[åˆ†å¸ƒå¼è·Ÿè¸ªï¼ˆä¹Ÿç§°ä¸ºåˆ†å¸ƒå¼è¯·æ±‚è·Ÿè¸ªï¼‰æ˜¯ä¸€ç§ç”¨äºåˆ†æå’Œç›‘æ§åº”ç”¨ç¨‹åºçš„æ–¹æ³•ï¼Œå°¤å…¶æ˜¯ä½¿ç”¨å¾®æœåŠ¡æ¶æ„æ„å»ºçš„åº”ç”¨ç¨‹åºã€‚åˆ†å¸ƒå¼è·Ÿè¸ªæœ‰åŠ©äºç²¾ç¡®å®šä½æ•…éšœå‘ç”Ÿçš„ä½ç½®ä»¥åŠå¯¼è‡´æ€§èƒ½å·®çš„åŸå› ã€‚]]></summary>
        <content type="html"><![CDATA[<h2>é“¾è·¯è¿½è¸ªçš„å‰ä¸–ä»Šç”Ÿ</h2><blockquote><p>åˆ†å¸ƒå¼è·Ÿè¸ªï¼ˆä¹Ÿç§°ä¸ºåˆ†å¸ƒå¼è¯·æ±‚è·Ÿè¸ªï¼‰æ˜¯ä¸€ç§ç”¨äºåˆ†æå’Œç›‘æ§åº”ç”¨ç¨‹åºçš„æ–¹æ³•ï¼Œå°¤å…¶æ˜¯ä½¿ç”¨å¾®æœåŠ¡æ¶æ„æ„å»ºçš„åº”ç”¨ç¨‹åºã€‚åˆ†å¸ƒå¼è·Ÿè¸ªæœ‰åŠ©äºç²¾ç¡®å®šä½æ•…éšœå‘ç”Ÿçš„ä½ç½®ä»¥åŠå¯¼è‡´æ€§èƒ½å·®çš„åŸå› ã€‚   </p><h3>èµ·æº</h3><p>é“¾è·¯è¿½è¸ª(Distributed Tracing)ã€€ä¸€è¯æœ€æ—©å‡ºç°äºè°·æ­Œå‘å¸ƒçš„è®ºæ–‡ <strong>ã€ŠDapper, a Large-Scale Distributed Systems Tracing Infrastructureã€‹</strong> ä¸­,è¿™ç¯‡è®ºæ–‡å¯¹äºå®ç°é“¾è·¯è¿½è¸ª,å¯¹äºåæ¥å‡ºç°çš„ Jaegerã€Zipkin ç­‰å¼€æºåˆ†å¸ƒå¼è¿½è¸ªé¡¹ç›®è®¾è®¡ç†å¿µä»æœ‰å¾ˆæ·±çš„å½±å“ã€‚</p></blockquote><p>å¾®æœåŠ¡æ¶æ„æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„æ¶æ„,ä¼šæœ‰å¾ˆå¤šä¸ªä¸åŒçš„æœåŠ¡ã€‚ä¸åŒçš„æœåŠ¡ä¹‹å‰ç›¸äº’è°ƒç”¨,å¦‚æœå‡ºç°äº†é”™è¯¯ç”±äºä¸€ä¸ªè¯·æ±‚ç»è¿‡äº† N ä¸ªæœåŠ¡ã€‚éšç€ä¸šåŠ¡çš„å¢åŠ è¶Šæ¥è¶Šå¤šçš„æœåŠ¡ä¹‹é—´çš„è°ƒç”¨ï¼Œå¦‚æœæ²¡æœ‰ä¸€ä¸ªå·¥å…·å»è®°å½•è°ƒç”¨é“¾ï¼Œè§£å†³é—®é¢˜çš„æ—¶å€™å°±ä¼šåƒä¸‹é¢å›¾ç‰‡é‡Œå°çŒ«å’ªç©çš„æ¯›çº¿çƒä¸€æ ·ï¼Œæ¯«æ— å¤´ç»ªï¼Œæ— ä»ä¸‹æ‰‹
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2dd5606765649969819396ba574a741~tplv-k3u1fbpfcp-watermark.image" alt="image.png"/>
æ‰€ä»¥éœ€è¦æœ‰ä¸€ä¸ªå·¥å…·èƒ½å¤Ÿæ¸…æ¥šçš„äº†è§£ä¸€ä¸ªè¯·æ±‚ç»è¿‡äº†å“ªäº›æœåŠ¡,é¡ºåºæ˜¯å¦‚ä½•,ä»è€Œèƒ½å¤Ÿè½»æ˜“çš„å®šä½é—®é¢˜ã€‚
<img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7098634cefe74a3cbacf5e76c343bd81~tplv-k3u1fbpfcp-watermark.image" alt="image.png"/></p><h3>ç™¾å®¶äº‰è‰³</h3><p>ä»è°·æ­Œå‘å¸ƒ <strong>Dapper</strong> åï¼Œåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªå·¥å…·è¶Šæ¥è¶Šå¤šï¼Œä»¥ä¸‹ç®€å•åˆ—ä¸¾äº†ä¸€äº›å¸¸ç”¨çš„é“¾è·¯è¿½è¸ªç³»ç»Ÿ</p><ul><li>Skywalking</li><li>é˜¿é‡Œ é¹°çœ¼</li><li>å¤§ä¼—ç‚¹è¯„ CAT</li><li>Twitter Zipkin</li><li>Naver pinpoint</li><li>Uber Jaeger</li></ul><h3>äº‰é”‹ç›¸å¯¹ï¼Ÿ</h3><p>éšç€é“¾è·¯è¿½è¸ªå·¥å…·è¶Šæ¥è¶Šå¤šï¼Œå¼€æºé¢†åŸŸä¸»è¦åˆ†ä¸ºä¸¤æ´¾ï¼Œä¸€æ´¾æ˜¯ä»¥ <strong>CNCFæŠ€æœ¯å§”å‘˜</strong> ä¼šä¸ºä¸»çš„  <strong>OpenTracing</strong> çš„è§„èŒƒï¼Œä¾‹å¦‚ jaeger zipkin éƒ½æ˜¯éµå¾ªäº†<strong>OpenTracing</strong> çš„è§„èŒƒã€‚è€Œå¦ä¸€æ´¾åˆ™æ˜¯è°·æ­Œä½œä¸ºå‘èµ·è€…çš„ <strong>OpenCensus</strong>ï¼Œè€Œä¸”è°·æ­Œæœ¬èº«è¿˜æ˜¯æœ€æ—©æå‡ºé“¾è·¯è¿½è¸ªæ¦‚å¿µçš„å…¬å¸ï¼ŒåæœŸè¿å¾®è½¯ä¹ŸåŠ å…¥äº† <strong>OpenCensus</strong>
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3029f1315fe34ec884858d33d41cb1ce~tplv-k3u1fbpfcp-watermark.image" alt="æˆªå±2021-05-29 ä¸‹åˆ9.56.57.png"/></p><h3>OpenTelemetry è¯ç”Ÿ</h3><blockquote><p>OpenTelemetric æ˜¯ä¸€ç»„ APIã€SDKã€æ¨¡ç»„å’Œé›†æˆï¼Œä¸“ä¸ºåˆ›å»ºå’Œç®¡ç†â€â€é¥æµ‹æ•°æ®â€â€ï¼ˆå¦‚è¿½è¸ªã€æŒ‡æ ‡å’Œæ—¥å¿—ï¼‰è€Œè®¾</p></blockquote><p>å¾®è½¯åŠ å…¥ <strong>OpenCensus</strong> åï¼Œç›´æ¥æ‰“ç ´äº†ä¹‹å‰å¹³è¡¡çš„å±€é¢ï¼Œé—´æ¥çš„å¯¼è‡´äº† <strong>OpenTelemetry</strong> çš„è¯ç”Ÿ
è°·æ­Œå’Œå¾®è½¯ä¸‹å®šå†³å¿ƒç»“æŸæ±Ÿæ¹–ä¹‹ä¹±ï¼Œé¦–è¦çš„é—®é¢˜æ˜¯å¦‚ä½•æ•´åˆä¸¤ä¸ªä¸¤ä¸ªç¤¾åŒºå·²æœ‰çš„é¡¹ç›®ï¼ŒOpenTelemetry ä¸»è¦çš„ç†å¿µå°±æ˜¯ï¼Œå…¼å®¹ <strong>OpenCensus</strong> å’Œ <strong>OpenTracing</strong> ï¼Œå¯ä»¥è®©ä½¿ç”¨è€…æ— éœ€æ”¹åŠ¨æˆ–è€…å¾ˆå°çš„æ”¹åŠ¨å°±å¯ä»¥æ¥å…¥ <strong>OpenTelemetry</strong></p><h2>Kratos çš„é“¾è·¯è¿½è¸ªå®è·µ</h2><blockquote><p>Kratos ä¸€å¥—è½»é‡çº§ Go å¾®æœåŠ¡æ¡†æ¶ï¼ŒåŒ…å«å¤§é‡å¾®æœåŠ¡ç›¸å…³æ¡†æ¶åŠå·¥å…·ã€‚</p></blockquote><h3>tracing ä¸­é—´ä»¶</h3><p>kratos æ¡†æ¶æä¾›çš„è‡ªå¸¦ä¸­é—´ä»¶ä¸­æœ‰ä¸€ä¸ªåä¸º <strong>tracing</strong> ä¸­é—´ä»¶ï¼Œå®ƒåŸºäº <strong>Opentelemetry</strong> å®ç°äº†kratos æ¡†æ¶çš„é“¾è·¯è¿½è¸ªåŠŸèƒ½ï¼Œä¸­é—´ä»¶çš„ä»£ç å¯ä»¥ä» <strong><a href="https://github.com/go-kratos/kratos/tree/main/middleware/tracing">middleware/tracing</a></strong> ä¸­çœ‹åˆ°ã€‚</p><h4>å®ç°åŸç†</h4><p>kratos çš„é“¾è·¯è¿½è¸ªä¸­é—´ä»¶ç”±ä¸‰ä¸ªæ–‡ä»¶ç»„æˆ <strong>carrie.go</strong>,<strong>tracer.go</strong>,<strong>tracing.go</strong>ã€‚clientå’Œ server çš„å®ç°åŸç†åŸºæœ¬ç›¸åŒï¼Œæœ¬æ–‡ä»¥ server å®ç°è¿›è¡ŒåŸç†è§£æã€‚</p><ol><li>é¦–å…ˆå½“è¯·æ±‚è¿›å…¥æ—¶ï¼Œ<strong>tracing</strong> ä¸­é—´ä»¶ä¼šè¢«è°ƒç”¨,é¦–å…ˆè°ƒç”¨äº† <strong>tracer.go</strong> ä¸­çš„ <strong>NewTracer</strong> æ–¹æ³•</li></ol><pre><code class="language-go">// Server returns a new server middleware for OpenTelemetry.
func Server(opts ...Option) middleware.Middleware {
        // è°ƒç”¨ tracer.go ä¸­çš„ NewTracer ä¼ å…¥äº†ä¸€ä¸ª SpanKindServer å’Œé…ç½®é¡¹
    tracer := NewTracer(trace.SpanKindServer, opts...)
        // ... çœç•¥ä»£ç 
}
</code></pre><ol start="2"><li><strong>tracer.go</strong> ä¸­çš„ <strong>NewTracer</strong> æ–¹æ³•è¢«è°ƒç”¨åä¼šè¿”å›ä¸€ä¸ª <strong>Tracer</strong>,å®ç°å¦‚ä¸‹</li></ol><pre><code class="language-go">func NewTracer(kind trace.SpanKind, opts ...Option) *Tracer {
    options := options{}
    for _, o := range opts {
        o(&amp;options)
    }
    // åˆ¤æ–­æ˜¯å¦å­˜åœ¨ otel è¿½è¸ªæä¾›è€…é…ç½®ï¼Œå¦‚æœå­˜åœ¨åˆ™è®¾ç½®
    if options.TracerProvider != nil {
        otel.SetTracerProvider(options.TracerProvider)
    }
    /*
    åˆ¤æ–­æ˜¯å¦å­˜åœ¨ Propagators è®¾ç½®ï¼Œå¦‚æœå­˜åœ¨è®¾ç½®åˆ™è¦†ç›–ï¼Œä¸å­˜åœ¨åˆ™è®¾ç½®ä¸€ä¸ªé»˜è®¤çš„TextMapPropagator
    æ³¨æ„å¦‚æœæ²¡æœ‰è®¾ç½®é»˜è®¤çš„TextMapPropagator,é“¾è·¯ä¿¡æ¯åˆ™æ— æ³•æ­£ç¡®çš„ä¼ é€’
    */
    if options.Propagators != nil {
        otel.SetTextMapPropagator(options.Propagators)
    } else {    otel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(propagation.Baggage{}, propagation.TraceContext{}))
    }


    var name string
    // åˆ¤æ–­å½“å‰ä¸­é—´ä»¶çš„ç±»å‹ï¼Œæ˜¯ server è¿˜æ˜¯ client
    if kind == trace.SpanKindServer {
        name = &quot;server&quot;
    } else if kind == trace.SpanKindClient {
        name = &quot;client&quot;
    } else {
        panic(fmt.Sprintf(&quot;unsupported span kind: %v&quot;, kind))
    }
    // è°ƒç”¨ otelåŒ…çš„ Tracer æ–¹æ³• ä¼ å…¥ name ç”¨æ¥åˆ›å»ºä¸€ä¸ª tracer å®ä¾‹
    tracer := otel.Tracer(name)
    return &amp;Tracer{tracer: tracer, kind: kind}
}
</code></pre><ol start="3"><li>åˆ¤æ–­å½“å‰è¯·æ±‚ç±»å‹ï¼Œå¤„ç†éœ€è¦é‡‡é›†çš„æ•°æ®ï¼Œå¹¶è°ƒç”¨ <strong>tracer.go</strong> ä¸­çš„ <strong>Start</strong> æ–¹æ³•</li></ol><pre><code class="language-go">var (
    component string
    operation string
    carrier   propagation.TextMapCarrier
)
// åˆ¤æ–­è¯·æ±‚ç±»å‹
if info, ok := http.FromServerContext(ctx); ok {
    // HTTP
    component = &quot;HTTP&quot;
    // å–å‡ºè¯·æ±‚çš„åœ°å€
    operation = info.Request.RequestURI
    // è°ƒç”¨ otel/propagationåŒ…ä¸­çš„ HeaderCarrierï¼Œä¼šå¤„ç† http.Header ä»¥ç”¨æ¥æ»¡è¶³TextMapCarrier interface
    // TextMapCarrier æ˜¯ä¸€ä¸ªæ–‡æœ¬æ˜ å°„è½½ä½“ï¼Œç”¨äºæ‰¿è½½ä¿¡æ¯
    carrier = propagation.HeaderCarrier(info.Request.Header)
    // otel.GetTextMapPropagator().Extract() æ–¹æ³•ç”¨äºå°†æ–‡æœ¬æ˜ å°„è½½ä½“ï¼Œè¯»å–åˆ°ä¸Šä¸‹æ–‡ä¸­
    ctx = otel.GetTextMapPropagator().Extract(ctx, propagation.HeaderCarrier(info.Request.Header))
} else if info, ok := grpc.FromServerContext(ctx); ok {
    // Grpc
    component = &quot;gRPC&quot;
    operation = info.FullMethod
    //
    // è°ƒç”¨ grpc/metadataåŒ…ä¸­metadata.FromIncomingContext(ctx)ä¼ å…¥ ctxï¼Œè½¬æ¢ grpc çš„å…ƒæ•°æ®
    if md, ok := metadata.FromIncomingContext(ctx); ok {
        // è°ƒç”¨carrier.go ä¸­çš„ MetadataCarrier å°† MD è½¬æ¢ æˆæ–‡æœ¬æ˜ å°„è½½ä½“
        carrier = MetadataCarrier(md)
    }
}
// è°ƒç”¨ tracer.Start æ–¹æ³•
ctx, span := tracer.Start(ctx, component, operation, carrier)
// ... çœç•¥ä»£ç 
}
</code></pre><ol start="4"><li>è°ƒç”¨ <strong>tracing.go</strong> ä¸­çš„ <strong>Start</strong> æ–¹æ³•</li></ol><pre><code class="language-go">func (t *Tracer) Start(ctx context.Context, component string, operation string, carrier propagation.TextMapCarrier) (context.Context, trace.Span) {
    // åˆ¤æ–­å½“å‰ä¸­é—´ä»¶å¦‚æœæ˜¯ serveråˆ™å°† carrier æ³¨å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­
    if t.kind == trace.SpanKindServer {
        ctx = otel.GetTextMapPropagator().Extract(ctx, carrier)
    }
    // è°ƒç”¨otel/tracer åŒ…ä¸­çš„ start æ–¹æ³•ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ª span
    ctx, span := t.tracer.Start(ctx,
        // tracing.go ä¸­å£°æ˜çš„è¯·æ±‚è·¯ç”±ä½œä¸º spanName
        operation,
        // è®¾ç½® span çš„å±æ€§ï¼Œè®¾ç½®äº†ä¸€ä¸ª componentï¼Œcomponentçš„å€¼ä¸ºè¯·æ±‚ç±»å‹
        trace.WithAttributes(attribute.String(&quot;component&quot;, component)),
        // è®¾ç½® spanç§ç±»
        trace.WithSpanKind(t.kind),
    )
    // åˆ¤æ–­å¦‚æœå½“å‰ä¸­é—´ä»¶æ˜¯ client åˆ™å°† carrier æ³¨å…¥åˆ°è¯·æ±‚é‡Œé¢
    if t.kind == trace.SpanKindClient {
        otel.GetTextMapPropagator().Inject(ctx, carrier)
    }
    return ctx, span
}
</code></pre><ol start="5"><li><strong>defer</strong> å£°æ˜äº†ä¸€ä¸ªé—­åŒ…æ–¹æ³•</li></ol><pre><code class="language-golang">// è¿™ä¸ªåœ°æ–¹è¦æ³¨æ„ï¼Œéœ€è¦ä½¿ç”¨é—­åŒ…ï¼Œå› ä¸º defer çš„å‚æ•°æ˜¯å®æ—¶è®¡ç®—çš„å¦‚æœå¼‚å¸¸å‘ç”Ÿï¼Œerr ä¼šä¸€ç›´ä¸º nil
// https://github.com/go-kratos/kratos/issues/927
defer func() { tracer.End(ctx, span, err) }()
</code></pre><ol start="6"><li>ä¸­é—´ä»¶ç»§ç»­æ‰§è¡Œ</li></ol><pre><code class="language-go">// tracing.go 69è¡Œ
reply, err = handler(ctx, req)
</code></pre><ol start="7"><li>ä¸­é—´ä»¶è°ƒç”¨ç»“æŸ <strong>defer</strong> ä¸­çš„é—­åŒ…è¢«è°ƒç”¨åæ‰§è¡Œäº† <strong>tracer.go</strong> ä¸­çš„ <strong>End</strong> æ–¹æ³•</li></ol><pre><code class="language-go">func (t *Tracer) End(ctx context.Context, span trace.Span, err error) {
    // åˆ¤æ–­æ˜¯å¦æœ‰å¼‚å¸¸å‘ç”Ÿï¼Œå¦‚æœæœ‰åˆ™è®¾ç½®ä¸€äº›å¼‚å¸¸ä¿¡æ¯
    if err != nil {
        // è®°å½•å¼‚å¸¸
        span.RecordError(err)
        // è®¾ç½®span å±æ€§
        span.SetAttributes(
            // è®¾ç½®äº‹ä»¶ä¸ºå¼‚å¸¸
            attribute.String(&quot;event&quot;, &quot;error&quot;),
            // è®¾ç½® message ä¸º err.Error().
            attribute.String(&quot;message&quot;, err.Error()),
        )
        //è®¾ç½®äº† span çš„çŠ¶æ€
        span.SetStatus(codes.Error, err.Error())
    } else {
        // å¦‚æœæ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼Œspan çŠ¶æ€åˆ™ä¸º ok
        span.SetStatus(codes.Ok, &quot;OK&quot;)
    }
    // ä¸­æ­¢ span
    span.End()
}
</code></pre><h4>å¦‚ä½•ä½¿ç”¨</h4><p>tracing ä¸­é—´ä»¶çš„ä½¿ç”¨ç¤ºä¾‹å¯ä»¥ä»  <a href="https://github.com/go-kratos/kratos/tree/main/examples/traces">kratos/examples/traces</a> ,è¯¥ç¤ºä¾‹ç®€å•çš„å®ç°äº†è·¨æœåŠ¡é—´çš„é“¾è·¯è¿½è¸ª,ä»¥ä¸‹ä»£ç ç‰‡æ®µåŒ…å«éƒ¨åˆ†ç¤ºä¾‹ä»£ç ã€‚</p><pre><code class="language-go">// https://github.com/go-kratos/kratos/blob/7f835db398c9d0332e69b81bad4c652b4b45ae2e/examples/traces/app/message/main.go#L38
// é¦–å…ˆè°ƒç”¨otel åº“æ–¹æ³•ï¼Œå¾—åˆ°ä¸€ä¸ª TracerProvider
func tracerProvider(url string) (*tracesdk.TracerProvider, error) {
    // examples/traces ä¸­ä½¿ç”¨çš„æ˜¯ jaegerï¼Œå…¶ä»–æ–¹å¼å¯ä»¥æŸ¥çœ‹ opentelemetry å®˜æ–¹ç¤ºä¾‹
    exp, err := jaeger.NewRawExporter(jaeger.WithCollectorEndpoint(jaeger.WithEndpoint(url)))
    if err != nil {
        return nil, err
    }
    tp := tracesdk.NewTracerProvider(
        tracesdk.WithSampler(tracesdk.AlwaysSample()),
        // è®¾ç½® Batcherï¼Œæ³¨å†Œjaegerå¯¼å‡ºç¨‹åº
        tracesdk.WithBatcher(exp),
        // è®°å½•ä¸€äº›é»˜è®¤ä¿¡æ¯
        tracesdk.WithResource(resource.NewWithAttributes(
            semconv.ServiceNameKey.String(pb.User_ServiceDesc.ServiceName),
            attribute.String(&quot;environment&quot;, &quot;development&quot;),
            attribute.Int64(&quot;ID&quot;, 1),
        )),
    )
    return tp, nil
}
</code></pre><h4>åœ¨ grpc/server ä¸­ä½¿ç”¨</h4><pre><code class="language-go">// https://github.com/go-kratos/kratos/blob/main/examples/traces/app/message/main.go
grpcSrv := grpc.NewServer(
    grpc.Address(&quot;:9000&quot;),
    grpc.Middleware(
        // Configuring tracing Middleware
        tracing.Server(
            tracing.WithTracerProvider(tp),
        ),
    ),
)
</code></pre><h4>åœ¨ grpc/client ä¸­ä½¿ç”¨</h4><pre><code class="language-go">// https://github.com/go-kratos/kratos/blob/149fc0195eb62ee1fbc2728adb92e1bcd1a12c4e/examples/traces/app/user/main.go#L63
conn, err := grpc.DialInsecure(ctx,
    grpc.WithEndpoint(&quot;127.0.0.1:9000&quot;),
    grpc.WithMiddleware(
        tracing.Client(
            tracing.WithTracerProvider(s.tracer),
            tracing.WithPropagators(
                propagation.NewCompositeTextMapPropagator(propagation.Baggage{}, propagation.TraceContext{}),
            ),
        )
    ),
    grpc.WithTimeout(2*time.Second),
)
</code></pre><h4>åœ¨ http/server ä¸­ä½¿ç”¨</h4><pre><code class="language-go">// https://github.com/go-kratos/kratos/blob/main/examples/traces/app/user/main.go
httpSrv := http.NewServer(http.Address(&quot;:8000&quot;))
httpSrv.HandlePrefix(&quot;/&quot;, pb.NewUserHandler(s,
    http.Middleware(
        // Configuring tracing middleware
        tracing.Server(
            tracing.WithTracerProvider(tp),
            tracing.WithPropagators(
                propagation.NewCompositeTextMapPropagator(propagation.Baggage{}, propagation.TraceContext{}),
            ),
        ),
    ),
)
</code></pre><h4>åœ¨ http/client ä¸­ä½¿ç”¨</h4><pre><code class="language-go">http.NewClient(ctx, http.WithMiddleware(
    tracing.Client(
        tracing.WithTracerProvider(s.tracer),
    ),
))
</code></pre><h4>å¦‚ä½•å®ç°ä¸€ä¸ªå…¶ä»–åœºæ™¯çš„ tracing</h4><p>æˆ‘ä»¬å¯ä»¥å€Ÿé‰´ <strong>kratos</strong> çš„ <strong>tracing</strong> ä¸­é—´ä»¶çš„ä»£ç æ¥å®ç°ä¾‹å¦‚æ•°æ®åº“çš„ <strong>tracing</strong>ï¼Œå¦‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µï¼Œä½œè€…å€Ÿé‰´äº†<strong>tracing</strong> ä¸­é—´ä»¶ï¼Œå®ç°äº† <strong>qmgo</strong> åº“æ“ä½œ <strong>MongoDB</strong> æ•°æ®åº“çš„ <strong>tracing</strong>ã€‚</p><pre><code class="language-go">func mongoTracer(ctx context.Context,tp trace.TracerProvider, command interface{}) {
    var (
        commandName string
        failure     string
        nanos       int64
        reply       bson.Raw
        queryId     int64
        eventName   string
    )
    otel.SetTracerProvider(tp)
    reply = bson.Raw{}
    switch value := command.(type) {
    case *event.CommandStartedEvent:
        commandName = value.CommandName
        reply = value.Command
        queryId = value.RequestID
        eventName = &quot;CommandStartedEvent&quot;
    case *event.CommandSucceededEvent:
        commandName = value.CommandName
        nanos = value.DurationNanos
        queryId = value.RequestID
        eventName = &quot;CommandSucceededEvent&quot;
    case *event.CommandFailedEvent:
        commandName = value.CommandName
        failure = value.Failure
        nanos = value.DurationNanos
        queryId = value.RequestID
        eventName = &quot;CommandFailedEvent&quot;
    }
    duration, _ := time.ParseDuration(strconv.FormatInt(nanos, 10) + &quot;ns&quot;)
    tracer := otel.Tracer(&quot;mongodb&quot;)
    kind := trace.SpanKindServer
    ctx, span := tracer.Start(ctx,
        commandName,
        trace.WithAttributes(
            attribute.String(&quot;event&quot;, eventName),
            attribute.String(&quot;command&quot;, commandName),
            attribute.String(&quot;query&quot;, reply.String()),
            attribute.Int64(&quot;queryId&quot;, queryId),
            attribute.String(&quot;ms&quot;, duration.String()),
        ),
        trace.WithSpanKind(kind),
    )
    if failure != &quot;&quot; {
        span.RecordError(errors.New(failure))
    }
    span.End()
}
</code></pre><h2>å‚è€ƒæ–‡çŒ®</h2><ul><li><a href="https://www.researchgate.net/publication/239595848_Dapper_a_Large-Scale_Distributed_Systems_Tracing_Infrastructure">è°·æ­Œè®ºæ–‡ã€ŠDapper, a Large-Scale Distributed Systems Tracing Infrastructureã€‹</a></li><li><a href="https://opentelemetry.io/">OpenTelemetry å®˜ç½‘</a></li><li><a href="https://static.sched.com/hosted_files/kccncosschn19chi/03/OpenTelemetry_%20Overview%20%26%20Backwards%20Compatibility%20of%20OpenTracing%20%2B%20OpenCensus%20-%20Steve%20Flanders%2C%20Omnition.pdf">KubeCon2019 OpenTelemetryåˆ†äº«</a></li><li><a href="https://go-kratos.dev/docs/getting-started/start">Kratos æ¡†æ¶</a></li><li><a href="https://github.com/go-kratos/kratos/tree/main/examples/traces">traces ç¤ºä¾‹</a></li></ul>]]></content>
        <author>
            <name>shenqidebaozi</name>
            <uri>https://github.com/shenqidebaozi</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kratos å­¦ä¹ ç¬”è®° - é€šè¿‡ layout ç®€å•åˆ†æåº”ç”¨æ˜¯å¦‚ä½•è·‘èµ·æ¥çš„]]></title>
        <id>go-layout-operation-process</id>
        <link href="https://go-kratos.dev/en/blog/go-layout-operation-process"/>
        <updated>2021-06-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[é€šè¿‡ layout ç®€å•åˆ†æåº”ç”¨æ˜¯å¦‚ä½•è·‘èµ·æ¥çš„]]></summary>
        <content type="html"><![CDATA[<h2>0X01 é€šè¿‡ layout æ¢ç´¢ kratos è¿è¡ŒåŸç†ï¼ˆkratos v2.0.0-beta4ï¼‰</h2><h3>åˆ›å»ºé¡¹ç›®</h3><p>é¦–å…ˆéœ€è¦å®‰è£…å¥½å¯¹åº”çš„ä¾èµ–ç¯å¢ƒï¼Œä»¥åŠå·¥å…·ï¼š</p><ul><li>go</li><li>protoc</li><li>protoc-gen-go</li></ul><pre><code class="language-bash">  # åˆ›å»ºé¡¹ç›®æ¨¡æ¿
kratos new helloworld

cd helloworld
# æ‹‰å–é¡¹ç›®ä¾èµ–
go mod download
# ç”Ÿæˆprotoæ¨¡æ¿
kratos proto add api/helloworld/helloworld.proto
# ç”Ÿæˆprotoæºç 
kratos proto client api/helloworld/helloworld.proto
# ç”Ÿæˆserveræ¨¡æ¿
kratos proto server api/helloworld/helloworld.proto -t internal/service
</code></pre><p>æ‰§è¡Œå‘½ä»¤å,ä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª service å·¥ç¨‹,å·¥ç¨‹éª¨æ¶å¦‚ä¸‹,å…·ä½“çš„å·¥ç¨‹éª¨æ¶è¯´æ˜å¯ä»¥è®¿é—® <a href="https://go-kratos.dev/docs/intro/layout">layout</a>
<img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2919854308c04803bef327b4f67f31f8~tplv-k3u1fbpfcp-watermark.image" alt="image.png"/></p><h3>è¿è¡Œé¡¹ç›®</h3><pre><code class="language-bash"># ç”Ÿæˆæ‰€æœ‰protoæºç ã€wireç­‰ç­‰
go generate ./...

# ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶
go build -o ./bin/ ./...

# è¿è¡Œé¡¹ç›®
./bin/helloworld -conf ./configs
</code></pre><p>çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºåˆ™è¯æ˜é¡¹ç›®å¯åŠ¨æ­£å¸¸</p><pre><code class="language-shell">level=INFO module=app service_id=7114ad8a-b3bf-11eb-a1b9-f0189850d2cb service_name=  version=
level=INFO module=transport/grpc msg=[gRPC] server listening on: [::]:9000
level=INFO module=transport/http msg=[HTTP] server listening on: [::]:8000 
</code></pre><p>æµ‹è¯•æ¥å£</p><pre><code class="language-shell">curl &#x27;http://127.0.0.1:8000/helloworld/krtaos&#x27;

è¾“å‡ºï¼š
{
  &quot;message&quot;: &quot;Hello kratos&quot;
}
</code></pre><h3>åº”ç”¨æ˜¯å¦‚ä½•è·‘èµ·æ¥çš„?</h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f714f793562459ea2a136aa4399494d~tplv-k3u1fbpfcp-watermark.image" alt="image.png"/>
é€šè¿‡ä¸Šé¢çš„å›¾ä¾‹ğŸ‘†,æˆ‘ä»¬å¯ä»¥ç›´è§‚è§‚å¯Ÿåˆ°åº”ç”¨çš„è°ƒç”¨é“¾,ç®€åŒ–æ¥è¯´å¦‚ä¸‹å›¾æµç¨‹æ‰€ç¤ºğŸ‘‡</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87d64f1a4f0e41afbb49bed6e003999c~tplv-k3u1fbpfcp-watermark.image" alt="æœªå‘½åæ–‡ä»¶(2).png"/></p><h4>1. æ³¨å…¥ä¾èµ–å¹¶è°ƒç”¨ newApp() æ–¹æ³•</h4><pre><code class="language-go">// helloword/cmd/main.go
func main() {
    flag.Parse()
    logger := log.NewStdLogger(os.Stdout)

    // è°ƒç”¨ go-kratos/kratos/v2/config,åˆ›å»º config å®ä¾‹,å¹¶æŒ‡å®šäº†æ¥æºå’Œé…ç½®è§£ææ–¹æ³•
    c := config.New(
    config.WithSource(
        file.NewSource(flagconf),
    ),
    config.WithDecoder(func(kv *config.KeyValue, v map[string]interface{}) error {
        return yaml.Unmarshal(kv.Value, v)
    }),
    )
    if err := c.Load(); err != nil {
        panic(err)
    }

    // å°†é…ç½®æ‰«æåˆ°,é€šè¿‡ proto å£°æ˜çš„ conf struct ä¸Š
    var bc conf.Bootstrap
    if err := c.Scan(&amp;bc); err != nil {
        panic(err)
    }

    // é€šè¿‡ wire å°†ä¾èµ–æ³¨å…¥,å¹¶è°ƒç”¨ newApp æ–¹æ³•
    app, cleanup, err := initApp(bc.Server, bc.Data, logger)
    if err != nil {
        panic(err)
    }
    // çœç•¥ä»£ç ...
}
</code></pre><h4>2. åˆ›å»º kratos å®ä¾‹</h4><p>é¡¹ç›® main.go çš„ <strong>newApp()</strong> æ–¹æ³•ä¸­,è°ƒç”¨äº† <strong>go-kratos/kratos/v2/app.go</strong> ä¸­çš„ <strong>kratos.New()</strong> æ–¹æ³•</p><pre><code class="language-go">// helloword/cmd/main.go
func newApp(logger log.Logger, hs *http.Server, gs *grpc.Server) *kratos.App {
    return kratos.New(
        // é…ç½®åº”ç”¨   
        kratos.Name(Name),
        kratos.Version(Version),
        kratos.Metadata(map[string]string{}),
        kratos.Logger(logger),
        // kratos.Server() ä¼ å…¥çš„ http/grpc æœåŠ¡ä¼šé€šè¿‡ buildInstance() è½¬æ¢æˆregistry.ServiceInstance struct*
        kratos.Server(
            hs,
            gs,
        ),
    )
}
</code></pre><p>è¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª <strong>App struct</strong>,åŒ…å« <strong>Run()</strong> å’Œ <strong>Stop()</strong> æ–¹æ³•</p><pre><code class="language-go">// go-kratos/kratos/v2/app.go
type App struct {
    opts     options //é…ç½®
    ctx      context.Context // ä¸Šä¸‹æ–‡
    cancel   func() // context çš„å–æ¶ˆæ–¹æ³•
    instance *registry.ServiceInstance //é€šè¿‡ kratos.Server()å£°æ˜çš„å®ä¾‹,å¹¶é€šè¿‡ buildInstance() è½¬æ¢åçš„ *registry.ServiceInstance struct
    log      *log.Helper // æ—¥å¿—
}

// Run executes all OnStart hooks registered with the application&#x27;s Lifecycle.
func (a *App) Run() error {
    // çœç•¥ä»£ç ...
}

// Stop gracefully stops the application.
func (a *App) Stop() error {
    // çœç•¥ä»£ç ...
}
</code></pre><h4>3. è°ƒç”¨ Run() æ–¹æ³•</h4><p>é¡¹ç›®åœ¨ main æ–¹æ³•ä¸­è°ƒç”¨äº† <strong>kratos.App struct</strong> çš„ <strong>Run()</strong> æ–¹æ³•.</p><pre><code class="language-go">// helloword/cmd/main.go
// çœç•¥ä»£ç ...
// å¯åŠ¨ Kratos
if err := app.Run(); err != nil {
    panic(err)
}
</code></pre><p><strong>Run()</strong> æ–¹æ³•çš„å®ç°ç»†èŠ‚</p><pre><code class="language-go">// go-kratos/kratos/v2/app.go
func (a *App) Run() error {
    a.log.Infow(
        &quot;service_id&quot;, a.opts.id,
        &quot;service_name&quot;, a.opts.name,
        &quot;version&quot;, a.opts.version,
    )
    g, ctx := errgroup.WithContext(a.ctx)
        // éå†é€šè¿‡ kratos.Server() å£°æ˜çš„æœåŠ¡å®ä¾‹
    for _, srv := range a.opts.servers {
        srv := srv
                // æ‰§è¡Œä¸¤ä¸ªgoroutine, ç”¨äºå¤„ç†æœåŠ¡å¯åŠ¨å’Œé€€å‡º
        g.Go(func() error {
            &lt;-ctx.Done() // é˜»å¡,ç­‰å¾…è°ƒç”¨ cancel æ–¹æ³•
            return srv.Stop() // åç¨‹é€€å‡ºå,è°ƒç”¨å®ä¾‹çš„åœæ­¢æ–¹æ³•
        })
        g.Go(func() error {
            return srv.Start() // è°ƒç”¨å®ä¾‹çš„è¿è¡Œæ–¹æ³•
        })
    }
        // åˆ¤æ–­æ˜¯å¦è°ƒç”¨ kratos.Registrar() é…ç½®äº†æ³¨å†Œå‘ç°ä¸­å¿ƒ
    if a.opts.registrar != nil {
        // å°†å®ä¾‹æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ
        if err := a.opts.registrar.Register(a.opts.ctx, a.instance); err != nil 
            return err
        }
    }
        // ç›‘å¬è¿›ç¨‹é€€å‡ºä¿¡å·
    c := make(chan os.Signal, 1)
    signal.Notify(c, a.opts.sigs...)
        
        // å¤„ç†è¿›ç¨‹é€€å‡ºå’Œ context é€€å‡º
    g.Go(func() error {
        for {
            select {
            case &lt;-ctx.Done():
                return ctx.Err()
            case &lt;-c:
                        // è°ƒç”¨ kratos.App çš„åœæ­¢æ–¹æ³•
                a.Stop()
            }
        }
    })
    if err := g.Wait(); err != nil &amp;&amp; !errors.Is(err, context.Canceled) {
        return err
    }
    return nil
}
</code></pre><h4>4. åº”ç”¨é€€å‡º</h4><p>Kratos å®ä¾‹åœ¨å¯åŠ¨æ—¶,ç›‘å¬äº†ç³»ç»Ÿçš„è¿›ç¨‹é€€å‡ºä¿¡å·,å½“æ”¶åˆ°é€€å‡ºä¿¡å·æ—¶,kratos ä¼šè°ƒç”¨ <strong>App struct</strong> çš„ <strong>Stop()</strong> æ–¹æ³•</p><pre><code class="language-go">// go-kratos/kratos/v2/app.go
func (a *App) Stop() error {
    // åˆ¤æ–­æ˜¯å¦æœ‰æ³¨å†Œä¸­å¿ƒé…ç½®
    if a.opts.registrar != nil {
        // åœ¨æ³¨å†Œä¸­å¿ƒä¸­å°†å®ä¾‹æ³¨é”€
        if err := a.opts.registrar.Deregister(a.opts.ctx, a.instance); err != nil {
            return err
        }
    }
    // æ§åˆ¶ goroutine çš„é€€å‡º,å½“è°ƒç”¨ a.cancel()æ—¶,Run()æ–¹æ³•ä¸­ ç›‘å¬çš„ &lt;-ctx.Done() æ”¶åˆ°æ¶ˆæ¯å,æ²¡æœ‰é˜»å¡å,æ–¹æ³•ä¼šè°ƒç”¨ server çš„ Stop()æ–¹æ³•,åœæ­¢æœåŠ¡
    if a.cancel != nil {
        a.cancel()
    }
    return nil
}
</code></pre>]]></content>
        <author>
            <name>shenqidebaozi</name>
            <uri>https://github.com/shenqidebaozi</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Goå·¥ç¨‹åŒ– - Project Layout æœ€ä½³å®è·µ]]></title>
        <id>go-project-layout</id>
        <link href="https://go-kratos.dev/en/blog/go-project-layout"/>
        <updated>2021-03-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Go é¡¹ç›®å·¥ç¨‹åŒ–/åŸºç¡€åº“ï¼Œåœ¨é¡¹ç›®ä¸åŒè§’åº¦ä¸­çš„è®¾è®¡ç†å¿µï¼ŒGo æ˜¯ä¸€ä¸ªé¢å‘åŒ…åè®¾è®¡çš„è¯­è¨€ï¼Œå¯ä»¥é€šè¿‡å„ä¸ªåŒ…åè¿›è¡Œç»„ç»‡ Go çš„é¡¹ç›®å¸ƒå±€]]></summary>
        <content type="html"><![CDATA[<h2>ä»‹ç»</h2><p>è¿™ç¯‡æ–‡ç« ä¸»è¦è®² <strong>Go é¡¹ç›®å·¥ç¨‹åŒ–</strong> ä¸Šçš„ä¸€äº›æ€è€ƒï¼Œä»¥åŠ <strong>Kratos</strong> åœ¨é¡¹ç›®ä¸åŒè§’åº¦ä¸­çš„è®¾è®¡ç†å¿µã€‚</p><p>Go æ˜¯ä¸€ä¸ªé¢å‘åŒ…åè®¾è®¡çš„è¯­è¨€ï¼Œå¯ä»¥é€šè¿‡å„ä¸ªåŒ…åè¿›è¡Œç»„ç»‡ Go çš„é¡¹ç›®å¸ƒå±€ï¼Œè€Œå¤§å®¶éµå¾ªè§„èŒƒè®¾è®¡å‡†åˆ™ï¼Œå¯ä»¥å¾ˆå¥½åœ°æ”¹å–„å›¢é˜Ÿæˆå‘˜ä¹‹é—´çš„æ²Ÿé€šã€‚</p><h2>é¡¹ç›®å¸ƒå±€</h2><p>æ¯ä¸ªå…¬å¸éƒ½åº”å½“ä¸ºä¸åŒçš„å¾®æœåŠ¡å»ºç«‹ä¸€ä¸ªç»Ÿä¸€çš„ Kit å·¥å…·åŒ…é¡¹ç›®ï¼ˆåŸºç¡€åº“/æ¡†æ¶ï¼‰å’Œ Application é¡¹ç›®ã€‚
åŸºç¡€åº“ Kit ä¸ºç‹¬ç«‹é¡¹ç›®ï¼Œå…¬å¸çº§å»ºè®®åªæœ‰ä¸€ä¸ªï¼ŒæŒ‰ç…§åŠŸèƒ½ç›®å½•æ¥æ‹†åˆ†ä¼šå¸¦æ¥ä¸å°‘çš„ç®¡ç†å·¥ä½œï¼Œå› æ­¤å»ºè®®åˆå¹¶æ•´åˆã€‚</p><blockquote><p>by Package Oriented Design
â€œTo this end, the Kit project is not allowed to have a vendor folder. If any of packages are dependent on 3rd party packages, they must always build against the latest version of those dependences.â€</p></blockquote><h3>Kit åŸºç¡€åº“</h3><p>å°† Kit é¡¹ç›®ä½œä¸ºå…¬å¸çš„æ ‡å‡†åº“ï¼Œå› æ­¤åº”è¯¥åªæœ‰ä¸€ä¸ªã€‚å¹¶ä¸” Kit åŸºç¡€åº“ä¹Ÿåº”è¯¥å…·å¤‡ä»¥ä¸‹è¿™äº›ç‰¹ç‚¹ï¼š</p><ul><li>ç®€å•ï¼šä¸è¿‡åº¦è®¾è®¡ï¼Œä»£ç å¹³å®ç®€å•ï¼›</li><li>é€šç”¨ï¼šé€šç”¨ä¸šåŠ¡å¼€å‘æ‰€éœ€è¦çš„åŸºç¡€åº“çš„åŠŸèƒ½ï¼›</li><li>é«˜æ•ˆï¼šæé«˜ä¸šåŠ¡è¿­ä»£çš„æ•ˆç‡ï¼›</li><li>ç¨³å®šï¼šåŸºç¡€åº“å¯æµ‹è¯•æ€§é«˜ï¼Œè¦†ç›–ç‡é«˜ï¼Œæœ‰çº¿ä¸Šå®è·µå®‰å…¨å¯é ï¼›</li><li>å¥å£®ï¼šé€šè¿‡è‰¯å¥½çš„åŸºç¡€åº“è®¾è®¡ï¼Œå‡å°‘é”™ç”¨ï¼›</li><li>é«˜æ€§èƒ½ï¼šæ€§èƒ½é«˜ï¼Œä½†ä¸ç‰¹å®šä¸ºäº†æ€§èƒ½åš hack ä¼˜åŒ–ï¼Œå¼•å…¥ unsafe ï¼›</li><li>æ‰©å±•æ€§ï¼šè‰¯å¥½çš„æ¥å£è®¾è®¡ï¼Œæ¥æ‰©å±•å®ç°ï¼Œæˆ–è€…é€šè¿‡æ–°å¢åŸºç¡€åº“ç›®å½•æ¥æ‰©å±•åŠŸèƒ½ï¼›</li><li>å®¹é”™æ€§ï¼šä¸ºå¤±è´¥è®¾è®¡ï¼Œå¤§é‡å¼•å…¥å¯¹ SRE çš„ç†è§£ï¼Œé²æ£’æ€§é«˜ï¼›</li><li>å·¥å…·é“¾ï¼šåŒ…å«å¤§é‡å·¥å…·é“¾ï¼Œæ¯”å¦‚è¾…åŠ©ä»£ç ç”Ÿæˆï¼Œlint å·¥å…·ç­‰ç­‰ï¼›</li></ul><p>ä»¥ Kratos ä¸ºä¾‹å­ï¼Œä¸€ä¸ªå…¸å‹çš„ Kit åŸºç¡€åº“ å¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p><pre><code>github.com/go-kratos/kratos
â”œâ”€â”€ cmd
â”œâ”€â”€ docs
â”œâ”€â”€ internal
â”œâ”€â”€ examples
â”œâ”€â”€ api
â”œâ”€â”€ errors
â”œâ”€â”€ config
â”œâ”€â”€ encoding
â”œâ”€â”€ log
â”œâ”€â”€ metrics
â”œâ”€â”€ metadata
â”œâ”€â”€ middleware
â”œâ”€â”€ transport
â”œâ”€â”€ registry
â”œâ”€â”€ third_party
â”œâ”€â”€ app.go
â”œâ”€â”€ options.go
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
</code></pre><blockquote><p>æ³¨æ„ï¼šä¸ºäº†ä¿è¯ Kit åŸºç¡€åº“çš„å¯ç§»æ¤æ€§ï¼Œå°½å¯èƒ½è¿›è¡Œæ¥å£æŠ½è±¡ï¼Œå¹¶ä¸” go.mod ä¾èµ–ç¬¬ä¸‰æ–¹åº“ä¹Ÿå°½å¯èƒ½ç®€å•ï¼Œç„¶åå†é€šè¿‡ plugins è¿›è¡Œæ‰©å±•åŸºç¡€åº“ï¼Œä»¥æ»¡è¶³ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚å®šåˆ¶åŒ–ã€‚</p></blockquote><h3>Application åº”ç”¨é¡¹ç›®</h3><p>å¦‚æœä½ å°è¯•å­¦ä¹  Goï¼Œæˆ–è€…ä½ æ­£åœ¨ä¸ºè‡ªå·±å»ºç«‹ä¸€ä¸ª PoC æˆ–ä¸€ä¸ªç©å…·é¡¹ç›®ï¼Œè¿™ä¸ªé¡¹ç›®å¸ƒå±€æ˜¯æ²¡å•¥å¿…è¦çš„ã€‚ä»ä¸€äº›éå¸¸ç®€å•çš„äº‹æƒ…å¼€å§‹ï¼ˆä¸€ä¸ª main.go æ–‡ä»¶ç»°ç»°æœ‰ä½™ï¼‰ã€‚å½“æœ‰æ›´å¤šçš„äººå‚ä¸è¿™ä¸ªé¡¹ç›®æ—¶ï¼Œä½ å°†éœ€è¦æ›´å¤šçš„ç»“æ„ï¼ŒåŒ…æ‹¬éœ€è¦ä¸€ä¸ª Toolkit æ¥æ–¹ä¾¿ç”Ÿæˆé¡¹ç›®çš„æ¨¡æ¿ï¼Œå°½å¯èƒ½å¤§å®¶ç»Ÿä¸€çš„å·¥ç¨‹ç›®å½•å¸ƒå±€ã€‚</p><img src="/images/ddd.png" alt="kratos ddd" width="500px"/><p>ä¾‹å¦‚ï¼Œé€šè¿‡ Kratos å·¥å…·ç”Ÿæˆä¸€ä¸ª Goå·¥ç¨‹åŒ–é¡¹ç›® æ¨¡æ¿ï¼š</p><pre><code># åˆ›å»ºé¡¹ç›®æ¨¡æ¿
kratos new helloworld

cd helloworld
# æ‹‰å–é¡¹ç›®ä¾èµ–
go mod download
# ç”Ÿæˆprotoæ¨¡æ¿
kratos proto add api/helloworld/helloworld.proto
# ç”Ÿæˆclientæºç 
kratos proto client api/helloworld/helloworld.proto
# ç”Ÿæˆserveræ¨¡æ¿
kratos proto server api/helloworld/helloworld.proto -t internal/service
</code></pre><p>åœ¨ Kratos ä¸­ï¼Œä¸€ä¸ªå…¸å‹çš„ Go é¡¹ç›®å¸ƒå±€ å¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p><pre><code>application
|____api
| |____helloworld
| | |____v1
| | |____errors
|____cmd
| |____helloworld
|____configs
|____internal
| |____conf
| |____data
| |____biz
| |____service
| |____server
|____test
|____pkg
|____go.mod
|____go.sum
|____LICENSE
|____README.md
</code></pre><h3>åº”ç”¨ç±»å‹</h3><p>å¾®æœåŠ¡ä¸­çš„ app æœåŠ¡ç±»å‹ä¸»è¦åˆ†ä¸º4ç±»ï¼šinterfaceã€serviceã€jobã€adminï¼Œåº”ç”¨ cmd ç›®å½•è´Ÿè´£ç¨‹åºçš„ï¼šå¯åŠ¨ã€å…³é—­ã€é…ç½®åˆå§‹åŒ–ç­‰ã€‚</p><ul><li>interface: å¯¹å¤–çš„ BFF æœåŠ¡ï¼Œæ¥å—æ¥è‡ªç”¨æˆ·çš„è¯·æ±‚ï¼Œæ¯”å¦‚æš´éœ²äº† HTTP/gRPC æ¥å£ã€‚</li><li>service: å¯¹å†…çš„å¾®æœåŠ¡ï¼Œä»…æ¥å—æ¥è‡ªå†…éƒ¨å…¶ä»–æœåŠ¡æˆ–è€…ç½‘å…³çš„è¯·æ±‚ï¼Œæ¯”å¦‚æš´éœ²äº†gRPC æ¥å£åªå¯¹å†…æœåŠ¡ã€‚</li><li>adminï¼šåŒºåˆ«äº serviceï¼Œæ›´å¤šæ˜¯é¢å‘è¿è¥æµ‹çš„æœåŠ¡ï¼Œé€šå¸¸æ•°æ®æƒé™æ›´é«˜ï¼Œéš”ç¦»å¸¦æ¥æ›´å¥½çš„ä»£ç çº§åˆ«å®‰å…¨ã€‚</li><li>job: æµå¼ä»»åŠ¡å¤„ç†çš„æœåŠ¡ï¼Œä¸Šæ¸¸ä¸€èˆ¬ä¾èµ– message brokerã€‚</li><li>task: å®šæ—¶ä»»åŠ¡ï¼Œç±»ä¼¼ cronjobï¼Œéƒ¨ç½²åˆ° task æ‰˜ç®¡å¹³å°ä¸­ã€‚</li></ul><h2>åº”ç”¨ç›®å½•</h2><h3>/cmd</h3><p>æœ¬é¡¹ç›®çš„ä¸»å¹²ã€‚
æ¯ä¸ªåº”ç”¨ç¨‹åºçš„ç›®å½•ååº”è¯¥ä¸ä½ æƒ³è¦çš„å¯æ‰§è¡Œæ–‡ä»¶çš„åç§°ç›¸åŒ¹é…ï¼ˆä¾‹å¦‚ï¼Œ<code>/cmd/myapp</code>ï¼‰ã€‚
ä¸è¦åœ¨è¿™ä¸ªç›®å½•ä¸­æ”¾ç½®å¤ªå¤šä»£ç ã€‚å¦‚æœä½ è®¤ä¸ºä»£ç å¯ä»¥å¯¼å…¥å¹¶åœ¨å…¶ä»–é¡¹ç›®ä¸­ä½¿ç”¨ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥ä½äº <code>/pkg</code> ç›®å½•ä¸­ã€‚å¦‚æœä»£ç ä¸æ˜¯å¯é‡ç”¨çš„ï¼Œæˆ–è€…ä½ ä¸å¸Œæœ›å…¶ä»–äººé‡ç”¨å®ƒï¼Œè¯·å°†è¯¥ä»£ç æ”¾åˆ° <code>/internal</code> ç›®å½•ä¸­ã€‚</p><h3>/internal</h3><p>ç§æœ‰åº”ç”¨ç¨‹åºå’Œåº“ä»£ç ã€‚è¿™æ˜¯ä½ ä¸å¸Œæœ›å…¶ä»–äººåœ¨å…¶åº”ç”¨ç¨‹åºæˆ–åº“ä¸­å¯¼å…¥ä»£ç ã€‚è¯·æ³¨æ„ï¼Œè¿™ä¸ªå¸ƒå±€æ¨¡å¼æ˜¯ç”± Go ç¼–è¯‘å™¨æœ¬èº«æ‰§è¡Œçš„ã€‚æœ‰å…³æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚é˜… Go 1.4 release notesã€‚æ³¨æ„ï¼Œä½ å¹¶ä¸å±€é™äºé¡¶çº§ <code>internal</code> ç›®å½•ã€‚åœ¨é¡¹ç›®æ ‘çš„ä»»ä½•çº§åˆ«ä¸Šéƒ½å¯ä»¥æœ‰å¤šä¸ªå†…éƒ¨ç›®å½•ã€‚
ä½ å¯ä»¥é€‰æ‹©å‘ <code>internal</code> åŒ…ä¸­æ·»åŠ ä¸€äº›é¢å¤–çš„ç»“æ„ï¼Œä»¥åˆ†éš”å…±äº«å’Œéå…±äº«çš„å†…éƒ¨ä»£ç ã€‚è¿™ä¸æ˜¯å¿…éœ€çš„(ç‰¹åˆ«æ˜¯å¯¹äºè¾ƒå°çš„é¡¹ç›®)ï¼Œä½†æ˜¯æœ€å¥½æœ‰æœ‰å¯è§†åŒ–çš„çº¿ç´¢æ¥æ˜¾ç¤ºé¢„æœŸçš„åŒ…çš„ç”¨é€”ã€‚ä½ çš„å®é™…åº”ç”¨ç¨‹åºä»£ç å¯ä»¥æ”¾åœ¨ <code>/internal/app</code> ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ <code>/internal/app/myapp</code>ï¼‰ï¼Œè¿™äº›åº”ç”¨ç¨‹åºå…±äº«çš„ä»£ç å¯ä»¥æ”¾åœ¨ <code>/internal/pkg</code> ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ /internal/pkg/myprivlibï¼‰ã€‚
å› ä¸ºæˆ‘ä»¬ä¹ æƒ¯æŠŠç›¸å…³çš„æœåŠ¡ï¼Œæ¯”å¦‚è´¦å·æœåŠ¡ï¼Œå†…éƒ¨æœ‰ rpcã€jobã€admin ç­‰ï¼Œç›¸å…³çš„æœåŠ¡æ•´åˆä¸€èµ·åï¼Œéœ€è¦åŒºåˆ† appã€‚å•ä¸€çš„æœåŠ¡ï¼Œå¯ä»¥å»æ‰ <code>/internal/myapp</code>ã€‚</p><h3>/pkg</h3><p>å¤–éƒ¨åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨çš„åº“ä»£ç ï¼ˆä¾‹å¦‚ <code>/pkg/mypubliclib</code>ï¼‰ã€‚å…¶ä»–é¡¹ç›®ä¼šå¯¼å…¥è¿™äº›åº“ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæ”¾ä¸œè¥¿ä¹‹å‰è¦ä¸‰æ€:-)æ³¨æ„ï¼Œ<code>internal</code> ç›®å½•æ˜¯ç¡®ä¿ç§æœ‰åŒ…ä¸å¯å¯¼å…¥çš„æ›´å¥½æ–¹æ³•ï¼Œå› ä¸ºå®ƒæ˜¯ç”± Go å¼ºåˆ¶æ‰§è¡Œçš„ã€‚<code>/pkg</code> ç›®å½•ä»ç„¶æ˜¯ä¸€ç§å¾ˆå¥½çš„æ–¹å¼ï¼Œå¯ä»¥æ˜¾å¼åœ°è¡¨ç¤ºè¯¥ç›®å½•ä¸­çš„ä»£ç å¯¹äºå…¶ä»–äººæ¥è¯´æ˜¯å®‰å…¨ä½¿ç”¨çš„å¥½æ–¹æ³•ã€‚</p><blockquote><p>/pkg ç›®å½•å†…ï¼Œå¯ä»¥å‚è€ƒ go æ ‡å‡†åº“çš„ç»„ç»‡æ–¹å¼ï¼ŒæŒ‰ç…§åŠŸèƒ½åˆ†ç±»ã€‚/internla/pkg ä¸€èˆ¬ç”¨äºé¡¹ç›®å†…çš„ è·¨å¤šä¸ªåº”ç”¨çš„å…¬å…±å…±äº«ä»£ç ï¼Œä½†å…¶ä½œç”¨åŸŸä»…åœ¨å•ä¸ªé¡¹ç›®å·¥ç¨‹å†…ã€‚  </p></blockquote><p>ç”± Travis Jeffery  æ’°å†™çš„ I&#x27;ll take pkg over internal åšå®¢æ–‡ç« æä¾›äº† <code>pkg</code> å’Œ <code>internal</code> ç›®å½•çš„ä¸€ä¸ªå¾ˆå¥½çš„æ¦‚è¿°ï¼Œä»¥åŠä»€ä¹ˆæ—¶å€™ä½¿ç”¨å®ƒä»¬æ˜¯æœ‰æ„ä¹‰çš„ã€‚
å½“æ ¹ç›®å½•åŒ…å«å¤§é‡é Go ç»„ä»¶å’Œç›®å½•æ—¶ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§å°† Go ä»£ç åˆ†ç»„åˆ°ä¸€ä¸ªä½ç½®çš„æ–¹æ³•ï¼Œè¿™ä½¿å¾—è¿è¡Œå„ç§ Go å·¥å…·å˜å¾—æ›´åŠ å®¹æ˜“ç»„ç»‡ã€‚ </p><h2>æœåŠ¡åº”ç”¨ç›®å½•</h2><h3>/api</h3><p>â€‹    API åè®®å®šä¹‰ç›®å½•ï¼Œservices.proto protobuf æ–‡ä»¶ï¼Œä»¥åŠç”Ÿæˆçš„ go æ–‡ä»¶ã€‚æˆ‘ä»¬é€šå¸¸æŠŠ api æ–‡æ¡£ç›´æ¥åœ¨ proto æ–‡ä»¶ä¸­æè¿°ã€‚</p><h3>/configs</h3><p>â€‹    é…ç½®æ–‡ä»¶æ¨¡æ¿æˆ–é»˜è®¤é…ç½®ã€‚</p><h3>/test</h3><p>â€‹    é¢å¤–çš„å¤–éƒ¨æµ‹è¯•åº”ç”¨ç¨‹åºå’Œæµ‹è¯•æ•°æ®ã€‚ä½ å¯ä»¥éšæ—¶æ ¹æ®éœ€æ±‚æ„é€  /test ç›®å½•ã€‚å¯¹äºè¾ƒå¤§çš„é¡¹ç›®ï¼Œæœ‰ä¸€ä¸ªæ•°æ®å­ç›®å½•æ˜¯æœ‰æ„ä¹‰çš„ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ /test/data æˆ– /test/testdata (å¦‚æœä½ éœ€è¦å¿½ç•¥ç›®å½•ä¸­çš„å†…å®¹)ã€‚è¯·æ³¨æ„ï¼ŒGo è¿˜ä¼šå¿½ç•¥ä»¥ â€œ.â€ æˆ– â€œ_â€ å¼€å¤´çš„ç›®å½•æˆ–æ–‡ä»¶ï¼Œå› æ­¤åœ¨å¦‚ä½•å‘½åæµ‹è¯•æ•°æ®ç›®å½•æ–¹é¢æœ‰æ›´å¤§çš„çµæ´»æ€§ã€‚</p><h2>æœåŠ¡å†…éƒ¨ç›®å½•</h2><p>Application ç›®å½•ä¸‹æœ‰ apiã€cmdã€configsã€internalã€pkg ç›®å½•ï¼Œç›®å½•é‡Œä¸€èˆ¬è¿˜ä¼šæ”¾ç½® READMEã€CHANGELOGã€OWNERSã€‚</p><p>internal æ˜¯ä¸ºäº†é¿å…æœ‰åŒä¸šåŠ¡ä¸‹æœ‰äººè·¨ç›®å½•å¼•ç”¨äº†å†…éƒ¨çš„ dataã€bizã€serviceã€server ç­‰å†…éƒ¨ structã€‚</p><h3>data</h3><p>ä¸šåŠ¡æ•°æ®è®¿é—®ï¼ŒåŒ…å« cacheã€db ç­‰å°è£…ï¼Œå®ç°äº† biz çš„ repo æ¥å£ã€‚æˆ‘ä»¬å¯èƒ½ä¼šæŠŠ data ä¸ dao æ··æ·†åœ¨ä¸€èµ·ï¼Œdata åé‡ä¸šåŠ¡çš„å«ä¹‰ï¼Œå®ƒæ‰€è¦åšçš„æ˜¯å°†é¢†åŸŸå¯¹è±¡é‡æ–°æ‹¿å‡ºæ¥ï¼Œæˆ‘ä»¬å»æ‰äº† DDD çš„ infraå±‚ã€‚</p><h3>biz</h3><p>ä¸šåŠ¡é€»è¾‘çš„ç»„è£…å±‚ï¼Œç±»ä¼¼ DDD çš„ domain å±‚ï¼Œdata ç±»ä¼¼ DDD çš„ repoï¼Œrepo æ¥å£åœ¨è¿™é‡Œå®šä¹‰ï¼Œä½¿ç”¨ä¾èµ–å€’ç½®çš„åŸåˆ™ã€‚</p><h3>service</h3><p>å®ç°äº† api å®šä¹‰çš„æœåŠ¡å±‚ï¼Œç±»ä¼¼ DDD çš„ application å±‚ï¼Œå¤„ç† DTO åˆ° biz é¢†åŸŸå®ä½“çš„è½¬æ¢ï¼ˆDTO -&gt; DOï¼‰ï¼ŒåŒæ—¶ååŒå„ç±» biz äº¤äº’ï¼Œä½†æ˜¯ä¸åº”å¤„ç†å¤æ‚é€»è¾‘ã€‚</p><h3>server</h3><p>ä¸ºhttpå’Œgrpcå®ä¾‹çš„åˆ›å»ºå’Œé…ç½®ï¼Œä»¥åŠæ³¨å†Œå¯¹åº”çš„ service ã€‚</p><h2>ä¸å»ºè®®çš„ç›®å½•</h2><h3><del>src/</del></h3><p>  src ç›®å½•åœ¨ java å¼€å‘è¯­è¨€çš„é¡¹ç›®ä¸­æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ¨¡å¼ï¼Œä½†æ˜¯åœ¨ go å¼€å‘é¡¹ç›®ä¸­ï¼Œå°½é‡ä¸è¦ä½¿ç”¨ src ç›®å½•ã€‚</p><h3><del>model/</del></h3><p> åœ¨å…¶ä»–è¯­è¨€å¼€å‘ä¸­ä¸€ä¸ªéå¸¸é€šç”¨çš„æ¨¡å—å« modelï¼ŒæŠŠæ‰€æœ‰ç±»å‹éƒ½æ”¾åœ¨ model é‡Œã€‚ä½†æ˜¯åœ¨ go é‡Œä¸å»ºè®®çš„ï¼Œå› ä¸º go çš„åŒ…è®¾è®¡æ˜¯æ ¹æ®åŠŸèƒ½èŒè´£åˆ’åˆ†çš„ã€‚æ¯”å¦‚ä¸€ä¸ª User æ¨¡å‹ï¼Œåº”è¯¥å£°æ˜åœ¨ä»–è¢«ç”¨çš„åŠŸèƒ½æ¨¡å—é‡Œã€‚</p><h3><del>xxs/</del></h3><p>  å¸¦å¤æ•°çš„ç›®å½•æˆ–åŒ…ã€‚è™½ç„¶ go æºç ä¸­æœ‰ strings åŒ…ï¼Œä½†æ›´å¤šéƒ½æ˜¯ç”¨å•æ•°å½¢å¼ã€‚</p><h2>æ€»ç»“</h2><p>åœ¨å®é™… go é¡¹ç›®å¼€å‘ä¸­ï¼Œä¸€å®šè¦çµæ´»è¿ç”¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å®Œå…¨ä¸æŒ‰ç…§è¿™æ ·æ¶æ„åˆ†å±‚ã€åŒ…è®¾è®¡çš„è§„åˆ™ï¼Œä¸€åˆ‡ä»¥é¡¹ç›®çš„å¤§å°ã€ä¸šåŠ¡çš„å¤æ‚åº¦ã€ä¸ªäººä¸“ä¸šæŠ€èƒ½è®¤çŸ¥çš„å¹¿åº¦å’Œæ·±åº¦ã€æ—¶é—´çš„ç´§è¿«åº¦ä¸ºå‡†ã€‚</p><p>å¹¶ä¸”ï¼Œä¸€å®šè¦æŒ‰å®é™…æƒ…å†µï¼Œé€‰æ‹©åˆé€‚è‡ªå·±å›¢é˜Ÿçš„ Kit åŸºç¡€åº“ï¼Œè¿›è¡Œå……åˆ†çš„è°ƒç ”ä»¥åŠæ˜¯å¦å¯æ»¡è¶³æ’ä»¶å®šåˆ¶åŒ–ï¼Œéœ€è¦ç»´æŠ¤å¥½å±äºå›¢é˜Ÿçš„ Kit åŸºç¡€åº“ å’Œ ä»£ç è§„èŒƒ ï¼Œå¸¦åŠ¨å¼€å‘è€…è¿›è¡Œç§¯æå‚ä¸è´¡çŒ®ã€‚</p><p>å¦‚æœå¤§å®¶æœ‰æ›´å¥½çš„æ¶æ„è®¾è®¡ç†å¿µï¼Œæ¬¢è¿åˆ° go-kratos ç¤¾åŒºè¿›è¡Œæ¢è®¨ï¼Œå¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©~</p><h2>å‚è€ƒæ–‡çŒ®</h2><ul><li><a href="https://www.ardanlabs.com/blog/2017/02/package-oriented-design.html">Package Oriented Design</a></li><li><a href="https://docs.microsoft.com/en-us/previous-versions/msp-n-p/ee658109(v=pandp.10)">Layered Application Guidelines</a></li><li><a href="https://github.com/golang-standards/project-layout">Standard Go Project Layout</a></li><li><a href="https://github.com/danceyoung/paper-code/blob/master/package-oriented-design/packageorienteddesign.md">Go é¢å‘åŒ…çš„è®¾è®¡å’Œæ¶æ„åˆ†å±‚</a></li><li><a href="https://u.geekbang.org/subject/go">Go è¿›é˜¶è®­ç»ƒè¥ - æå®¢æ—¶é—´</a></li></ul>]]></content>
        <author>
            <name>Tony</name>
            <uri>https://github.com/tonybase</uri>
        </author>
    </entry>
</feed>